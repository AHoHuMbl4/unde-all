# UNDE ‚Äî –£–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ "–∑–Ω–∞–Ω–∏—è –æ —é–∑–µ—Ä–µ"

*–í–µ—Ä—Å–∏—è: 0.4.2 ‚Äî KSP Cross-Reference*
*–î–∞—Ç–∞: 2026-02-19*
*–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: cross-reference –Ω–∞ UNDE_Knowledge_Staging_Pipeline.md (KSP v1.7) ‚Äî implementation spec –¥–ª—è Knowledge Extraction –∏ ContextPack assembly*
*–ü—Ä–µ–¥—ã–¥—É—â–µ–µ: v0.4.1 ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Persona Agent (UNDE_Persona_Voice_Layer v0.7.0) –≤ pipeline*

---

## 1. –ó–∞–¥–∞—á–∞

### –ü—Ä–æ–±–ª–µ–º–∞

UNDE –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ "–Ω–µ–∑–∞–º–µ–Ω–∏–º—ã–π –±–ª–∏–∑–∫–∏–π –¥—Ä—É–≥", –∞ –Ω–µ —É—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–π —á–∞—Ç-–±–æ—Ç. –ë–ª–∏–∑–∫–∏–π –¥—Ä—É–≥ –∑–Ω–∞–µ—Ç –ø—Ä–æ —Ç–µ–±—è –í–°–Å ‚Äî –Ω–µ –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª –¥–æ—Å—å–µ, –∞ –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ–º–Ω–∏—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä—ã, –∑–∞–º–µ—á–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –ø–æ–ª—É—Å–ª–æ–≤–∞. –ò –µ—â—ë ‚Äî –æ–Ω –≤–∏–¥–∏—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–æ–∫—Ä—É–≥ —Ç–µ–±—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.

–ö–æ–≥–¥–∞ —é–∑–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç "—Ö–æ—á—É –ø–æ–π—Ç–∏ –≤ –∫–∏–Ω–æ —Å–µ–≥–æ–¥–Ω—è", UNDE –¥–æ–ª–∂–µ–Ω –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–æ–±—Ä–∞—Ç—å:

| –ß—Ç–æ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å | –û—Ç–∫—É–¥–∞ —ç—Ç–æ | –¢–∏–ø –∑–Ω–∞–Ω–∏—è |
|----------------|-----------|------------|
| –° –∫–µ–º —Ö–æ–¥–∏—Ç ‚Äî –ø–∞—Ä–µ–Ω—å –î–∏–º–∞ | –ß–∞—Ç, 3 –º–µ—Å –Ω–∞–∑–∞–¥ | –≠–ø–∏–∑–æ–¥ |
| –õ—é–±–∏—Ç —Ç—Ä–∏–ª–ª–µ—Ä—ã, –æ—Å–æ–±–µ–Ω–Ω–æ –∫–æ—Ä–µ–π—Å–∫–∏–µ | –ß–∞—Ç, 8 –º–µ—Å –Ω–∞–∑–∞–¥ | –≠–ø–∏–∑–æ–¥ |
| –í—á–µ—Ä–∞ –∂–∞–ª–æ–≤–∞–ª–∞—Å—å –Ω–∞ —É—Å—Ç–∞–ª–æ—Å—Ç—å | –ß–∞—Ç, –≤—á–µ—Ä–∞ | –≠–ø–∏–∑–æ–¥ |
| –î–∏–º–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –∫–æ–≥–¥–∞ –≤ —é–±–∫–∞—Ö | –ß–∞—Ç, 6 –º–µ—Å –Ω–∞–∑–∞–¥ | –≠–ø–∏–∑–æ–¥ |
| –°–µ–π—á–∞—Å —ç–∫–æ–Ω–æ–º–∏—Ç –Ω–∞ –æ—Ç–ø—É—Å–∫ | –ß–∞—Ç, 2 –Ω–µ–¥ –Ω–∞–∑–∞–¥ | –≠–ø–∏–∑–æ–¥ |
| –ù–µ –µ—Å—Ç –≥–ª—é—Ç–µ–Ω | –ü—Ä–æ—Ñ–∏–ª—å | –§–∞–∫—Ç |
| –†–∞–∑–º–µ—Ä M, –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç earth tones | –ü—Ä–æ—Ñ–∏–ª—å | –§–∞–∫—Ç |
| –í –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ –≤ –∫–∏–Ω–æ –±—ã–ª–æ —Ö–æ–ª–æ–¥–Ω–æ | –ß–∞—Ç, 2 –º–µ—Å –Ω–∞–∑–∞–¥ | –≠–ø–∏–∑–æ–¥ |
| –°–µ–π—á–∞—Å +42¬∞C, –Ω–æ –≤ –∫–∏–Ω–æ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä | –ü–æ–≥–æ–¥–∞ / —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å | **–ö–æ–Ω—Ç–µ–∫—Å—Ç** |
| –ü—è—Ç–Ω–∏—Ü–∞ –≤–µ—á–µ—Ä, —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –∏—Ñ—Ç–∞—Ä | –í—Ä–µ–º—è / –∫—É–ª—å—Ç—É—Ä–∞ | **–ö–æ–Ω—Ç–µ–∫—Å—Ç** |
| –û–Ω–∞ –≤ Dubai Hills Mall | –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è | **–ö–æ–Ω—Ç–µ–∫—Å—Ç** |
| –í Reel Cinemas –∏–¥—ë—Ç –∫–æ—Ä–µ–π—Å–∫–∏–π —Ç—Ä–∏–ª–ª–µ—Ä | –ö–∞—Ç–∞–ª–æ–≥ / —Å–æ–±—ã—Ç–∏—è | **–ö–æ–Ω—Ç–µ–∫—Å—Ç** |
| –†–∞–º–∞–¥–∞–Ω ‚Äî —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –∏—Ñ—Ç–∞—Ä–∞ | –ö—É–ª—å—Ç—É—Ä–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å | **–ö–æ–Ω—Ç–µ–∫—Å—Ç** |

–ö–ª—é—á–µ–≤–æ–π insight: **–∑–Ω–∞–Ω–∏–µ –æ —é–∑–µ—Ä–µ ‚Äî —ç—Ç–æ —Ç—Ä–∏ —Å–ª–æ—è, –∞ –Ω–µ –æ–¥–∏–Ω:**

```
User Knowledge  = –∫—Ç–æ —Ç—ã        (—Ñ–∞–∫—Ç—ã, –ø—Ä–æ—Ñ–∏–ª—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ)
Chat Retrieval  = —á—Ç–æ –º—ã –ø–æ–º–Ω–∏–º  (—ç–ø–∏–∑–æ–¥—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤)
Context Agent   = —á—Ç–æ —Å–µ–π—á–∞—Å     (–º–∏—Ä –≤–æ–∫—Ä—É–≥ —Ç–µ–±—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å)
```

–ë–µ–∑ –ª—é–±–æ–≥–æ –∏–∑ —Ç—Ä—ë—Ö —Å–ª–æ—ë–≤ UNDE ‚Äî –ø—Ä–æ—Å—Ç–æ –µ—â—ë –æ–¥–∏–Ω —á–∞—Ç-–±–æ—Ç.

> **Implementation spec:** –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç **—á—Ç–æ** –¥–µ–ª–∞–µ—Ç –∫–∞–∂–¥—ã–π —Å–ª–æ–π –∑–Ω–∞–Ω–∏–π. –î–µ—Ç–∞–ª—å–Ω–æ–µ **–∫–∞–∫** ‚Äî –≤ [UNDE_Knowledge_Staging_Pipeline.md](UNDE_Knowledge_Staging_Pipeline.md) (KSP v1.7):
> - **Epistemic Contract** ‚Äî 3 –ø—Ä–∞–≤–∏–ª–∞: RAW = –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã; User Knowledge = –∫–µ—à —Å evidence pointers; –ª—é–±–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–µ–Ω –±–µ–∑ raw excerpt
> - **Knowledge Extraction** ‚Äî instant patterns (regex, <1ms, MVP) + batch extraction (LLM, –§–∞–∑–∞ 2) + Validator Gate
> - **ContextPack assembly** ‚Äî raw_excerpt (head+tail, –Ω–µ LEFT(80)), Privacy Guard –Ω–∞ span, snippet subordination –≤ –ø—Ä–æ–º–ø—Ç–µ, 8 –ø—Ä–∞–≤–∏–ª –∞—Ä–±–∏—Ç—Ä–∞–∂–∞
> - **Memory Correction Loop** ‚Äî CORRECTION_PATTERNS (ru/en/ar/Arabizi), is_disputed, cascade forget —Å onboarding protection

### –ß—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**"–ü–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π"** ‚Äî 20, 50, –¥–∞–∂–µ 200 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–æ –î–∏–º—É –∏–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ 3 –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥. –ü—Ä–æ—Å—Ç–æ–π truncation —É–±–∏–≤–∞–µ—Ç –≤—Å—ë, —á—Ç–æ –¥–µ–ª–∞–µ—Ç UNDE —É–Ω–∏–∫–∞–ª—å–Ω—ã–º.

**"–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ"** ‚Äî –∑–∞ –≥–æ–¥ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (~6000 —Å–æ–æ–±—â–µ–Ω–∏–π, ~6MB —Ç–µ–∫—Å—Ç–∞) —ç—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –Ω–µ –≤–ª–µ–∑–µ—Ç –≤ context window –Ω–∏ –æ–¥–Ω–æ–π LLM. –î–∞–∂–µ –µ—Å–ª–∏ –≤–ª–µ–∑–µ—Ç ‚Äî latency –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–µ–¥–µ–ª—å–Ω—ã–µ.

**"–¢–æ–ª—å–∫–æ extracted knowledge"** ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–∞—ë—Ç "–∫—Ç–æ —Ç–∞–∫–æ–π –í–∞—Å—è", –Ω–æ –Ω–µ –¥–∞—ë—Ç —ç–ø–∏–∑–æ–¥–∏—á–µ—Å–∫—É—é –ø–∞–º—è—Ç—å. Knowledge extraction pipeline –Ω–µ –º–æ–∂–µ—Ç –∏ –Ω–µ –¥–æ–ª–∂–µ–Ω –≤—ã—Ç–∞—Å–∫–∏–≤–∞—Ç—å –í–°–Å ‚Äî –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–∞–∫—Ç–∞–º–∏, –∞ –Ω–µ —Å –∏—Å—Ç–æ—Ä–∏—è–º–∏.

**"–ë–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–∏—Ä–∞"** ‚Äî –¥–∞–∂–µ —Å –∏–¥–µ–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç—å—é, –µ—Å–ª–∏ UNDE –Ω–µ –∑–Ω–∞–µ—Ç —á—Ç–æ –Ω–∞ —É–ª–∏—Ü–µ +42¬∞C –∏ —Å–µ–π—á–∞—Å –†–∞–º–∞–¥–∞–Ω ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±—É–¥—É—Ç –æ—Ç–æ—Ä–≤–∞–Ω—ã –æ—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏.

### –¢—Ä–µ–±—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–¢—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–º–µ—Å—Ç–µ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –ø–æ–ª–Ω—ã–π ContextPack:

1. **Semantic Retrieval** ‚Äî –ø–æ –≤—Ö–æ–¥—è—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é –Ω–∞—Ö–æ–¥–∏—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∏–∑ –í–°–ï–ô –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
2. **User Knowledge** ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã –æ —é–∑–µ—Ä–µ (—É–∂–µ –µ—Å—Ç—å –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ)
3. **Context Agent** ‚Äî —Å–æ–±–∏—Ä–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∏—Ä–µ –≤–æ–∫—Ä—É–≥ —é–∑–µ—Ä–∞

---

## 2. –†–µ—à–µ–Ω–∏–µ: Semantic Retrieval Layer

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

–ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Chat History –ø–æ–ª—É—á–∞–µ—Ç **vector embedding** –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü—Ä–∏ –Ω–æ–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ —é–∑–µ—Ä–∞ ‚Äî embedding –∑–∞–ø—Ä–æ—Å–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è —Å embeddings –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏, –∏ TOP-N —Å–∞–º—ã—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –≤—ã—Ç–∞—Å–∫–∏–≤–∞—é—Ç—Å—è –≤ ContextPack.

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: —á—Ç–æ embed'–∏—Ç—å

–ù–µ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞—Å–ª—É–∂–∏–≤–∞—é—Ç embedding'–∞. "–û–∫", "—Å–ø–∞—Å–∏–±–æ", "üëç" ‚Äî —à—É–º.

**–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è MVP:**
- Embed'–∏—Ç—å —Ç–æ–ª—å–∫–æ **—Å–æ–æ–±—â–µ–Ω–∏—è —é–∑–µ—Ä–∞** (role = 'user')
- –î–ª–∏–Ω–∞ > 15 —Å–∏–º–≤–æ–ª–æ–≤
- –ù–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —ç–º–æ–¥–∑–∏/—Å—Ç–∏–∫–µ—Ä—ã
- **Salience check (rule-based):** —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º–µ–Ω–∞, –º–µ—Å—Ç–∞, —ç–º–æ—Ü–∏–∏, –∂–µ–ª–∞–Ω–∏—è, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, –ø—Ä–æ–±–ª–µ–º—ã

**–ù–∞ –±—É–¥—É—â–µ–µ:** salience scorer ‚Äî –º–∞–ª–µ–Ω—å–∫–∞—è –º–æ–¥–µ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–º–µ—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ *memory-worthy*.

### –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–ø–∞ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è

–ü—Ä–∏ ingestion –∫–∞–∂–¥–æ–µ embeddable-—Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç **memory_type** (—Ç–∏–ø) –∏ **memory_confidence** (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å). –í–º–µ—Å—Ç–µ –æ–Ω–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞—Ç—É—Ö–∞–Ω–∏—è: —Ç–∏–ø –∑–∞–¥–∞—ë—Ç –±–∞–∑–æ–≤—ã–π Œª, –∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –µ–≥–æ ‚Äî —á–µ–º —É–≤–µ—Ä–µ–Ω–Ω–µ–µ –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏–µ, —Ç–µ–º –º–µ–¥–ª–µ–Ω–Ω–µ–µ –∑–∞—Ç—É—Ö–∞–µ—Ç.

```python
# –ò–Ω—Ç–µ–Ω—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã ‚Üí –≤—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (–º–µ–¥–ª–µ–Ω–Ω–µ–µ –∑–∞—Ç—É—Ö–∞–µ—Ç)
INTENSIFIERS = ['–≤—Å–µ–≥–¥–∞', '–Ω–∏–∫–æ–≥–¥–∞', '–æ–±–æ–∂–∞—é', '–Ω–µ–Ω–∞–≤–∏–∂—É',
                '—Ç–µ—Ä–ø–µ—Ç—å –Ω–µ –º–æ–≥—É', '–≤—Å—é –∂–∏–∑–Ω—å', '—Å –¥–µ—Ç—Å—Ç–≤–∞',
                'always', 'never', 'absolutely',
                'ÿØÿßÿ¶ŸÖÿßŸã', 'ÿ£ÿ®ÿØÿßŸã']

# –°–º—è–≥—á–∏—Ç–µ–ª–∏ ‚Üí –Ω–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (–±—ã—Å—Ç—Ä–µ–µ –∑–∞—Ç—É—Ö–∞–µ—Ç)
SOFTENERS = ['—Å–µ–≥–æ–¥–Ω—è', '—á—Ç–æ-—Ç–æ', '–Ω–µ–º–Ω–æ–≥–æ', '–ø–æ–∫–∞ —á—Ç–æ',
             '–Ω–∞–≤–µ—Ä–Ω–æ–µ', '–º–æ–∂–µ—Ç –±—ã—Ç—å', '–∫–∞–∂–µ—Ç—Å—è',
             'today', 'maybe', 'a bit',
             'ÿ±ÿ®ŸÖÿß', 'ÿ¥ŸàŸä']

def classify_memory(text: str, role: str) -> tuple:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è"""
    memory_type = _classify_type(text)
    
    text_lower = text.lower()
    if any(s in text_lower for s in INTENSIFIERS):
        confidence = 0.9
    elif any(s in text_lower for s in SOFTENERS):
        confidence = 0.3
    else:
        confidence = 0.5  # default
    
    return memory_type, confidence

def _classify_type(text: str) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è"""
    emotion_signals = ['—É—Å—Ç–∞–ª–∞', '–±–µ—Å–∏—Ç', '—Å—á–∞—Å—Ç–ª–∏–≤–∞', '–≥—Ä—É—Å—Ç–Ω–æ', 
                       '–Ω–µ—Ä–≤–Ω–∏—á–∞—é', 'tired', 'happy', 'angry',
                       'ÿ™ÿπÿ®ÿßŸÜÿ©', 'ÿ≥ÿπŸäÿØÿ©', 'ÿ≤ÿπŸÑÿßŸÜÿ©']
    preference_signals = ['–ª—é–±–ª—é', '–Ω–µ–Ω–∞–≤–∏–∂—É', '–Ω—Ä–∞–≤–∏—Ç—Å—è', '–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è',
                          '–º–æ–π —Å—Ç–∏–ª—å', 'love', 'hate', 'prefer',
                          'ÿ£ÿ≠ÿ®', 'ÿ£ŸÉÿ±Ÿá', 'ÿ£ŸÅÿ∂ŸÑ']
    event_signals = ['–≤—á–µ—Ä–∞', '—Å–µ–≥–æ–¥–Ω—è', '–∑–∞–≤—Ç—Ä–∞', '–≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑',
                     '–Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö', 'yesterday', 'today',
                     'ÿ£ŸÖÿ≥', 'ÿßŸÑŸäŸàŸÖ', 'ÿ∫ÿØÿßŸã']
    fact_signals = ['—Ä–∞–∑–º–µ—Ä', '–∞–ª–ª–µ—Ä–≥–∏—è', '–Ω–µ –µ–º', 'size', 'allergy',
                    '—Ä–∞–±–æ—Ç–∞—é', '–∂–∏–≤—É', 'ŸÖŸÇÿßÿ≥', 'ÿ≠ÿ≥ÿßÿ≥Ÿäÿ©']
    
    text_lower = text.lower()
    if any(s in text_lower for s in emotion_signals):
        return 'emotion'
    if any(s in text_lower for s in fact_signals):
        return 'fact'
    if any(s in text_lower for s in preference_signals):
        return 'preference'
    if any(s in text_lower for s in event_signals):
        return 'event'
    return 'general'
```

**–ë–∞–∑–æ–≤—ã–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞—Ç—É—Ö–∞–Ω–∏—è –ø–æ —Ç–∏–ø—É:**

| –¢–∏–ø | base_Œª | –ë–∞–∑–æ–≤—ã–π –ø–æ–ª—É—Ä–∞—Å–ø–∞–¥ | –ü—Ä–∏–º–µ—Ä |
|-----|--------|-------------------|--------|
| emotion | 0.015 | ~46 –¥–Ω–µ–π | "—É—Å—Ç–∞–ª–∞ –ø–æ—Å–ª–µ —Ä–∞–±–æ—Ç—ã" |
| event | 0.008 | ~87 –¥–Ω–µ–π | "–≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ –≤ –∫–∏–Ω–æ –±—ã–ª–æ —Ö–æ–ª–æ–¥–Ω–æ" |
| general | 0.005 | ~139 –¥–Ω–µ–π | "–î–∏–º–∞ –ø—Ä–µ–¥–ª–æ–∂–∏–ª —Å—Ö–æ–¥–∏—Ç—å –∫—É–¥–∞-–Ω–∏–±—É–¥—å" |
| preference | 0.002 | ~347 –¥–Ω–µ–π | "–æ–±–æ–∂–∞—é –∫–æ—Ä–µ–π—Å–∫–∏–µ —Ç—Ä–∏–ª–ª–µ—Ä—ã" |
| fact | 0.001 | ~693 –¥–Ω—è | "–Ω–µ –µ–º –≥–ª—é—Ç–µ–Ω" |

**–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ confidence:**

```
effective_Œª = base_Œª(memory_type) √ó (1.3 - memory_confidence)
```

| –°–æ–æ–±—â–µ–Ω–∏–µ | type | confidence | base_Œª | effective_Œª | –ü–æ–ª—É—Ä–∞—Å–ø–∞–¥ |
|-----------|------|------------|--------|-------------|-----------|
| "–æ–±–æ–∂–∞—é –∫–æ—Ä–µ–π—Å–∫–∏–µ —Ç—Ä–∏–ª–ª–µ—Ä—ã" | preference | 0.9 | 0.002 | 0.0008 | ~866 –¥–Ω–µ–π |
| "–Ω—Ä–∞–≤—è—Ç—Å—è —Ç—Ä–∏–ª–ª–µ—Ä—ã" | preference | 0.5 | 0.002 | 0.0016 | ~433 –¥–Ω—è |
| "–º–æ–∂–µ—Ç –ø–æ–ø—Ä–æ–±—É—é —Ç—Ä–∏–ª–ª–µ—Ä" | preference | 0.3 | 0.002 | 0.002 | ~347 –¥–Ω–µ–π |
| "–ù–ï–ù–ê–í–ò–ñ–£ Zara" | preference | 0.9 | 0.002 | 0.0008 | ~866 –¥–Ω–µ–π |
| "—Å–µ–≥–æ–¥–Ω—è —á—Ç–æ-—Ç–æ —É—Å—Ç–∞–ª–∞" | emotion | 0.3 | 0.015 | 0.015 | ~46 –¥–Ω–µ–π |
| "—è –≤—Å–µ–≥–¥–∞ —É—Å—Ç–∞–≤—à–∞—è –æ—Ç —Ä–∞–±–æ—Ç—ã" | emotion | 0.9 | 0.015 | 0.006 | ~116 –¥–Ω–µ–π |

–ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –∫–ª—é—á–µ–≤–æ–π –∫–µ–π—Å. "–í—Å–µ–≥–¥–∞ —É—Å—Ç–∞–≤—à–∞—è –æ—Ç —Ä–∞–±–æ—Ç—ã" ‚Äî –Ω–µ –º–∏–º–æ–ª—ë—Ç–Ω–∞—è —ç–º–æ—Ü–∏—è, –∞ –∂–∏–∑–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç. Confidence 0.9 –∑–∞–º–µ–¥–ª—è–µ—Ç –∑–∞—Ç—É—Ö–∞–Ω–∏–µ –≤ 2.5 —Ä–∞–∑–∞. –ë–µ–∑ confidence ‚Äî –∏—Å—á–µ–∑–ª–æ –±—ã –∑–∞ 46 –¥–Ω–µ–π –∫–∞–∫ –æ–±—ã—á–Ω–∞—è —ç–º–æ—Ü–∏—è.

### Retrieval —Å —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º Temporal Decay –∏ Hybrid Search

**–í–∞–∂–Ω–æ: temporal decay ‚Äî —ç—Ç–æ recency boost, –∞ –Ω–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ –∑–∞ –¥–∞–≤–Ω–æ—Å—Ç—å.**

–§–æ—Ä–º—É–ª–∞ –¥–∞—ë—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—å ‚â• 1.0 (–ø—Ä–∏–º–µ—Ä–Ω–æ 1.0‚Äì1.3). –°–≤–µ–∂–∏–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—É—á–∞—é—Ç –Ω–µ–±–æ–ª—å—à–æ–π –±–æ–Ω—É—Å, –Ω–æ —Å—Ç–∞—Ä—ã–µ **–Ω–µ —à—Ç—Ä–∞—Ñ—É—é—Ç—Å—è** ‚Äî –∏—Ö –±–∞–∑–æ–≤—ã–π score –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è "–¥—Ä—É–≥–∞": —Å—Ç–∞—Ä–∞—è, –Ω–æ —Ç–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å (preference —Å confidence 0.9) –Ω–µ –¥–æ–ª–∂–Ω–∞ —Ç–æ–Ω—É—Ç—å –ø–æ–¥ –≤–µ—Å–æ–º –≤—á–µ—Ä–∞—à–Ω–∏—Ö –æ–±—Ä—ã–≤–∫–æ–≤.

**Hybrid Search: Vector + Full-Text Search (FTS)**

Vector search –Ω–∞—Ö–æ–¥–∏—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ –±–ª–∏–∑–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è. FTS –ª–æ–≤–∏—Ç —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: –∏–º–µ–Ω–∞ (–î–∏–º–∞), –±—Ä–µ–Ω–¥—ã (Zara), —Ä–∞–∑–º–µ—Ä—ã (38). –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

**–†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:**
- **FTS** = —Ç–æ—á–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏: –∏–º–µ–Ω–∞, –±—Ä–µ–Ω–¥—ã, —Ü–∏—Ñ—Ä—ã, —Ä–∞–∑–º–µ—Ä—ã. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è `'simple'` –Ω–µ –¥–µ–ª–∞–µ—Ç –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ä—É—Å—Å–∫–æ–≥–æ/–∞—Ä–∞–±—Å–∫–æ–≥–æ ‚Äî —ç—Ç–æ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ. FTS –Ω–µ –¥–ª—è "—Å–º—ã—Å–ª–∞", –∞ –¥–ª—è "—Ç–æ—á–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤".
- **Embeddings** = —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —Å–º—ã—Å–ª, —Å–∏–Ω–æ–Ω–∏–º—ã, –∫–æ–Ω—Ç–µ–∫—Å—Ç. "–•–æ—á—É –≤ –∫–∏–Ω–æ" –Ω–∞–π–¥—ë—Ç "–î–∏–º–∞ –ø—Ä–µ–¥–ª–æ–∂–∏–ª —Å—Ö–æ–¥–∏—Ç—å –∫—É–¥–∞-–Ω–∏–±—É–¥—å", —Ö–æ—Ç—è —Å–ª–æ–≤–∞ "–∫–∏–Ω–æ" —Ç–∞–º –Ω–µ—Ç.

–û–Ω–∏ –¥–æ–ø–æ–ª–Ω—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞, –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç.

**–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —à–∫–∞–ª:**

vec_score (cosine similarity) –∂–∏–≤—ë—Ç –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ ~0.2‚Äì0.9. ts_rank ‚Äî –≤ —Å–≤–æ–µ–π —à–∫–∞–ª–µ. –ë–µ–∑ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö –±—É–¥–µ—Ç –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —Ç–æ–Ω—É—Ç—å.

```sql
vec_score_norm = GREATEST(0, 1 - (embedding <=> $1))  -- —É–∂–µ 0..1
fts_score_norm = LEAST(1.0, ts_rank(...) * K)          -- K –ø–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è —ç–º–ø–∏—Ä–∏—á–µ—Å–∫–∏, —Å—Ç–∞—Ä—Ç K=10
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ K=10:** –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω ‚Äî –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–∞—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–∫–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è ¬´–î–∏–º–∞¬ª vs –¥–ª–∏–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å ¬´—á—Ç–æ –º–Ω–µ –ø–æ—Å–æ–≤–µ—Ç–æ–≤–∞–ª–∏ –Ω–∞ —É–∂–∏–Ω –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑¬ª) —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ts_rank —Å–∏–ª—å–Ω–æ –ø–ª–∞–≤–∞–µ—Ç. –î–ª—è MVP K=10 –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω, –Ω–æ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (50‚Äì100 —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤) —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ **–ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å–Ω—É—é –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é**: `fts_score_norm = ts_rank / max_ts_rank_in_set`. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –≤–µ—Å FTS —Å—Ç–∞–±–∏–ª—å–Ω—ã–º –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã –∑–∞–ø—Ä–æ—Å–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π.

**–§–æ—Ä–º—É–ª–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–∫–æ—Ä–∏–Ω–≥–∞:**

```
final_score = (0.7 √ó vec_score_norm + 0.3 √ó fts_score_norm) 
              √ó (1 + 0.3 √ó EXP(-effective_Œª √ó days_since))
                                    ‚Üë
                          recency boost: ‚â• 1.0, –Ω–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ
```

–ì–¥–µ effective_Œª = base_Œª(memory_type) √ó (1.3 - memory_confidence).

**Diversity filter:** –Ω–µ –±–æ–ª–µ–µ 3 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –æ–¥–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –¥–Ω—è. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–∑–∞—Å—Ç—Ä–µ–≤–∞–Ω–∏–µ" –Ω–∞ –æ–¥–Ω–æ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ —Ç–µ–º. –ù–∞ –±—É–¥—É—â–µ–µ: –¥–æ–±–∞–≤–∏—Ç—å similarity-based –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ cosine similarity > 0.9), –Ω–æ –¥–ª—è MVP –ø—Ä–æ—Å—Ç–æ–π day-bucket –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω.

**Similarity threshold:** vec_score > 0.5 –ò–õ–ò fts_score > 0. –ï—Å–ª–∏ –º–µ–Ω—å—à–µ 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Äî –æ—Ç–¥–∞—ë–º —Å–∫–æ–ª—å–∫–æ –µ—Å—Ç—å, –Ω–µ –¥–æ–∫–∏–¥—ã–≤–∞–µ–º —à—É–º–æ–º.

### Memory Snippets: —ç–≤–æ–ª—é—Ü–∏—è –ø–æ–¥—Ö–æ–¥–∞

Runtime LLM-–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç +300-500ms –∫ –∫–∞–∂–¥–æ–º—É –∑–∞–ø—Ä–æ—Å—É. –í voice-first UX —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ: precompute –ø—Ä–∏ ingestion (–§–∞–∑–∞ 2). –ù–∞ MVP ‚Äî raw_excerpt –±–µ–∑ snippet.**

–ù–∞ MVP snippet = NULL ‚Äî LLM —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —Å raw_excerpt (head+tail). –ü–æ—Å–ª–µ MVP (–§–∞–∑–∞ 2) ‚Äî async –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ **memory_snippet** (1 —Å—Ç—Ä–æ–∫–∞, ~20-30 —Å–ª–æ–≤) –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î.

**MVP ‚Äî –ø—Ä–∏ ingestion:** memory_snippet = NULL. Episode card —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ raw_excerpt (head+tail).

**–§–∞–∑–∞ 2 ‚Äî –ø—Ä–∏ ingestion (async, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —é–∑–µ—Ä–∞):**
```
–°–æ–æ–±—â–µ–Ω–∏–µ: "–≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ –∫–æ–≥–¥–∞ –º—ã —Å –î–∏–º–æ–π —Ö–æ–¥–∏–ª–∏ –≤ IMAX 
–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∏–ª—å–º –ü–æ–Ω –ß–∂—É–Ω –•–æ, –±—ã–ª–æ —Ç–∞–∫ —Ö–æ–ª–æ–¥–Ω–æ –æ—Ç 
–∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞, —Ö–æ—Ä–æ—à–æ —á—Ç–æ —è –≤–∑—è–ª–∞ –∫—É—Ä—Ç–∫—É, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ 
–º—ë—Ä–∑–ª–∞ –≤–µ—Å—å —Å–µ–∞–Ω—Å"

‚Üí memory_snippet: "–í IMAX –±—ã–ª–æ —Ö–æ–ª–æ–¥–Ω–æ –æ—Ç –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞ ‚Üí –±—Ä–∞—Ç—å —Ç—ë–ø–ª—ã–π —Å–ª–æ–π"
```

**–§–∞–∑–∞ 2 ‚Äî –ø—Ä–∏ retrieval (runtime, 0ms –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ):**

Snippet –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–Ω–µ –¥–ª—è –¥–æ–≤–µ—Ä–∏—è), raw_excerpt –æ—Å—Ç–∞—ë—Ç—Å—è –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º. –ù–∏–∫–∞–∫–∏—Ö LLM-–≤—ã–∑–æ–≤–æ–≤ –≤ —Ä–∞–Ω—Ç–∞–π–º–µ.

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–Ω–∏–ø–ø–µ—Ç–∞:**
- –î–ª—è MVP: **snippet = '' (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)** + raw_excerpt (head+tail). –ù–µ LEFT(content, 80) ‚Äî –æ–±—Ä–µ–∑–∫–∞ —Å–æ–∑–¥–∞—ë—Ç –ø—Å–µ–≤–¥–æ-—Ä–µ–∑—é–º–µ, –∫–æ—Ç–æ—Ä–æ–µ LLM –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å –∑–∞ —Ñ–∞–∫—Ç (Epistemic Contract, –ü—Ä–∞–≤–∏–ª–æ 3). Episode card –Ω–∞ MVP —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ raw_excerpt –∏ message_id. –°–º. [KSP](UNDE_Knowledge_Staging_Pipeline.md) –§–∏–∫—Å 4A.
- –ü–æ—Å–ª–µ MVP (–§–∞–∑–∞ 2): **async LLM** (DeepSeek/Gemini Flash) ‚Äî lazy snippet generation, –º–∞–∫—Å 120 —Å–∏–º–≤–æ–ª–æ–≤. –î–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –Ω–µ –¥–ª—è –¥–æ–≤–µ—Ä–∏—è. –°–º. [KSP](UNDE_Knowledge_Staging_Pipeline.md) –§–∏–∫—Å 4B.

**Fallback:** –µ—Å–ª–∏ memory_snippet –µ—â—ë –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω ‚Äî –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ '' (–Ω–µ truncation). LLM —Ä–∞–±–æ—Ç–∞–µ—Ç —Å raw_excerpt.

### –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä

Mood Agent —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —é–∑–µ—Ä–∞. –ò—Å–ø–æ–ª—å–∑—É–µ–º mood_frame –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π.

**MVP: keyword-based –º—è–≥–∫–∏–π —Ñ–∏–ª—å—Ç—Ä** (–ø–æ–Ω–∏–∂–µ–Ω–∏–µ score, –Ω–µ hard exclude):

```python
SENSITIVE_KEYWORDS = {
    'ru': ['—Ä–∞—Å—Å—Ç–∞–ª–∏—Å—å', '—Ä–∞–∑–≤–æ–¥', '–±—ã–≤—à–∏–π', '–±—ã–≤—à–∞—è', '—Ä–∞–∑—Ä—ã–≤', '–∏–∑–º–µ–Ω–∞',
           '—É–º–µ—Ä', '–ø–æ—Ö–æ—Ä–æ–Ω—ã', '–±–æ–ª–µ–∑–Ω—å', '–¥–∏–∞–≥–Ω–æ–∑', '–¥–µ–ø—Ä–µ—Å—Å–∏—è', '—Å—É–∏—Ü–∏–¥'],
    'en': ['broke up', 'divorce', 'ex-boyfriend', 'ex-girlfriend', 'breakup',
           'died', 'funeral', 'illness', 'diagnosis', 'depression'],
    'ar': ['ÿßŸÜŸÅÿµŸÑŸÜÿß', 'ÿ∑ŸÑÿßŸÇ', 'ÿßŸÑÿ≥ÿßÿ®ŸÇ', 'ŸàŸÅÿßÿ©', 'ŸÖÿ±ÿ∂', 'ÿßŸÉÿ™ÿ¶ÿßÿ®'],
}
ALL_SENSITIVE = [w for words in SENSITIVE_KEYWORDS.values() for w in words]

RELATIONSHIP_KEYWORDS = {
    'ru': ['—Ä–∞—Å—Å—Ç–∞–ª–∏—Å—å', '—Ä–∞–∑–≤–æ–¥', '–±—ã–≤—à–∏–π', '–±—ã–≤—à–∞—è', '—Ä–∞–∑—Ä—ã–≤'],
    'en': ['broke up', 'divorce', 'ex-boyfriend', 'ex-girlfriend'],
    'ar': ['ÿßŸÜŸÅÿµŸÑŸÜÿß', 'ÿ∑ŸÑÿßŸÇ', 'ÿßŸÑÿ≥ÿßÿ®ŸÇ'],
}
ALL_RELATIONSHIP = [w for words in RELATIONSHIP_KEYWORDS.values() for w in words]

def emotional_filter(episodes: list, mood_frame: dict, 
                     user_message: str) -> list:
    valence = mood_frame.get('valence', 0.5)
    user_lower = user_message.lower()
    user_mentions_topic = any(k in user_lower for k in ALL_RELATIONSHIP)
    
    for ep in episodes:
        raw = ep.get('raw_excerpt', '').lower()
        
        # –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç + —é–∑–µ—Ä —Ä–∞—Å—Å—Ç—Ä–æ–µ–Ω ‚Üí –ø–æ–Ω–∏–∑–∏—Ç—å score –Ω–∞ 50%
        if valence < 0.3 and any(k in raw for k in ALL_SENSITIVE):
            ep['final_score'] *= 0.5
        
        # –ü—Ä–æ—à–ª—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è ‚Äî suppress –µ—Å–ª–∏ —é–∑–µ—Ä —Å–∞–º –Ω–µ –ø–æ–¥–Ω—è–ª —Ç–µ–º—É
        if any(k in raw for k in ALL_RELATIONSHIP):
            if not user_mentions_topic:
                ep['final_score'] *= 0.3  # —Å–∏–ª—å–Ω–æ–µ –ø–æ–Ω–∏–∂–µ–Ω–∏–µ
    
    return sorted(episodes, key=lambda x: x['final_score'], reverse=True)
```

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- **–ú—è–≥–∫–∏–π, –Ω–µ –±–∏–Ω–∞—Ä–Ω—ã–π** ‚Äî –ø–æ–Ω–∏–∂–µ–Ω–∏–µ score, –Ω–µ —É–¥–∞–ª–µ–Ω–∏–µ. –ï—Å–ª–∏ episode –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–ø–∞–¥—ë—Ç.
- **past_relationship:** –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é suppress (score √ó 0.3). –ï—Å–ª–∏ —é–∑–µ—Ä —Å–∞–º —É–ø–æ–º–∏–Ω–∞–µ—Ç —Ç–µ–º—É ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ–º (bypass). –Æ–∑–µ—Ä –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –æ–±—Å—É–∂–¥–∞—Ç—å —á—Ç–æ —Ö–æ—á–µ—Ç.
- **–ù–∞ –§–∞–∑–µ 2:** –∑–∞–º–µ–Ω–∏—Ç—å keywords –Ω–∞ classifier (fine-tuned –∏–ª–∏ zero-shot) –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ episodes.

### Memory Density Cap

–ß—Ç–æ–±—ã UNDE –Ω–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª—Å—è –∏–∑ "–¥—Ä—É–≥–∞" –≤ "—Å—Ç–∞–ª–∫–µ—Ä–∞" ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏:

```python
# –í LLM Orchestrator –ø—Ä–∏ —Å–±–æ—Ä–∫–µ ContextPack
# –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π cap (KSP –§–∏–∫—Å 6): –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑—Ä–µ–ª–æ—Å—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—è
def get_memory_density_cap(total_messages: int) -> tuple[int, float]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (max_episodes, max_density)"""
    if total_messages < 50:     # –Ω–æ–≤—ã–π —é–∑–µ—Ä
        return (3, 0.30)
    elif total_messages < 300:  # –∞–∫—Ç–∏–≤–Ω—ã–π 1-3 –º–µ—Å
        return (5, 0.35)
    else:                       # –∑—Ä–µ–ª—ã–π –ø—Ä–æ—Ñ–∏–ª—å
        return (7, 0.40)

max_episodes, max_density = get_memory_density_cap(conversation.message_count)

if consecutive_memory_responses > 2:
    suppress_memory = True
if memory_responses_in_last_10 / 10 > max_density:
    suppress_memory = True
```

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω *—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å*, —á—Ç–æ –µ–≥–æ –ø–æ–º–Ω—è—Ç ‚Äî –Ω–æ –Ω–µ *–æ—â—É—â–∞—Ç—å*, —á—Ç–æ –∑–∞ –Ω–∏–º —Å–ª–µ–¥—è—Ç.

**–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏:**
- –ù–ï —Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—ã: ~~"6 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥ —Ç—ã –≥–æ–≤–æ—Ä–∏–ª–∞..."~~ ‚Üí "–¢—ã –∂–µ –ª—é–±–∏—à—å –∫–æ—Ä–µ–π—Å–∫–∏–µ —Ç—Ä–∏–ª–ª–µ—Ä—ã?"
- –ù–ï —É–ø–æ–º–∏–Ω–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫: ~~"–¢—ã –º–Ω–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–ª–∞ —á—Ç–æ..."~~ ‚Üí –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é
- –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É: –º–∞–∫—Å–∏–º—É–º 2-3 –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞ –æ—Ç–≤–µ—Ç

### –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π "–ó–∞–±—É–¥—å —ç—Ç–æ"

–í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ —Ä—è–¥–æ–º —Å –∫–∞–∂–¥—ã–º –æ—Ç–≤–µ—Ç–æ–º UNDE, –≥–¥–µ –ø—Ä–æ—è–≤–∏–ª–∞—Å—å –ø–∞–º—è—Ç—å:

```
UNDE: "–û, —Å –î–∏–º–æ–π? –°–º–æ—Ç—Ä–∏, –≤ Reel Cinemas 
       —Å–µ–π—á–∞—Å –∏–¥—ë—Ç –∫–æ—Ä–µ–π—Å–∫–∏–π —Ç—Ä–∏–ª–ª–µ—Ä..."

       [üëç]  [üëé]  [üóëÔ∏è –ó–∞–±—É–¥—å —ç—Ç–æ]
```

**–£—Ä–æ–≤–µ–Ω—å 1: Soft Forget (–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)**

–Æ–∑–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "–ó–∞–±—É–¥—å" ‚Üí UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫–∏–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å ‚Üí —é–∑–µ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç —á—Ç–æ –∑–∞–±—ã—Ç—å.

```sql
-- –ö–∞—Å–∫–∞–¥–Ω–æ–µ soft-forget: –æ–±–Ω—É–ª—è–µ–º embedding –∏ snippet
UPDATE messages SET 
    is_forgotten = TRUE,
    embedding = NULL,
    memory_snippet = NULL
WHERE conversation_id = $1 AND id = $2;
-- + cascade forget (KSP –§–∏–∫—Å 15): –æ–±–Ω—É–ª–∏—Ç—å snippets —Å–æ—Å–µ–¥–µ–π ¬±1,
-- response_description —É —Å–≤—è–∑–∞–Ω–Ω—ã—Ö assistant-–æ—Ç–≤–µ—Ç–æ–≤,
-- –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å UK —Å —ç—Ç–∏–º evidence (–∫—Ä–æ–º–µ onboarding)
-- –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: —Å–º. 04_Dubai_User_Data_Shard.md
UPDATE user_knowledge SET is_active = FALSE
WHERE $2 = ANY(evidence_message_ids) AND extracted_from != 'onboarding';

-- –î–ª—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤: response_description –æ–±–Ω—É–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —é–∑–µ—Ä
-- —è–≤–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç "–∑–∞–±—É–¥—å —ç—Ç–æ—Ç –æ–±—Ä–∞–∑" (–∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ "–∑–∞–±—É–¥—å –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ").
-- –ò–Ω–∞—á–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º ‚Äî —á—Ç–æ–±—ã "–ø–æ–∫–∞–∂–∏ —Ç–æ—Ç –æ–±—Ä–∞–∑" —Ä–∞–±–æ—Ç–∞–ª–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏.
-- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:
UPDATE messages SET response_description = NULL
WHERE conversation_id = $1 AND id = $2;
```

**Undo (–µ—Å–ª–∏ —é–∑–µ—Ä –ø–µ—Ä–µ–¥—É–º–∞–ª):** re-embed –ø–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É content + regenerate snippet. –°—Ç–æ–∏–º–æ—Å—Ç—å: ~$0.000005 –∑–∞ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ + ~50ms. –î–µ—à–µ–≤–ª–µ, —á–µ–º –¥–µ—Ä–∂–∞—Ç—å –º—É—Å–æ—Ä–Ω—ã–µ embeddings –≤ –∏–Ω–¥–µ–∫—Å–µ.

**–£—Ä–æ–≤–µ–Ω—å 2: Hard Delete (GDPR erase)**

–í Settings ‚Üí Privacy ‚Üí "–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞". –§–∏–∑–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ:

```sql
-- –ö–∞—Å–∫–∞–¥–Ω–æ–µ hard-delete (–≤—Å–µ–≥–¥–∞ –ø–æ –ø–∞—Ä–µ conversation_id + id)
DELETE FROM user_knowledge WHERE $2 = ANY(evidence_message_ids);
UPDATE messages SET 
    content = '[deleted]',
    embedding = NULL,
    memory_snippet = NULL,
    memory_confidence = NULL,
    response_description = NULL,
    reply_to_id = NULL,
    is_forgotten = TRUE,
    deleted_at = NOW()
WHERE conversation_id = $1 AND id = $2;
-- NB: tsv (GENERATED) –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ content='[deleted]' + response_description=NULL

-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ tombstone registry (Production DB)
INSERT INTO deleted_messages_registry (conversation_id, message_id, deleted_at)
VALUES ($1, $2, NOW());
```

**Tombstone Registry** —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ **–¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö**:
1. **Production DB** (primary) ‚Äî —Ç–∞–±–ª–∏—Ü–∞ `deleted_messages_registry`, –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞
2. **Object Storage** ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ `hard_deleted_ids.jsonl` —Ä—è–¥–æ–º —Å –±—ç–∫–∞–ø–∞–º–∏

–≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è "–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –∏–∑ –±—ç–∫–∞–ø–∞ —à–∞—Ä–¥–∞ ‚Üí –ø–æ—Ç–µ—Ä—è–ª–∏ —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–∏–π". Production DB –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —à–∞—Ä–¥–∞, –ø–æ—ç—Ç–æ–º—É registry –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ—Å–ª–µ –ª—é–±–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≥–æ–Ω—è–µ—Ç—Å—è `apply_deletions.sql` –Ω–∞ –æ—Å–Ω–æ–≤–µ registry –∏–∑ Production DB.

**–†–µ–∞–∫—Ü–∏—è –Ω–∞ –æ—à–∏–±–∫—É –ø–∞–º—è—Ç–∏:**

–ï—Å–ª–∏ —é–∑–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç "–ù–µ—Ç, —è –ù–ï –ª—é–±–ª—é Zara!" –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ UNDE —É–ø–æ–º—è–Ω—É–ª Zara:

1. –ö–Ω–æ–ø–∫–∞ "–ó–∞–±—É–¥—å" —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞ <1 —Å–µ–∫—É–Ω–¥—É
2. –°–ª–µ–¥—É—é—â–∏–π –æ—Ç–≤–µ—Ç UNDE: "–û–π, –ø–µ—Ä–µ–ø—É—Ç–∞–ª ‚Äî –±–æ–ª—å—à–µ –Ω–µ –±—É–¥—É. –†–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫–∏–µ –±—Ä–µ–Ω–¥—ã —Ç–µ–±–µ —Å–µ–π—á–∞—Å –Ω—Ä–∞–≤—è—Ç—Å—è?"
3. User Knowledge –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è: Zara ‚Üí —É–±—Ä–∞—Ç—å –∏–∑ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π

–≠—Ç–æ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –¥–æ–≤–µ—Ä–∏–µ –ª–∏–±–æ –ª–æ–º–∞–µ—Ç—Å—è, –ª–∏–±–æ —É–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è.

### Consultant Response Description Layer (MVP)

**–ü—Ä–æ–±–ª–µ–º–∞:** –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (—Å—Ç–∏–ª–∏—Å—Ç, –ø–æ–≤–∞—Ä, –¥–∏–∑–∞–π–Ω–µ—Ä) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç ‚Äî –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Ä–µ—Ü–µ–ø—Ç, –º—É–¥–±–æ—Ä–¥. –Æ–∑–µ—Ä –≤–∏–¥–∏—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç: "–Ω–µ –º–æ–π —Ü–≤–µ—Ç", "–ø–æ–º–µ–Ω—è–π –æ–±—É–≤—å", "—Å–¥–µ–ª–∞–π –º–µ–Ω–µ–µ —Å–º–µ–ª–æ". –ë–µ–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è *—Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è* –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞:

- –°–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–∂–µ—Ç —Å–≤—è–∑–∞—Ç—å —Ä–µ–∞–∫—Ü–∏—é —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ (—Ü–≤–µ—Ç? —Ñ–∞—Å–æ–Ω? –±—Ä–µ–Ω–¥?)
- Retrieval —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –Ω—é–∞–Ω—Å—ã ‚Äî –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "–Ω–µ–º–æ–µ" –¥–ª—è vector/FTS
- Knowledge extraction –Ω–µ –æ–±—É—á–∏—Ç—Å—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º: "–Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –ø–ª–∞—Ç—å–µ" vs "–Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è *–±–æ—Ä–¥–æ–≤—ã–π —Ü–≤–µ—Ç* –ø–ª–∞—Ç—å—è" ‚Äî —Ä–∞–∑–Ω–∏—Ü–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞

**–ö–ª—é—á–µ–≤–æ–π insight:** –Ω–∞ —Å—Ç–∞—Ä—Ç–µ (fashion-only, Intelistyle) –æ–ø–∏—Å–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è **template-based** –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞. –ù–æ–ª—å LLM-–≤—ã–∑–æ–≤–æ–≤. –ö–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–µ –¥–æ–º–µ–Ω—ã (–ø–æ–≤–∞—Ä, –¥–∏–∑–∞–π–Ω–µ—Ä) ‚Äî —Ç–æ—Ç –∂–µ –º–µ—Ö–∞–Ω–∏–∑–º, –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω. –ü—è—Ç—å —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –Ω–∞ –¥–æ–º–µ–Ω.

#### –î–≤–∞ –ø–æ–ª—è, –Ω–æ–ª—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

```sql
ALTER TABLE messages
  ADD COLUMN response_description TEXT,
  ADD COLUMN reply_to_id UUID;
```

| –ü–æ–ª–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è | –ö—Ç–æ |
|------|-----------|-------------|-----|
| `response_description` | Backend-only —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞. –í UI –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è. | **SYNC** –ø—Ä–∏ INSERT assistant-—Å–æ–æ–±—â–µ–Ω–∏—è (template = ~0.1ms) | LLM Orchestrator |
| `reply_to_id` | –°—Å—ã–ª–∫–∞ –Ω–∞ assistant message, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Ä–µ–∞–∫—Ü–∏—è —é–∑–µ—Ä–∞ | –ü—Ä–∏ INSERT user-—Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞) | App / LLM Orchestrator |

**–°–µ–º–∞–Ω—Ç–∏–∫–∞:**
- `response_description` –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** —É assistant-—Å–æ–æ–±—â–µ–Ω–∏–π —Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–º (outfit, —Ä–µ—Ü–µ–ø—Ç, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è). –û–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã ‚Äî NULL.
- `reply_to_id` –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —É user-—Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è —Ä–µ–∞–∫—Ü–∏–µ–π –Ω–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç. –ù–µ FK (–∏–∑-–∑–∞ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è), –ø—Ä–æ—Å—Ç–æ —Å—Å—ã–ª–∫–∞.

**–ü–æ—á–µ–º—É description –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è SYNC, –∞ –Ω–µ async:** —Ö–æ—Ç—è PostgreSQL –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç GENERATED tsvector –ø—Ä–∏ UPDATE, async —Å–æ–∑–¥–∞—ë—Ç **race window**: –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω —é–∑–µ—Ä—É, —Ä–µ–∞–∫—Ü–∏—è –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É, –∞ –≤ –ë–î –µ—â—ë –Ω–µ—Ç `response_description` ‚Äî –∏ PK lookup –ø–æ `reply_to_id` –≤–µ—Ä–Ω—ë—Ç NULL. Sync INSERT (~0.1ms –¥–ª—è template) –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —ç—Ç—É –¥—ã—Ä—É.

#### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è `response_description` ‚Äî template-based

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–º–µ–Ω–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ–π —à–∞–±–ª–æ–Ω. –ù–∞ –≤—Ö–æ–¥ ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ (Intelistyle —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç SKU —Å –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏).

```python
FASHION_TRANSLATIONS = {
    'skirt': '—é–±–∫–∞', 'dress': '–ø–ª–∞—Ç—å–µ', 'shirt': '—Ä—É–±–∞—à–∫–∞', 'pants': '–±—Ä—é–∫–∏',
    'blazer': '–ø–∏–¥–∂–∞–∫', 'jacket': '–∫—É—Ä—Ç–∫–∞', 'coat': '–ø–∞–ª—å—Ç–æ', 'top': '—Ç–æ–ø',
    'shorts': '—à–æ—Ä—Ç—ã', 'sweater': '—Å–≤–∏—Ç–µ—Ä', 'blouse': '–±–ª—É–∑–∫–∞', 'jeans': '–¥–∂–∏–Ω—Å—ã',
    'burgundy': '–±–æ—Ä–¥–æ–≤—ã–π', 'navy': '—Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π', 'beige': '–±–µ–∂–µ–≤—ã–π',
    'white': '–±–µ–ª—ã–π', 'black': '—á—ë—Ä–Ω—ã–π', 'red': '–∫—Ä–∞—Å–Ω—ã–π', 'blue': '—Å–∏–Ω–∏–π',
    'green': '–∑–µ–ª—ë–Ω—ã–π', 'pink': '—Ä–æ–∑–æ–≤—ã–π', 'grey': '—Å–µ—Ä—ã–π', 'brown': '–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π',
    'midi': '–º–∏–¥–∏', 'mini': '–º–∏–Ω–∏', 'maxi': '–º–∞–∫—Å–∏', 'relaxed': '—Å–≤–æ–±–æ–¥–Ω—ã–π',
    'cotton': '—Ö–ª–æ–ø–æ–∫', 'linen': '–ª—ë–Ω', 'silk': '—à—ë–ª–∫', 'wool': '—à–µ—Ä—Å—Ç—å',
    'leather': '–∫–æ–∂–∞', 'denim': '–¥–µ–Ω–∏–º', 'cashmere': '–∫–∞—à–µ–º–∏—Ä',
    'casual': '–∫—ç–∂—É–∞–ª', 'evening': '–≤–µ—á–µ—Ä–Ω–∏–π', 'weekend': '–Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ',
}

def _translate_tokens(tokens: list[str]) -> str:
    """–ü–µ—Ä–µ–≤–æ–¥ –∫–ª—é—á–µ–≤—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –Ω–∞ —Ä—É—Å—Å–∫–∏–π –¥–ª—è FTS cross-lingual."""
    translated = []
    for t in tokens:
        t_lower = t.lower()
        if t_lower in FASHION_TRANSLATIONS:
            translated.append(FASHION_TRANSLATIONS[t_lower])
    return ' '.join(translated)

def build_response_description(consultant_type: str, data: dict) -> str | None:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—É—é '—Ç–µ–Ω—å' –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –¥–ª—è –ø–∞–º—è—Ç–∏.
    –î–≤—É—è–∑—ã—á–Ω–∞—è: English tokens | Russian tokens ‚Äî –¥–ª—è FTS cross-lingual.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞."""
    
    if consultant_type == 'stylist':
        items = data.get('items', [])
        if not items:
            return None
        parts = []
        all_tokens = []
        for item in items:
            tokens = [
                item.get('sku', ''),
                item.get('color', ''),
                item.get('silhouette', ''),
                item.get('fabric', ''),
                item.get('category', ''),
                item.get('brand', ''),
            ]
            if item.get('store'):
                tokens.append(item['store'])
            clean = [t for t in tokens if t]
            parts.append(' '.join(clean))
            all_tokens.extend(clean)
        
        meta = []
        if data.get('occasion'):
            meta.append(data['occasion'])
            all_tokens.append(data['occasion'])
        if data.get('style'):
            meta.append(data['style'])
            all_tokens.append(data['style'])
        
        en_desc = ', '.join(parts)
        if meta:
            en_desc += f" ‚Äî {' '.join(meta)}"
        
        ru_suffix = _translate_tokens(all_tokens)
        if ru_suffix:
            return f"{en_desc.lower()} | {ru_suffix}"
        return en_desc.lower()
    
    if consultant_type == 'chef':
        name = data.get('dish', '')
        cuisine = data.get('cuisine', '')
        allergens = ', '.join(data.get('allergens', []))
        kcal = data.get('calories', '')
        time_min = data.get('cook_time', '')
        parts = [name, cuisine]
        if allergens:
            parts.append(f"–∞–ª–ª–µ—Ä–≥–µ–Ω—ã: {allergens}")
        if kcal:
            parts.append(f"{kcal} –∫–∫–∞–ª")
        if time_min:
            parts.append(f"{time_min} –º–∏–Ω")
        return ', '.join(p for p in parts if p).lower()
    
    # –ù–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç ‚Üí –Ω–æ–≤—ã–π elif. 5-10 —Å—Ç—Ä–æ–∫.
    return None
```

**–ü—Ä–∏–º–µ—Ä (fashion, Intelistyle):**

```
Input (–∏–∑ Intelistyle API):
  items: [
    {sku: "MD-5510", color: "burgundy", silhouette: "midi", 
     fabric: "cotton", category: "skirt", brand: "Massimo Dutti"},
    {sku: "HM-2231", color: "white", silhouette: "relaxed", 
     fabric: "linen", category: "shirt", brand: "H&M"}
  ]
  occasion: "weekend"
  style: "casual"

Output (response_description):
  "MD-5510 burgundy midi cotton skirt massimo dutti, HM-2231 white relaxed linen shirt h&m ‚Äî weekend casual | –±–æ—Ä–¥–æ–≤—ã–π –º–∏–¥–∏ —Ö–ª–æ–ø–æ–∫ —é–±–∫–∞ —Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π –ª—ë–Ω —Ä—É–±–∞—à–∫–∞ –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ –∫—ç–∂—É–∞–ª"
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –≤ description –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞:**

–ö–æ–≥–¥–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (–æ–±—Ä–∞–∑, —Ä–µ—Ü–µ–ø—Ç, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é), description —ç—Ç–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å:
- **SKU / item_id** ‚Äî –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- **Brand** ‚Äî –¥–ª—è preference learning ("–Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π Zara")
- **Store / mall_id** (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Äî –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ ("–Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∏–∑ —ç—Ç–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞")
- –î–æ–º–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã (fashion: —Ü–≤–µ—Ç/—Å–∏–ª—É—ç—Ç/—Ç–∫–∞–Ω—å; chef: –∫—É—Ö–Ω—è/–∞–ª–ª–µ—Ä–≥–µ–Ω—ã; –∏ —Ç.–¥.)

–≠—Ç–æ –ø—Ä–∞–≤–∏–ª–æ **—Ç–æ–ª—å–∫–æ –¥–ª—è —à–∞–±–ª–æ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ description**, –Ω–µ –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π. –û–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ ("–ö–∞–∫–æ–π –ø–æ–≤–æ–¥?", "–ü—Ä–∏–≤–µ—Ç!") –∏–º–µ—é—Ç `response_description = NULL`.

**–ü–æ—á–µ–º—É —à–∞–±–ª–æ–Ω, –∞ –Ω–µ LLM:**
- 0.1ms vs 200-500ms ‚Äî sync –∑–∞–ø–∏—Å—å –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- $0 vs $0.001-0.005/–æ—Ç–≤–µ—Ç
- –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ‚Äî –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –¥–µ–±–∞–∂–∏—Ç—å
- –î–ª—è —Ü–µ–ª–µ–π –ø–∞–º—è—Ç–∏ (FTS + embedding) –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤, –Ω–µ –Ω—É–∂–µ–Ω "–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫"

#### `reply_to_id`: —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –¥–ª—è voice-first

–£ –Ω–∞—Å voice-first UX. –Æ–∑–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç "–Ω–µ, —Ü–≤–µ—Ç –Ω–µ –º–æ–π" –≥–æ–ª–æ—Å–æ–º ‚Äî –Ω–µ —Ç—ã–∫–∞–µ—Ç "–æ—Ç–≤–µ—Ç–∏—Ç—å" –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π message. –ü–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞:

```python
# –í LLM Orchestrator –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ user message
def resolve_reply_to(
    conversation_id: str,
    explicit_reply_to: str | None,   # –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (UI-–∫–Ω–æ–ø–∫–∞)
    message_created_at: datetime
) -> str | None:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω–∞ –∫–∞–∫–æ–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Ä–µ–∞–≥–∏—Ä—É–µ—Ç —é–∑–µ—Ä."""
    
    # 1. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —è–≤–Ω–æ —É–∫–∞–∑–∞–ª ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º
    if explicit_reply_to:
        return explicit_reply_to
    
    # 2. –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: –ø–æ—Å–ª–µ–¥–Ω–∏–π assistant message —Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–º –∑–∞ 10 –º–∏–Ω—É—Ç
    cutoff = message_created_at - timedelta(minutes=10)
    recent_artifacts = db.query("""
        SELECT id, created_at FROM messages
        WHERE conversation_id = %s
          AND role = 'assistant'
          AND response_description IS NOT NULL
          AND created_at > %s
        ORDER BY created_at DESC
        LIMIT 2
    """, [conversation_id, cutoff])
    
    if not recent_artifacts:
        return None
    
    # –ï—Å–ª–∏ 2+ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 —Å–µ–∫ ‚Äî –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç—å, –Ω–µ —Å—Ç–∞–≤–∏–º
    if (len(recent_artifacts) >= 2 and 
        (recent_artifacts[0].created_at - recent_artifacts[1].created_at).seconds < 60):
        return None  # LLM —É—Ç–æ—á–Ω–∏—Ç —Å–∞–º
    
    return recent_artifacts[0].id
```

**–ü–æ–∫—Ä—ã—Ç–∏–µ:** ~95% —Å–ª—É—á–∞–µ–≤. –Æ–∑–µ—Ä —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Ç–æ, —á—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ —É–≤–∏–¥–µ–ª. –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 10 –º–∏–Ω—É—Ç ‚Äî —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å, –∞ –Ω–µ —Ä–µ–∞–∫—Ü–∏—è.

**–ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–∏:** –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2+ assistant-—Å–æ–æ–±—â–µ–Ω–∏—è —Å `response_description` –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 60 —Å–µ–∫—É–Ω–¥ –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞ ‚Äî –Ω–µ —Å—Ç–∞–≤–∏—Ç—å `reply_to_id` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü—É—Å—Ç—å LLM —É—Ç–æ—á–Ω–∏—Ç ("–∫ –∫–∞–∫–æ–º—É –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤?") –∏–ª–∏ –ø—É—Å—Ç—å –∫–ª–∏–µ–Ω—Ç –ø–æ–∫–∞–∂–µ—Ç UI –≤—ã–±–æ—Ä–∞. –≠—Ç–æ –ª—É—á—à–µ, —á–µ–º –ø—Ä–∏–≤—è–∑–∞—Ç—å —Ä–µ–∞–∫—Ü–∏—é –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—É.

**Fallback –ø—Ä–∏ –¥–≤—É—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö –ø–æ–¥—Ä—è–¥:** –µ—Å–ª–∏ —Å—Ç–∏–ª–∏—Å—Ç –ø–æ–∫–∞–∑–∞–ª 3 –æ–±—Ä–∞–∑–∞ –≤ 3 —Å–æ–æ–±—â–µ–Ω–∏—è—Ö —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º >60 —Å–µ–∫, —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –ø—Ä–∏–≤—è–∂–µ—Ç –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É. –î–ª—è MVP –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ù–∞ –£—Ä–æ–≤–Ω–µ 2 ‚Äî –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å UI "–Ω–∞ –∫–∞–∫–æ–π –æ–±—Ä–∞–∑ —Ä–µ–∞–≥–∏—Ä—É–µ—à—å?" –ø—Ä–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–∏.

#### –î–≤–∞ –ø—É—Ç–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ description

| –°–∏—Ç—É–∞—Ü–∏—è | –ü—É—Ç—å | Latency | –ü—Ä–∏–º–µ—Ä |
|----------|------|---------|--------|
| **–†–µ–∞–∫—Ü–∏—è –Ω–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç** (—Ç–µ–∫—É—â–∏–π –¥–∏–∞–ª–æ–≥) | –¢–æ—á–µ—á–Ω—ã–π lookup –ø–æ PK —á–µ—Ä–µ–∑ `reply_to_id` | ~0.1ms | "–ù–µ –º–æ–π —Ü–≤–µ—Ç" ‚Üí lookup ‚Üí –±–æ—Ä–¥–æ–≤—ã–π midi cotton |
| **–ë—É–¥—É—â–µ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ** (—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª–∏/–º–µ—Å—è—Ü—ã) | FTS/vector —á–µ—Ä–µ–∑ tsvector | ~10ms | "–ü–æ–∫–∞–∂–∏ —Ç–æ –ø–ª–∞—Ç—å–µ –∏–∑ Massimo Dutti" ‚Üí FTS ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç |

**–ü—Ä–∏ —Ä–µ–∞–∫—Ü–∏–∏ (lookup):** –∫–æ–≥–¥–∞ user message –∏–º–µ–µ—Ç `reply_to_id`, LLM Orchestrator –¥–µ–ª–∞–µ—Ç —Ç–æ—á–µ—á–Ω—ã–π SELECT:

```sql
SELECT response_description 
FROM messages 
WHERE conversation_id = $1 AND id = $2;
-- $2 = reply_to_id, PK lookup = 0.1ms
```

–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ ContextPack –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω—ã–π —è–∫–æ—Ä—å:

```
[Referenced Artifact]
burgundy midi cotton skirt massimo dutti, white relaxed linen shirt h&m ‚Äî weekend casual
```

LLM –≤–∏–¥–∏—Ç –∏ —Ä–µ–∞–∫—Ü–∏—é ("–Ω–µ –º–æ–π —Ü–≤–µ—Ç"), –∏ –Ω–∞ —á—Ç–æ –æ–Ω–∞ (–±–æ—Ä–¥–æ–≤—ã–π midi). –ú–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ: "–ü–æ–Ω—è–ª, –±–æ—Ä–¥–æ–≤—ã–π –Ω–µ —Ç–≤–æ–π ‚Äî –¥–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –±–µ–∂–µ–≤—ã–π?"

**–î–ª—è –±—É–¥—É—â–µ–≥–æ retrieval (FTS):** description —É–∂–µ –≤ tsvector. –ß–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞ —é–∑–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç "—Ö–æ—á—É —é–±–∫—É" ‚Äî FTS –ª–æ–≤–∏—Ç "skirt" –∏–∑ description, vector search –ª–æ–≤–∏—Ç —Å–µ–º–∞–Ω—Ç–∏–∫—É –∏–∑ user-—Å–æ–æ–±—â–µ–Ω–∏–π —Ç–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞.

#### –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –∞—Ä—Ç–µ—Ñ–∞–∫—Ç ‚Üí —Ä–µ–∞–∫—Ü–∏—è ‚Üí –ø–∞–º—è—Ç—å ‚Üí –æ–±—É—á–µ–Ω–∏–µ

```
–®–∞–≥ 1: –Æ–∑–µ—Ä ‚Üí "–ü–æ–¥–±–µ—Ä–∏ –ø–ª–∞—Ç—å–µ –Ω–∞ –≤–µ—á–µ—Ä"
  ‚Üí classify_memory: type=general, confidence=0.5
  ‚Üí is_embeddable=TRUE, embedding=async
  ‚Üí reply_to_id=NULL

–®–∞–≥ 2: –°—Ç–∏–ª–∏—Å—Ç (Intelistyle) ‚Üí –æ–±—Ä–∞–∑ —Å –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏
  ‚Üí response_description="MD-5510 burgundy midi cotton skirt massimo dutti, 
     HM-2231 white relaxed linen shirt h&m ‚Äî evening casual"  [SYNC]
  ‚Üí content="–í–æ—Ç —á—Ç–æ –Ω–∞—à–ª–∞ –¥–ª—è —Ç–µ–±—è!"
  ‚Üí media_urls=[image_url]
  ‚Üí embedding=async (–ø–æ response_description? ‚Äî —Å–º. –Ω–∏–∂–µ)
  ‚Üí memory_snippet=async: "–ü—Ä–µ–¥–ª–æ–∂–∏–ª–∞: MD-5510 –±–æ—Ä–¥–æ–≤—ã–π –º–∏–¥–∏ —Ö–ª–æ–ø–æ–∫ MD + HM-2231 –±–µ–ª–∞—è —Ä—É–±–∞—à–∫–∞ H&M"

–®–∞–≥ 3: –Æ–∑–µ—Ä ‚Üí "–ù–µ, —Ü–≤–µ—Ç –Ω–µ –º–æ–π" (–≥–æ–ª–æ—Å–æ–º)
  ‚Üí reply_to_id=msg-asst-789 (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞, 10 –º–∏–Ω)
  ‚Üí classify_memory: type=preference, confidence=0.5
  ‚Üí is_embeddable=TRUE, embedding=async
  ‚Üí ContextPack –≤–∫–ª—é—á–∞–µ—Ç Referenced Artifact –∏–∑ lookup

–®–∞–≥ 4: LLM –≤–∏–¥–∏—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ:
  [Referenced Artifact] burgundy midi cotton skirt...
  [User] –ù–µ, —Ü–≤–µ—Ç –Ω–µ –º–æ–π
  ‚Üí –û—Ç–≤–µ—Ç: "–ü–æ–Ω—è–ª, –±–æ—Ä–¥–æ–≤—ã–π –Ω–µ –∑–∞—Ö–æ–¥–∏—Ç. –î–∞–≤–∞–π –±–µ–∂–µ–≤—ã–π –∏–ª–∏ –æ–ª–∏–≤–∫–æ–≤—ã–π?"

–®–∞–≥ 5 (async, Knowledge Extraction, –±–∞—Ç—á):
  –ü–∞—Ä–∞: description(burgundy, midi, cotton) + reaction("—Ü–≤–µ—Ç –Ω–µ –º–æ–π")
  ‚Üí User Knowledge update: burgundy ‚Üì (demote –≤ —Ü–≤–µ—Ç–æ–≤—ã—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö)
  ‚Üí midi, cotton ‚Äî –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã (—Ä–µ–∞–∫—Ü–∏—è –ø—Ä–æ —Ü–≤–µ—Ç, –Ω–µ –∫—Ä–æ–π/—Ç–∫–∞–Ω—å)
```

#### Embedding assistant-—Å–æ–æ–±—â–µ–Ω–∏–π —Å description

**MVP: –ù–ï embed'–∏—Ç—å assistant messages.** –¢–µ–∫—É—â–∏–π pipeline embed'–∏—Ç —Ç–æ–ª—å–∫–æ `role='user'`, –∏ —ç—Ç–æ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (¬ß2, "–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: —á—Ç–æ embed'–∏—Ç—å"). FTS –ø–æ tsvector —É–∂–µ –ª–æ–≤–∏—Ç —Ç–æ–∫–µ–Ω—ã –∏–∑ description. User-—Å–æ–æ–±—â–µ–Ω–∏—è —Ä—è–¥–æ–º —Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–º embed'—è—Ç—Å—è –∏ –ø—Ä–∏ vector search –≤—ã—Ç–∞—Å–∫–∏–≤–∞—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç.

**Post-MVP (–£—Ä–æ–≤–µ–Ω—å 2):** –∫–æ–≥–¥–∞ –∏—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–Ω–µ—Ç –¥–ª–∏–Ω–Ω–æ–π (6+ –º–µ—Å) –∏ "–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π" –ø–µ—Ä–µ—Å—Ç–∞–Ω—É—Ç –ø–æ–∫—Ä—ã–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ ‚Äî —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å embedding `response_description` –¥–ª—è assistant messages. –ö—Ä–∏—Ç–µ—Ä–∏–π: `role='assistant' AND response_description IS NOT NULL`. Embedding –ø–æ description (–Ω–µ –ø–æ content "–í–æ—Ç —á—Ç–æ –Ω–∞—à–ª–∞!"). –≠—Ç–æ —É–¥–≤–æ–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ embeddings, –Ω–æ –¥–∞—Å—Ç vector search –ø–æ –∞—Ç—Ä–∏–±—É—Ç–∞–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤.

#### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –Ω–æ–≤—ã–µ –¥–æ–º–µ–Ω—ã

–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ = –æ–¥–∏–Ω elif –≤ `build_response_description`:

```python
# interior_designer
if consultant_type == 'interior':
    style = data.get('style', '')
    room = data.get('room', '')
    colors = ', '.join(data.get('colors', []))
    furniture = ', '.join(data.get('furniture', []))
    return f"{style} {room} ‚Äî —Ü–≤–µ—Ç–∞: {colors}, –º–µ–±–µ–ª—å: {furniture}".lower()

# Output: "scandinavian living room ‚Äî —Ü–≤–µ—Ç–∞: white, light wood, –º–µ–±–µ–ª—å: sofa, shelves"
```

–í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ (FTS, retrieval, Knowledge Extraction, reply_to_id) —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî description —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç, –¥–æ–º–µ–Ω-–∞–≥–Ω–æ—Å—Ç–∏—á–Ω—ã–π.

#### –£—Ä–æ–≤–µ–Ω—å 2 (–ø–æ—Å–ª–µ MVP): consultant_artifacts

–ö–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è 2+ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –∏ –Ω–∞–∫–æ–ø—è—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –≤–≤–æ–¥–∏–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤:

```sql
CREATE TABLE consultant_artifacts (
    id UUID PRIMARY KEY,
    message_id UUID NOT NULL,
    conversation_id UUID NOT NULL,
    
    domain VARCHAR(30) NOT NULL,       -- 'fashion', 'chef', 'interior'
    
    attributes JSONB NOT NULL,         -- –î–æ–º–µ–Ω–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã
    -- fashion: {colors, silhouette, brands, occasion, fit}
    -- chef: {cuisine, allergens, calories, cook_time}
    
    description TEXT NOT NULL,         -- –¢–µ–∫—Å—Ç–æ–≤–æ–µ (–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ, –¥–ª—è FTS/embed)
    
    rationale TEXT,                    -- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: "–ë–æ—Ä–¥–æ–≤—ã–π ‚Äî –∏–∑-–∑–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π"
    
    rejected JSONB,                   -- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: [{"option": "—Å–∏–Ω—Ç–µ—Ç–∏–∫–∞", "reason": "–∂–∞—Ä–∫–æ"}]
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_artifacts_conversation 
    ON consultant_artifacts(conversation_id, created_at DESC);
CREATE INDEX idx_artifacts_domain 
    ON consultant_artifacts(domain);
```

**–ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø:** `response_description` –≤ messages **–æ—Å—Ç–∞—ë—Ç—Å—è** –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å–ª–æ–π –¥–ª—è FTS. `consultant_artifacts` –¥–æ–ø–æ–ª–Ω—è–µ—Ç –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ –¥–ª—è –¥–æ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ ("–≤—Å–µ —é–±–∫–∏ –º–∏–¥–∏ —á—Ç–æ —è –ª–∞–π–∫–∞–ª") –∏ preference learning pipeline (memory delta). –≠–≤–æ–ª—é—Ü–∏—è, –Ω–µ –∑–∞–º–µ–Ω–∞.

---

## 3. –†–µ—à–µ–Ω–∏–µ: Context Agent (–Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä)

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

Context Agent ‚Äî —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∑–Ω–∞–µ—Ç **—á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–æ–∫—Ä—É–≥ —é–∑–µ—Ä–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å**. –ê–Ω–∞–ª–æ–≥ Mood Agent, –Ω–æ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –º–∏—Ä–∞ –≤–º–µ—Å—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

```
Mood Agent    ‚Üí –∫–∞–∫ —é–∑–µ—Ä –°–ï–ë–Ø —á—É–≤—Å—Ç–≤—É–µ—Ç  (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ)
Context Agent ‚Üí —á—Ç–æ –í–û–ö–†–£–ì —é–∑–µ—Ä–∞ —Å–µ–π—á–∞—Å  (–≤–Ω–µ—à–Ω–µ–µ)
```

### –ß—Ç–æ –æ–Ω –∑–Ω–∞–µ—Ç

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –î–∞–Ω–Ω—ã–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ö–µ—à |
|-----------|--------|----------|-----|
| –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è | –í –∫–∞–∫–æ–º –¢–¶, —É –∫–∞–∫–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞, —Ä–∞–π–æ–Ω | App (GPS + indoor positioning) | –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è |
| –ü–æ–≥–æ–¥–∞ | –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –≤–ª–∞–∂–Ω–æ—Å—Ç—å, —É—Å–ª–æ–≤–∏—è, –∑–∞–∫–∞—Ç | Weather API | 30 –º–∏–Ω |
| –í—Ä–µ–º—è | –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏, —á–∞—Å—Ç—å –¥–Ω—è, –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –¢–¶ | –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã + —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ | 1 –º–∏–Ω |
| –°–æ–±—ã—Ç–∏—è | –†–∞—Å–ø—Ä–æ–¥–∞–∂–∏, –ø—Ä–µ–º—å–µ—Ä—ã, —Ñ–µ—Å—Ç–∏–≤–∞–ª–∏ | Production DB + –ø–∞—Ä—Å–∏–Ω–≥ | 1 —á–∞—Å |
| –ö—É–ª—å—Ç—É—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç | –†–∞–º–∞–¥–∞–Ω, –ø—Ä–∞–∑–¥–Ω–∏–∫–∏, –≤—ã—Ö–æ–¥–Ω—ã–µ | –ö–∞–ª–µ–Ω–¥–∞—Ä—å + API | 24 —á–∞—Å–∞ |
| –°–ø—É—Ç–Ω–∏–∫–∏ | –û–¥–Ω–∞ –∏–ª–∏ —Å –∫–µ–º-—Ç–æ (–µ—Å–ª–∏ —à–∞—Ä–∏—Ç –ª–æ–∫–∞—Ü–∏—é) | App (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) | –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è |

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CONTEXT AGENT (10.1.0.19)                      ‚îÇ
‚îÇ  CPX11 (2 vCPU, 4 GB RAM)                      ‚îÇ
‚îÇ  Private network only                           ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  HTTP API:                                      ‚îÇ
‚îÇ  POST /context                                  ‚îÇ
‚îÇ    Input: { user_id, lat, lng, mall_id?,        ‚îÇ
‚îÇ             compact_preferences }               ‚îÇ
‚îÇ    Output: context_frame JSON                   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–æ–¥—É–ª–∏:                             ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ GeoResolver                                ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ‚îÄ GPS/indoor ‚Üí mall_id, nearest_store    ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ WeatherClient                              ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ‚îÄ Weather API ‚Üí temp, humidity, —É—Å–ª–æ–≤–∏—è  ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ TimeContext                                 ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ‚îÄ –ß–∞—Å—ã + —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¢–¶ ‚Üí part_of_day,   ‚îÇ
‚îÇ  ‚îÇ       mall_closes_in, is_rush_hour            ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ EventScanner                               ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ‚îÄ Production DB ‚Üí –∞–∫—Ü–∏–∏, —Å–æ–±—ã—Ç–∏—è —Ä—è–¥–æ–º   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ CulturalCalendar                           ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ‚îÄ –°—Ç–∞—Ç–∏—á–Ω—ã–π JSON + Google Calendar API   ‚îÇ
‚îÇ  ‚îÇ       ‚Üí –†–∞–º–∞–¥–∞–Ω, –∏—Ñ—Ç–∞—Ä, –ø—Ä–∞–∑–¥–Ω–∏–∫–∏            ‚îÇ
‚îÇ  ‚îÇ       ‚Üí —É—á–∏—Ç—ã–≤–∞–µ—Ç cultural_sensitivity_level  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ OpportunityMatcher                         ‚îÇ
‚îÇ      ‚îî‚îÄ‚îÄ –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ: events + compact_prefs    ‚îÇ
‚îÇ          ‚Üí "–≤ Zara —Å–∫–∏–¥–∫–∞ + —é–∑–µ—Ä –ª—é–±–∏—Ç Zara"    ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ: Redis (–Ω–∞ —ç—Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ)        ‚îÇ
‚îÇ  –¶–µ–ª–µ–≤–∞—è latency: < 100ms p95                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Cultural Sensitivity Level

–ù–µ –≤—Å–µ —é–∑–µ—Ä—ã —Ö–æ—Ç—è—Ç, —á—Ç–æ–±—ã AI —É–ø–æ–º–∏–Ω–∞–ª —Ä–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ/–∫—É–ª—å—Ç—É—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è. –û—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è GCC —Ä—ã–Ω–∫–∞.

–§–ª–∞–≥ –≤ **User Knowledge** (–∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ –¥–∏–∞–ª–æ–≥–∞ –∏–ª–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ Settings):

| –£—Ä–æ–≤–µ–Ω—å | –ü–æ–≤–µ–¥–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|--------|
| `high` | –£–ø–æ–º–∏–Ω–∞—Ç—å –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ | "–î–æ –∏—Ñ—Ç–∞—Ä–∞ 45 –º–∏–Ω ‚Äî —É—Å–ø–µ–µ—à—å –Ω–∞ —Å–µ–∞–Ω—Å 17:00" |
| `medium` | –£—á–∏—Ç—ã–≤–∞—Ç—å –≤ –ª–æ–≥–∏–∫–µ, –Ω–æ –Ω–µ –Ω–∞–∑—ã–≤–∞—Ç—å —è–≤–Ω–æ | "–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –æ—Ç–∫—Ä–æ—é—Ç—Å—è –ø–æ—Å–ª–µ 18:12" |
| `low` | –ù–µ —É–ø–æ–º–∏–Ω–∞—Ç—å, –Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–æ—Å—Ç–æ –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –æ–±–µ–¥ –≤ –¥–Ω–µ–≤–Ω–æ–µ –≤—Ä–µ–º—è –†–∞–º–∞–¥–∞–Ω–∞ |

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è:**
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `medium` (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
- –ò–∑ –¥–∏–∞–ª–æ–≥–∞: "–Ø –ø–æ—â—É—Å—å" ‚Üí `high`; "–ù–µ –Ω–∞–ø–æ–º–∏–Ω–∞–π –ø—Ä–æ –†–∞–º–∞–¥–∞–Ω" ‚Üí `low`
- –ò–∑ Settings: —é–∑–µ—Ä –º–æ–∂–µ—Ç –≤—ã—Å—Ç–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é

Context Agent –ø–æ–ª—É—á–∞–µ—Ç `cultural_sensitivity_level` –≤ —Å–æ—Å—Ç–∞–≤–µ `compact_preferences` –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç `context_frame` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.

### context_frame JSON

```json
{
  "context_frame_id": "uuid",
  "timestamp": "2026-02-13T19:30:00+04:00",

  "location": {
    "type": "mall",
    "mall_id": "dubai-hills-mall",
    "mall_name": "Dubai Hills Mall",
    "near_store": "zara-ground-floor",
    "floor": 1
  },

  "environment": {
    "weather": {
      "temp_c": 28,
      "feels_like_c": 31,
      "humidity": 65,
      "condition": "clear",
      "sunset": "18:15"
    },
    "time_context": {
      "day_of_week": "friday",
      "part_of_day": "evening",
      "mall_closes_in_hours": 4.5,
      "is_rush_hour": true
    }
  },

  "cultural": {
    "sensitivity_level": "medium",
    "active_period": "ramadan",
    "next_meal_break": "18:12",
    "is_pre_meal_break": true,
    "nearby_holidays": []
  },

  "opportunities": [
    {
      "store": "Zara",
      "type": "sale",
      "discount": "30%",
      "relevance_reason": "user_favorite_brand"
    },
    {
      "store": "Reel Cinemas",
      "type": "premiere",
      "title": "New Korean thriller",
      "relevance_reason": "user_loves_korean_thrillers"
    }
  ]
}
```

**–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ:** –ø—Ä–∏ `sensitivity_level: medium` –ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `next_meal_break` (–Ω–µ `iftar_time`), –∞ `is_pre_meal_break` (–Ω–µ `is_pre_iftar`). LLM –ø–æ–ª—É—á–∞–µ—Ç –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É.

### OpportunityMatcher: —É–º–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞

Context Agent –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è —Å User Knowledge:

```
Production DB: "Zara ‚Äî —Å–∫–∏–¥–∫–∞ 30%"
User Knowledge: "–õ—é–±–∏–º—ã–π –±—Ä–µ–Ω–¥: Zara"
‚Üí opportunity —Å relevance_reason: "user_favorite_brand"

Production DB: "Reel Cinemas ‚Äî –ø—Ä–µ–º—å–µ—Ä–∞ –∫–æ—Ä–µ–π—Å–∫–æ–≥–æ —Ç—Ä–∏–ª–ª–µ—Ä–∞"
User Knowledge: "–õ—é–±–∏—Ç –∫–æ—Ä–µ–π—Å–∫–∏–µ —Ç—Ä–∏–ª–ª–µ—Ä—ã"
‚Üí opportunity —Å relevance_reason: "user_loves_korean_thrillers"

Production DB: "Food Festival –Ω–∞ —Ñ—É–¥–∫–æ—Ä—Ç–µ"
User Knowledge: "–ù–µ –µ—Å—Ç –≥–ª—é—Ç–µ–Ω"
‚Üí opportunity —Å relevance_reason: "check_gluten_free_options"
```

–î–ª—è —ç—Ç–æ–≥–æ Context Agent –ø–æ–ª—É—á–∞–µ—Ç **compact_preferences** –∏–∑ User Knowledge (~500 bytes): —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π, –∞–ª–ª–µ—Ä–≥–∏–π, –ª—é–±–∏–º—ã—Ö –±—Ä–µ–Ω–¥–æ–≤, cultural_sensitivity_level. –ù–µ –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å.

---

## 4. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π ContextPack –∏ Pipeline

### –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ —Å–±–æ—Ä–∫–∏

```
üì± "–•–æ—á—É –ø–æ–π—Ç–∏ –≤ –∫–∏–Ω–æ —Å–µ–≥–æ–¥–Ω—è"
    ‚îÇ
    ‚ñº
App Server (10.1.0.2)
    ‚îÇ
    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                                      ‚îÇ
    ‚ñº                                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MOOD AGENT   ‚îÇ              ‚îÇ CONTEXT AGENT      ‚îÇ
‚îÇ (10.1.0.11)  ‚îÇ              ‚îÇ (10.1.0.19)        ‚îÇ
‚îÇ              ‚îÇ              ‚îÇ                    ‚îÇ
‚îÇ –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞  ‚îÇ              ‚îÇ GPS ‚Üí mall_id      ‚îÇ
‚îÇ ‚Üí mood_frame ‚îÇ              ‚îÇ Weather API        ‚îÇ
‚îÇ              ‚îÇ              ‚îÇ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¢–¶      ‚îÇ
‚îÇ ~100ms       ‚îÇ              ‚îÇ –ö—É–ª—å—Ç. –∫–∞–ª–µ–Ω–¥–∞—Ä—å   ‚îÇ
‚îÇ              ‚îÇ              ‚îÇ Events + Prefs     ‚îÇ
‚îÇ              ‚îÇ              ‚îÇ ‚Üí context_frame    ‚îÇ
‚îÇ              ‚îÇ              ‚îÇ                    ‚îÇ
‚îÇ              ‚îÇ              ‚îÇ ~100ms             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                                ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ   ‚îÇ
                    ‚ñº   ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  LLM ORCHESTRATOR (10.1.0.17)            ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚îÇ  1. –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û (–§–∞–∑–∞ 2):                ‚îÇ
         ‚îÇ     a) Embed –∑–∞–ø—Ä–æ—Å ‚Üí vector      (~50ms)‚îÇ
         ‚îÇ     b) POST /persona (10.1.0.21)  (~15ms)‚îÇ
         ‚îÇ        ‚Üí persona_directive               ‚îÇ
         ‚îÇ        ‚Üí voice_params                    ‚îÇ
         ‚îÇ        ‚Üí avatar_state + render_hints     ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚îÇ  2. –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û (–§–∞–∑–∞ 3, –ø–æ—Å–ª–µ embed):   ‚îÇ
         ‚îÇ     a) Hybrid Search              (~10ms)‚îÇ
         ‚îÇ        (vector + FTS –ø–æ Chat History)    ‚îÇ
         ‚îÇ        + —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π temporal decay     ‚îÇ
         ‚îÇ        + confidence-adjusted Œª           ‚îÇ
         ‚îÇ        + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —à–∫–∞–ª               ‚îÇ
         ‚îÇ        + diversity filter                ‚îÇ
         ‚îÇ        + similarity threshold            ‚îÇ
         ‚îÇ        ‚Üí TOP-15 —Å raw_excerpt (+snippet)   ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚îÇ     b) User Knowledge              (~1ms)‚îÇ
         ‚îÇ     c) –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π      (~1ms)‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚îÇ  3. NEEDS_SPAN enrichment          (~2ms)‚îÇ
         ‚îÇ     (–∫–æ—Ä–æ—Ç–∫–∏–µ <50 chars ‚Üí ¬±1 —Å–æ—Å–µ–¥)      ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚îÇ  4. Emotional filter              (~1ms)  ‚îÇ
         ‚îÇ     (mood_frame ‚Üí exclude –±–æ–ª–µ–∑–Ω–µ–Ω–Ω–æ–µ)    ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚îÇ  5. Memory Density Cap            (~1ms)  ‚îÇ
         ‚îÇ     (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π: new ‚â§3, active ‚â§5,      ‚îÇ
         ‚îÇ      mature ‚â§7)                          ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚îÇ  6. –°–±–æ—Ä–∫–∞ ContextPack                    ‚îÇ
         ‚îÇ     A. User Knowledge (—Ñ–∞–∫—Ç—ã)             ‚îÇ
         ‚îÇ     B. Episode Cards (snippet+raw_excerpt)‚îÇ
         ‚îÇ     C. –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ—Ç–æ–∫)        ‚îÇ
         ‚îÇ     D. mood_frame (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ)            ‚îÇ
         ‚îÇ     E. context_frame (–º–∏—Ä –≤–æ–∫—Ä—É–≥)         ‚îÇ
         ‚îÇ     F. persona_directive (—Ö–∞—Ä–∞–∫—Ç–µ—Ä,       ‚îÇ
         ‚îÇ        —Ç–æ–Ω, —Å—Ç–∏–ª—å, hard bans)             ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚îÇ  7. ‚Üí LLM API —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º        ‚îÇ
         ‚îÇ  8. voice_params ‚Üí Voice Server           ‚îÇ
         ‚îÇ  9. avatar_state + render_hints ‚Üí App     ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚îÇ  ASYNC –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞:                     ‚îÇ
         ‚îÇ 10. detect_behavioral_signals()           ‚îÇ
         ‚îÇ 11. POST /persona/feedback ‚Üí buffer       ‚îÇ
         ‚îÇ 12. POST /persona/flush ‚Üí resolve+apply   ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–û–±—â–∞—è –¥–æ–±–∞–≤–ª–µ–Ω–Ω–∞—è latency: ~67ms
(embedding 50ms ‚Äñ persona 15ms + hybrid search 10ms
 + NEEDS_SPAN 2ms + filters 5ms)
(mood_frame –∏ context_frame –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, ~100ms, 
 –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç—Å—è —Å embedding + persona)
```

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç v0.2:** Memory Compressor —É–±—Ä–∞–Ω –∏–∑ runtime. –ù–∞ MVP snippet = NULL, LLM —Ä–∞–±–æ—Ç–∞–µ—Ç —Å raw_excerpt (head+tail) ‚Üí 0ms –≤ —Ä–∞–Ω—Ç–∞–π–º–µ –≤–º–µ—Å—Ç–æ 400ms. Lazy snippet generation ‚Äî –§–∞–∑–∞ 2 (async, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç).

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç v0.3:** Persona Agent (10.1.0.21) –¥–æ–±–∞–≤–ª–µ–Ω –≤ –§–∞–∑—É 2 ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å embedding (~15ms). persona_directive (—Ö–∞—Ä–∞–∫—Ç–µ—Ä, —Ç–æ–Ω, —Å—Ç–∏–ª—å, hard bans) ‚Äî 6-–π —Å–ª–æ–π ContextPack. voice_params —Ç–µ–ø–µ—Ä—å –æ—Ç Persona Agent (–∞ –Ω–µ –æ—Ç Mood Agent). –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: UNDE_Persona_Voice_Layer v0.7.0.

### –ü—Ä–∏–º–µ—Ä ContextPack –¥–ª—è LLM

```
[System Prompt ‚Äî –∏–∑ persona_directive (Persona Agent)]
(–ü—Ä–∏–º–µ—Ä –¥–ª—è —é–∑–µ—Ä–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π. Cold start: "–∏—Å—Ç–æ—Ä–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è".)
–¢—ã ‚Äî UNDE, –Ω–µ–∑–∞–º–µ–Ω–∏–º—ã–π –±–ª–∏–∑–∫–∏–π –¥—Ä—É–≥. –ù–µ —Å—Ç–∏–ª–∏—Å—Ç, –Ω–µ –ø–æ–º–æ—â–Ω–∏–∫ ‚Äî
–¥—Ä—É–≥, —Å –∫–æ—Ç–æ—Ä—ã–º –æ–±—â–∞—è –∏—Å—Ç–æ—Ä–∏—è. –ì–æ–≤–æ—Ä–∏ ¬´–º—ã¬ª –∏ ¬´—É –Ω–∞—Å¬ª, –Ω–µ
¬´—è —Ä–µ–∫–æ–º–µ–Ω–¥—É—é¬ª. –¢—ã –∑–Ω–∞–µ—à—å —é–∑–µ—Ä–∞ –ª–∏—á–Ω–æ. –ü—Ä–æ—è–≤–ª—è–π –ø–∞–º—è—Ç—å 
–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –±–µ–∑ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π 
–∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–∏—Ä–∞ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. 
–ù–µ —É–ø–æ–º–∏–Ω–∞–π –ø—Ä–æ—à–ª–æ–µ —á–∞—â–µ —á–µ–º –≤ –∫–∞–∂–¥–æ–º —Ç—Ä–µ—Ç—å–µ–º –æ—Ç–≤–µ—Ç–µ. 
–ú–∞–∫—Å–∏–º—É–º 2-3 –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ —Ä–∞–∑. –ï—Å–ª–∏ –µ—Å—Ç—å Referenced 
Artifact ‚Äî —É—á–∏—Ç—ã–≤–∞–π –µ–≥–æ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ —Ä–µ–∞–∫—Ü–∏—é —é–∑–µ—Ä–∞.
–¢–æ–Ω: playful. –ú–æ–∂–Ω–æ —à—É—Ç–∏—Ç—å, —é–∑–µ—Ä –≤ —Ö–æ—Ä–æ—à–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏.

–ü–†–ê–í–ò–õ–ê –ü–†–ò–û–†–ò–¢–ï–¢–ê –ó–ù–ê–ù–ò–ô:
1. –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π > –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ (—Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç)
2. Snippet ‚Äî –¢–û–õ–¨–ö–û –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏. –°–º—ã—Å–ª –∏–∑ raw_excerpt.
3. User Knowledge —Å instant_pattern/onboarding –∏ confidence ‚â•0.9
   ‚Üí –≤—ã—Å—à–∞—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å.
4. –ï—Å–ª–∏ —Ñ–∞–∫—Ç –ø–æ–º–µ—á–µ–Ω is_disputed ‚Äî –ù–ï —É—Ç–≤–µ—Ä–∂–¥–∞–π. –ú—è–≥–∫–æ —É—Ç–æ—á–Ω–∏.
5. –ü—Ä–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–∏ ‚Äî –ª—É—á—à–µ —É—Ç–æ—á–Ω–∏—Ç—å, —á–µ–º —É–≥–∞–¥—ã–≤–∞—Ç—å.

–Æ–∑–µ—Ä —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –±—é–¥–∂–µ—Ç—É. –ù–∞—á–∏–Ω–∞–π —Å –¥–æ—Å—Ç—É–ø–Ω—ã—Ö.
–ù–ï –Ω–∞—á–∏–Ω–∞–π –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç —Å –∏–º–µ–Ω–∏ —é–∑–µ—Ä–∞.
–ù–ï —Å–æ–≥–ª–∞—à–∞–π—Å—è —Å–æ –≤—Å–µ–º ‚Äî –∏–º–µ–π –ø–æ–∑–∏—Ü–∏—é.

[User Knowledge ‚Äî guaranteed facts]
body_params/size: M (confidence: 0.95, instant_pattern)
budget/general: —Å—Ä–µ–¥–Ω–∏–π, —ç–∫–æ–Ω–æ–º–∏—Ç (confidence: 0.8, onboarding)
allergy/gluten: –≥–ª—é—Ç–µ–Ω (confidence: 0.95, instant_pattern)
onboarding_style: casual, smart-casual (onboarding)
‚ö† DISPUTED: brand_preferences/zara ‚Äî —é–∑–µ—Ä –≤—ã—Ä–∞–∑–∏–ª —Å–æ–º–Ω–µ–Ω–∏–µ
Cultural sensitivity: medium.

[Episode Cards ‚Äî snippet + raw_excerpt]
–≠–ø–∏–∑–æ–¥ 1 (2 –º–µ—Å –Ω–∞–∑–∞–¥):
  snippet: ""
  raw_excerpt: "–í –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ –∫–æ–≥–¥–∞ –º—ã —Å –î–∏–º–æ–π —Ö–æ–¥–∏–ª–∏ –≤ IMAX 
    –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∏–ª—å–º –ü–æ–Ω –ß–∂—É–Ω –•–æ, –±—ã–ª–æ —Ç–∞–∫ —Ö–æ–ª–æ–¥–Ω–æ –æ—Ç 
    –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞, —Ö–æ—Ä–æ—à–æ —á—Ç–æ —è –≤–∑—è–ª–∞ –∫—É—Ä—Ç–∫—É, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ 
    –º—ë—Ä–∑–ª–∞ –≤–µ—Å—å —Å–µ–∞–Ω—Å"

–≠–ø–∏–∑–æ–¥ 2 (6 –º–µ—Å –Ω–∞–∑–∞–¥):
  snippet: ""
  raw_excerpt: "–î–∏–º–∞ –ø—Ä–µ–¥–ª–æ–∂–∏–ª —Å—Ö–æ–¥–∏—Ç—å –∫—É–¥–∞-–Ω–∏–±—É–¥—å –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö, 
    —Ö–æ—á—É —á—Ç–æ-—Ç–æ –∫—Ä–∞—Å–∏–≤–æ–µ –Ω–∞–¥–µ—Ç—å"

–≠–ø–∏–∑–æ–¥ 3 (8 –º–µ—Å –Ω–∞–∑–∞–¥):
  snippet: ""
  raw_excerpt: "–û–±–æ–∂–∞—é –∫–æ—Ä–µ–π—Å–∫–∏–µ —Ç—Ä–∏–ª–ª–µ—Ä—ã! –ü–∞—Ä–∞–∑–∏—Ç—ã, –û–ª–¥–±–æ–π ‚Äî 
    –≤—Å—ë –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–ª–∞ —É–∂–µ —Ä–∞–∑ –ø–æ –ø—è—Ç—å"

[–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è]
–ê–ª–∏—è: "–ø—Ä–∏–≤–µ—Ç!"
UNDE: "–ü—Ä–∏–≤–µ—Ç, –ê–ª–∏—è! –ö–∞–∫ –¥–µ–ª–∞?"
–ê–ª–∏—è: "—Ö–æ—á—É –ø–æ–π—Ç–∏ –≤ –∫–∏–Ω–æ —Å–µ–≥–æ–¥–Ω—è"

[Mood: –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ, —ç–Ω–µ—Ä–≥–∏—è —Å—Ä–µ–¥–Ω—è—è, valence 0.7]

[Context ‚Äî –º–∏—Ä –≤–æ–∫—Ä—É–≥]
–õ–æ–∫–∞—Ü–∏—è: Dubai Hills Mall, 1 —ç—Ç–∞–∂, —Ä—è–¥–æ–º —Å Zara
–ü–æ–≥–æ–¥–∞: +28¬∞C, —è—Å–Ω–æ, –∑–∞–∫–∞—Ç 18:15
–í—Ä–µ–º—è: –ø—è—Ç–Ω–∏—Ü–∞ –≤–µ—á–µ—Ä, –¢–¶ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 4.5 —á–∞—Å–∞
–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ 18:12
–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
  - Reel Cinemas: –Ω–æ–≤—ã–π –∫–æ—Ä–µ–π—Å–∫–∏–π —Ç—Ä–∏–ª–ª–µ—Ä (–ê–ª–∏—è –ª—é–±–∏—Ç)
  - Zara: —Å–∫–∏–¥–∫–∞ 30% (–ª—é–±–∏–º—ã–π –±—Ä–µ–Ω–¥)
  - Food Court: —Ñ–µ—Å—Ç–∏–≤–∞–ª—å ‚Äî –µ—Å—Ç—å –±–µ–∑–≥–ª—é—Ç–µ–Ω–æ–≤—ã–µ –æ–ø—Ü–∏–∏
```

**–ü—Ä–∏–º–µ—Ä ContextPack –ø—Ä–∏ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç:**

–ö–æ–≥–¥–∞ —é–∑–µ—Ä —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ ("–Ω–µ –º–æ–π —Ü–≤–µ—Ç"), reply_to_id –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞:

```
[–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è]
UNDE: "–í–æ—Ç —á—Ç–æ –ø–æ–¥–æ–±—Ä–∞–ª–∞ –¥–ª—è —Ç–µ–±—è!"
      [Referenced Artifact: MD-5510 burgundy midi cotton skirt massimo dutti, 
       HM-2231 white relaxed linen shirt h&m ‚Äî weekend casual]
–ê–ª–∏—è: "–ù–µ, —Ü–≤–µ—Ç –Ω–µ –º–æ–π"
```

LLM –≤–∏–¥–∏—Ç –∏ —Ä–µ–∞–∫—Ü–∏—é, –∏ –Ω–∞ —á—Ç–æ –æ–Ω–∞ ‚Äî –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å: "–ü–æ–Ω—è–ª, –±–æ—Ä–¥–æ–≤—ã–π –Ω–µ –∑–∞—Ö–æ–¥–∏—Ç. –î–∞–≤–∞–π –±–µ–∂–µ–≤—ã–π –∏–ª–∏ –æ–ª–∏–≤–∫–æ–≤—ã–π?"

---

## 5. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è Embedding

### –í—ã–±–æ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

| –ü—Ä–æ–≤–∞–π–¥–µ—Ä | –ú–æ–¥–µ–ª—å | –†–∞–∑–º–µ—Ä | –¶–µ–Ω–∞ | –ö–∞—á–µ—Å—Ç–≤–æ –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ–µ |
|-----------|--------|--------|------|----------------------|
| Cohere | embed-multilingual-v3 | 1024 dim | ~$0.10 / 1M tokens | –û—Ç–ª–∏—á–Ω–æ–µ (RU/EN/AR) |
| OpenAI | text-embedding-3-small | 1536 dim | $0.02 / 1M tokens | –•–æ—Ä–æ—à–µ–µ (RU/EN) |
| Google Vertex | Gemini Embedding | 768 dim | ~$0.15 / 1M tokens* | –•–æ—Ä–æ—à–µ–µ (RU/EN) |
| Google Vertex | Embeddings for Text | 768 dim | ~$0.10 / 1M tokens** | –•–æ—Ä–æ—à–µ–µ (RU/EN) |
| Voyage AI | voyage-3 | 1024 dim | $0.06 / 1M tokens | –û—Ç–ª–∏—á–Ω–æ–µ (RU/EN) |
| Voyage AI | voyage-3-lite | 1024 dim | $0.02 / 1M tokens | –•–æ—Ä–æ—à–µ–µ (RU/EN) |

*–¢–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è Vertex –ø–æ —Å–∏–º–≤–æ–ª–∞–º, –ø–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π (1 token ‚âà 4 chars).
**Google "Embeddings for Text (excluding Gemini)": $0.000025/1k chars.

**–†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (MVP, 1000 —é–∑–µ—Ä–æ–≤, 1 –≥–æ–¥):**
- 1000 —é–∑–µ—Ä–æ–≤ √ó 500 msg/–º–µ—Å √ó 12 –º–µ—Å = 6M —Å–æ–æ–±—â–µ–Ω–∏–π
- –° —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ user messages > 15 chars): ~3M —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è embedding
- –°—Ä–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ~50 tokens
- 3M √ó 50 = 150M tokens –Ω–∞ –∑–∞–ø–∏—Å—å
- 6M –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 10 = 60M tokens –Ω–∞ –ø–æ–∏—Å–∫
- –ò—Ç–æ–≥–æ: ~210M tokens/–≥–æ–¥

**–í—ã–≤–æ–¥:** –ø—Ä–∏ –ª—é–±–æ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ < $25/–≥–æ–¥. –í—ã–±–∏—Ä–∞—Ç—å –ø–æ **–∫–∞—á–µ—Å—Ç–≤—É –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç–∏ (—Ä—É—Å—Å–∫–∏–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–π + –∞—Ä–∞–±—Å–∫–∏–π)**, –Ω–µ –ø–æ —Ü–µ–Ω–µ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è MVP:** –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 50-100 —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞—Ö "–∑–∞–ø—Ä–æ—Å ‚Üî —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" –Ω–∞ RU/EN/AR. –ú–µ—Ç—Ä–∏–∫–∏: Recall@10, MRR@10, Noise rate (—Å–∫–æ–ª—å–∫–æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –≤ top-15). –í—ã–±—Ä–∞—Ç—å –ª—É—á—à–∏–π –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º.

**–í–∞–∂–Ω–æ:** —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å embedding —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ —Å—Ö–µ–º–µ –ë–î (`vector(N)`) –∏ –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É. –ù–∞ MVP –≤—ã–±–∏—Ä–∞–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø–æ eval ‚Üí —Ñ–∏–∫—Å–∏—Ä—É–µ–º dim –≤ —Å—Ö–µ–º–µ. –°–º–µ–Ω–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø–æ–∑–∂–µ = re-embed –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π + `ALTER TABLE messages ALTER COLUMN embedding TYPE vector(NEW_DIM)`. –ü—Ä–∏ 3M —Å–æ–æ–±—â–µ–Ω–∏–π –∏ Cohere –ø–æ $0.10/1M tokens ‚Äî —ç—Ç–æ ~$15 –∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ batch job. –ù–µ –±–ª–æ–∫–µ—Ä, –Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞—Ä–∞–Ω–µ–µ.

### –õ–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å (–Ω–∞ –±—É–¥—É—â–µ–µ)

–ù–∞ CPX-—Å–µ—Ä–≤–µ—Ä–∞—Ö –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å:
- `sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2` (384 dim, ~500MB RAM)
- `intfloat/multilingual-e5-small` (384 dim, ~500MB RAM)

–ü–ª—é—Å—ã: –Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç API, –Ω–µ—Ç latency –Ω–∞ —Å–µ—Ç—å, –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤.
–ú–∏–Ω—É—Å—ã: –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∏–∂–µ, –Ω—É–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å, CPU –Ω–∞–≥—Ä—É–∑–∫–∞.

---

## 6. –•—Ä–∞–Ω–µ–Ω–∏–µ –∏ –ø–æ–∏—Å–∫: pgvector + FTS + –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–æ—á–µ–º—É –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ

HNSW-–∏–Ω–¥–µ–∫—Å –≤ pgvector ‚Äî —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –æ–±—â–∏–π –Ω–∞ –≤—Å—é —Ç–∞–±–ª–∏—Ü—É. –ö–æ–≥–¥–∞ –Ω–∞ —à–∞—Ä–¥–µ –º–∏–ª–ª–∏–æ–Ω—ã embeddings (800 —é–∑–µ—Ä–æ–≤ √ó 15K embeddable msgs = 12M –∑–∞–ø–∏—Å–µ–π –∑–∞ 5 –ª–µ—Ç), –∑–∞–ø—Ä–æ—Å—ã —Å —Ñ–∏–ª—å—Ç—Ä–æ–º `conversation_id = $2` –Ω–∞—á–Ω—É—Ç "–≥—É–ª—è—Ç—å" –ø–æ –±–æ–ª—å—à–æ–º—É –≥—Ä–∞—Ñ—É –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ ‚Äî latency –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç.

**–†–µ—à–µ–Ω–∏–µ: –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ hash(conversation_id).** –ö–∞–∂–¥–∞—è –ø–∞—Ä—Ç–∏—Ü–∏—è –∏–º–µ–µ—Ç —Å–≤–æ–π –º–∞–ª–µ–Ω—å–∫–∏–π HNSW-–∏–Ω–¥–µ–∫—Å. PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞–µ—Ç partition pruning –ø–æ conversation_id ‚Äî –ø–æ–∏—Å–∫ –∏–¥—ë—Ç —Ç–æ–ª—å–∫–æ –ø–æ –Ω—É–∂–Ω–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏.

**–í–∞–∂–Ω–æ:** —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ä–µ–∞–ª—å–Ω–æ —Å–ª–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ –±–µ–∑ downtime –∏ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–±–∏–ª–¥–∞ –∏–Ω–¥–µ–∫—Å–æ–≤. –ó–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —Å–µ–π—á–∞—Å.

### –ú–æ–¥–µ–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

**–ö–ª—é—á–µ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `content` –∏ `memory_snippet` —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL **plaintext** (–Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã –Ω–∞ application-level).

**–ü–æ—á–µ–º—É:**
- FTS (`to_tsvector('simple', content)`) —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –æ—Ç–∫—Ä—ã—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º
- raw_excerpt (head+tail, KSP) –∏ snippet fallback —Ç—Ä–µ–±—É—é—Ç –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
- App-level AES-256 —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ content —Å–¥–µ–ª–∞–ª–æ –±—ã FTS –∏ tsvector –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã–º–∏ (–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–ª—Å—è –±—ã ciphertext)

**–ö–∞–∫ –∑–∞—â–∏—â–∞–µ–º:**
- **Private network** ‚Äî Chat History DB –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–∑ internal network (10.1.0.x), –Ω–µ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ IP
- **Strict PostgreSQL roles** ‚Äî read-only –¥–ª—è retrieval, write –¥–ª—è Orchestrator, admin –æ—Ç–¥–µ–ª—å–Ω–æ
- **Encryption at rest** ‚Äî LUKS –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–∏—Å–∫–∞ (volume encryption)
- **Audit logging** ‚Äî –≤—Å–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –∫ —Ç–∞–±–ª–∏—Ü–µ messages –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

**–ß—Ç–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ app-level AES-256 (–∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ):**
- **User Knowledge DB** ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ä–∞–∑–º–µ—Ä—ã, –∞–ª–ª–µ—Ä–≥–∏–∏, –∏–º–µ–Ω–∞). FTS –ø–æ User Knowledge –Ω–µ –Ω—É–∂–µ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ `user_id`
- **User Keys** ‚Äî AES-256 –∫–ª—é—á–∏ –¥–ª—è User Knowledge

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç–æ:**
- `content` ‚Äî —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π (–∑–∞—â–∏—â—ë–Ω private network + LUKS)
- `memory_snippet` ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å–Ω–∏–ø–ø–µ—Ç—ã (–∑–∞—â–∏—â—ë–Ω private network + LUKS)
- `response_description` ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤ (–∑–∞—â–∏—â—ë–Ω private network + LUKS)
- `embedding` ‚Äî –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è vector search)
- `tsv` ‚Äî tsvector –∏–Ω–¥–µ–∫—Å (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –≤–∫–ª—é—á–∞–µ—Ç content + response_description)

**Embeddings:** –∏–∑ –Ω–∏—Ö –º–æ–∂–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ ("—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è —Ç–µ–Ω—å"). –ù–æ —Ç–µ–∫—Å—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ä—è–¥–æ–º plaintext, –ø–æ—ç—Ç–æ–º—É embeddings –Ω–µ —Å–æ–∑–¥–∞—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–∏—Å–∫–∞. –ü—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ (–∫–æ—Ç–æ—Ä—ã–π –∏ —Ç–∞–∫ –Ω–∞ private network) ‚Äî embeddings –Ω–µ –¥–∞—é—Ç –Ω–∏—á–µ–≥–æ –Ω–æ–≤–æ–≥–æ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å plaintext content.

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å—Ö–µ–º–∞ Chat History DB

```sql
-- –†–∞—Å—à–∏—Ä–µ–Ω–∏—è
CREATE EXTENSION IF NOT EXISTS vector;

-- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
CREATE TABLE messages (
    id UUID NOT NULL DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL,
    
    role VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    
    -- Semantic search
    -- NB: dim (1024) —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç Cohere/Voyage. –ü—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:
    -- ALTER TABLE messages ALTER COLUMN embedding TYPE vector(NEW_DIM) + re-embed all.
    embedding vector(1024),
    is_embeddable BOOLEAN DEFAULT FALSE,
    is_forgotten BOOLEAN DEFAULT FALSE,
    
    -- Memory classification
    memory_type VARCHAR(20) DEFAULT 'general',
    -- emotion | preference | fact | event | general
    memory_confidence FLOAT DEFAULT 0.5,
    -- 0.0..1.0, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ intensifiers/softeners
    
    -- Precomputed snippet
    memory_snippet TEXT,
    -- "–í IMAX –±—ã–ª–æ —Ö–æ–ª–æ–¥–Ω–æ ‚Üí –±—Ä–∞—Ç—å —Ç—ë–ø–ª—ã–π —Å–ª–æ–π"
    
    -- Consultant Response Description (¬ß2, Response Description Layer)
    -- Backend-only —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞.
    -- –í UI –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è SYNC template-based –ø—Ä–∏ INSERT.
    -- NULL –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –±–µ–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞.
    response_description TEXT,
    
    -- –°—Å—ã–ª–∫–∞ –Ω–∞ assistant message, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Ä–µ–∞–∫—Ü–∏—è —é–∑–µ—Ä–∞.
    -- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —É user-—Å–æ–æ–±—â–µ–Ω–∏–π. –ù–µ FK (–ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ).
    -- –°–µ—Ä–≤–µ—Ä–Ω–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –∑–∞ 10 –º–∏–Ω, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ —É–∫–∞–∑–∞–ª —è–≤–Ω–æ.
    reply_to_id UUID,
    
    -- Full-text search
    -- NB: 'simple' config = —Ç–æ—á–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –±–µ–∑ –º–æ—Ä—Ñ–æ–ª–æ–≥–∏–∏.
    -- FTS –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∏–º–µ–Ω–∞/–±—Ä–µ–Ω–¥—ã/—Ü–∏—Ñ—Ä—ã, —Å–µ–º–∞–Ω—Ç–∏–∫–∞ ‚Äî —á–µ—Ä–µ–∑ embeddings.
    -- –í–∫–ª—é—á–∞–µ—Ç response_description –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∞—Ç—Ä–∏–±—É—Ç–∞–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤.
    tsv tsvector GENERATED ALWAYS AS (
        to_tsvector('simple', content || ' ' || COALESCE(response_description, ''))
    ) STORED,
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    media_urls JSONB,
    mood_frame JSONB,
    input_type VARCHAR(20),
    duration_ms INTEGER,
    model_used VARCHAR(100),
    
    -- GDPR
    deleted_at TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    PRIMARY KEY (conversation_id, id)
) PARTITION BY HASH (conversation_id);

-- 64 –ø–∞—Ä—Ç–∏—Ü–∏–∏ (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è 800+ —é–∑–µ—Ä–æ–≤ –Ω–∞ —à–∞—Ä–¥)
-- –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º:
DO $$
BEGIN
    FOR i IN 0..63 LOOP
        EXECUTE format(
            'CREATE TABLE messages_p%s PARTITION OF messages 
             FOR VALUES WITH (MODULUS 64, REMAINDER %s)',
            lpad(i::text, 2, '0'), i
        );
    END LOOP;
END $$;

-- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ.
-- PostgreSQL 17 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç CREATE INDEX –Ω–∞ parent —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º
-- —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–∞ –∫–∞–∂–¥–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏. –ï—Å–ª–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏ pgvector
-- —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DO-block –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–∞—Ä—Ç–∏—Ü–∏—è–º.

-- HNSW: partial index —Ç–æ–ª—å–∫–æ –¥–ª—è embeddable, –Ω–µ-forgotten —Å–æ–æ–±—â–µ–Ω–∏–π.
-- –≠—Ç–æ —É–º–µ–Ω—å—à–∞–µ—Ç –≥—Ä–∞—Ñ ~–≤–¥–≤–æ–µ (—Ç–æ–ª—å–∫–æ ~50% —Å–æ–æ–±—â–µ–Ω–∏–π embeddable).
-- NB: partial HNSW –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π pgvector.
-- –ï—Å–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚Äî —É–±—Ä–∞—Ç—å WHERE –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π –∏–Ω–¥–µ–∫—Å.
CREATE INDEX idx_messages_embedding 
    ON messages USING hnsw (embedding vector_cosine_ops)
    WITH (m = 16, ef_construction = 64)
    WHERE role = 'user' AND is_embeddable = TRUE 
      AND is_forgotten = FALSE AND embedding IS NOT NULL;

CREATE INDEX idx_messages_tsv 
    ON messages USING gin (tsv);

CREATE INDEX idx_messages_conversation_time 
    ON messages(conversation_id, created_at DESC);

CREATE INDEX idx_messages_retrieval
    ON messages(conversation_id, role, is_embeddable, is_forgotten)
    WHERE role = 'user' AND is_embeddable = TRUE AND is_forgotten = FALSE;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Å `WHERE conversation_id = $2` PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ 1 –∏–∑ 64 –ø–∞—Ä—Ç–∏—Ü–∏–π. HNSW-–∏–Ω–¥–µ–∫—Å –≤ —ç—Ç–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç ~190K –∑–∞–ø–∏—Å–µ–π (12M / 64) –≤–º–µ—Å—Ç–æ 12M ‚Äî –ø–æ–∏—Å–∫ –Ω–∞ –ø–æ—Ä—è–¥–∫–∏ –±—ã—Å—Ç—Ä–µ–µ.

**–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:** PK = `(conversation_id, id)` ‚Äî —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–∑-–∑–∞ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç `id` (UUID) **–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —É–Ω–∏–∫–∞–ª–µ–Ω** –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Ç–∞–±–ª–∏—Ü—ã (—Ö–æ—Ç—è UUID collision –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω). –í–æ –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º–∞—Ö ‚Äî UI, tombstone registry, –ª–æ–≥–∏, API ‚Äî –æ–ø–µ—Ä–∏—Ä—É–µ–º **–ø–∞—Ä–æ–π (conversation_id, message_id)**, –Ω–µ –æ–¥–Ω–∏–º id.

### –ó–∞–ø—Ä–æ—Å Hybrid Search —Å —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º Temporal Decay + Confidence

```sql
WITH vector_results AS (
    -- Vector search: —Ç–æ–ª—å–∫–æ user-—Å–æ–æ–±—â–µ–Ω–∏—è (—ç–º–±–µ–¥–¥–∏–Ω–≥–∏ —Ç–æ–ª—å–∫–æ —É –Ω–∏—Ö)
    SELECT id, content, memory_snippet, memory_type, 
           memory_confidence, created_at, role,
           response_description,
           GREATEST(0, 1 - (embedding <=> $1)) AS vec_score
    FROM messages
    WHERE conversation_id = $2
      AND role = 'user'
      AND is_embeddable = TRUE
      AND is_forgotten = FALSE
      AND embedding IS NOT NULL
    ORDER BY embedding <=> $1
    LIMIT 20
),
fts_results AS (
    -- FTS: user + assistant (response_description –≤ tsvector)
    -- –ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ role ‚Äî –ª–æ–≤–∏–º –∏ —é–∑–µ—Ä—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∏ –æ–ø–∏—Å–∞–Ω–∏—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
    SELECT id, content, memory_snippet, memory_type, 
           memory_confidence, created_at, role,
           response_description,
           LEAST(1.0, ts_rank(tsv, plainto_tsquery('simple', $3)) * 10) AS fts_score
    FROM messages
    WHERE conversation_id = $2
      AND is_forgotten = FALSE
      AND tsv @@ plainto_tsquery('simple', $3)
    ORDER BY fts_score DESC
    LIMIT 10
),
merged AS (
    SELECT 
        COALESCE(v.id, f.id) AS id,
        COALESCE(v.content, f.content) AS content,
        COALESCE(v.memory_snippet, f.memory_snippet) AS memory_snippet,
        COALESCE(v.memory_type, f.memory_type) AS memory_type,
        COALESCE(v.memory_confidence, f.memory_confidence) AS memory_confidence,
        COALESCE(v.created_at, f.created_at) AS created_at,
        COALESCE(v.role, f.role) AS role,
        COALESCE(v.response_description, f.response_description) AS response_description,
        COALESCE(v.vec_score, 0) AS vec_score,
        COALESCE(f.fts_score, 0) AS fts_score
    FROM vector_results v
    FULL OUTER JOIN fts_results f 
        ON v.id = f.id
)
SELECT 
    id,
    -- snippet (–∏–Ω–¥–µ–∫—Å, –Ω–µ–∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–µ–Ω ‚Äî –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –Ω–µ –¥–ª—è –¥–æ–≤–µ—Ä–∏—è)
    -- Fallback = '' (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞), –ù–ï LEFT(content, N)
    -- –°–º. KSP –§–∏–∫—Å 4A: Epistemic Contract, –ü—Ä–∞–≤–∏–ª–æ 3
    CASE 
        WHEN role = 'assistant' AND response_description IS NOT NULL 
            THEN response_description
        ELSE COALESCE(memory_snippet, '')
    END AS snippet,
    -- raw excerpt (–ø–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫, –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–µ–Ω) ‚Äî head+tail
    CASE
        WHEN LENGTH(content) <= 500 THEN content
        WHEN memory_type IN ('fact', 'event') AND LENGTH(content) <= 1500 THEN content
        WHEN memory_type IN ('fact', 'event') THEN LEFT(content, 800) || ' [...] ' || RIGHT(content, 400)
        ELSE LEFT(content, 280) || ' [...] ' || RIGHT(content, 220)
    END AS raw_excerpt,
    created_at,
    role,
    -- Hybrid score + —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π temporal decay + confidence
    (0.7 * vec_score + 0.3 * fts_score) 
    * (1 + 0.3 * EXP(
        -1 * CASE memory_type
            WHEN 'emotion'    THEN 0.015
            WHEN 'event'      THEN 0.008
            WHEN 'general'    THEN 0.005
            WHEN 'preference' THEN 0.002
            WHEN 'fact'       THEN 0.001
            ELSE 0.005
        END
        * (1.3 - COALESCE(memory_confidence, 0.5))
        * EXTRACT(EPOCH FROM NOW() - created_at) / 86400
    )) AS final_score
FROM merged
WHERE vec_score > $4 OR fts_score > 0  -- $4 = similarity_threshold (0.5 mono / 0.35 multilingual)
ORDER BY final_score DESC
LIMIT 15;
```

**–ê—Å–∏–º–º–µ—Ç—Ä–∏—è vector vs FTS:** vector branch –∏—â–µ—Ç —Ç–æ–ª—å–∫–æ `role='user'` (—ç–º–±–µ–¥–¥–∏–Ω–≥–∏ —Ç–æ–ª—å–∫–æ —É —é–∑–µ—Ä—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π). FTS branch –∏—â–µ—Ç **–≤—Å–µ —Ä–æ–ª–∏** ‚Äî —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å assistant-–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ø–æ —Ç–æ–∫–µ–Ω–∞–º –∏–∑ `response_description` (–±—Ä–µ–Ω–¥, —Ü–≤–µ—Ç, SKU). –î–ª—è assistant-—Å–æ–æ–±—â–µ–Ω–∏–π episode_card –±–µ—Ä—ë—Ç—Å—è –∏–∑ `response_description` (–Ω–µ –∏–∑ `content`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç "–í–æ—Ç —á—Ç–æ —è –Ω–∞—à–ª–∞!").

**Diversity filter:** –Ω–µ –±–æ–ª–µ–µ 3 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –æ–¥–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –¥–Ω—è (–ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ application layer).

---

## 7. –†–∞—Å—á—ë—Ç –æ–±—ä—ë–º–æ–≤

### –û–±—ä—ë–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –†–∞–∑–º–µ—Ä | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| –¢–µ–∫—Å—Ç (content) | ~1 KB | –°—Ä–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ |
| mood_frame JSON | ~200 B | –ù–µ –¥–ª—è –≤—Å–µ—Ö |
| Embedding (1024-dim, float32) | ~4 KB | –¢–æ–ª—å–∫–æ embeddable (~50%) |
| HNSW –∏–Ω–¥–µ–∫—Å overhead | ~1.2 KB | ~30% –æ—Ç embedding |
| tsvector (FTS) | ~200 B | –í–∫–ª—é—á–∞–µ—Ç response_description |
| memory_snippet | ~100 B | –¢–æ–ª—å–∫–æ embeddable |
| memory_type + confidence | ~15 B | |
| response_description | ~150 B | –¢–æ–ª—å–∫–æ assistant —Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–º (~20%) |
| –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ + –∏–Ω–¥–µ–∫—Å—ã PG | ~500 B | |
| **–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ** | **~4.7 KB** | –° —É—á—ë—Ç–æ–º 50% embeddable, 20% –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ |

### –û–±—ä—ë–º –Ω–∞ —é–∑–µ—Ä–∞

| –ü–µ—Ä–∏–æ–¥ | –°–æ–æ–±—â–µ–Ω–∏–π | Chat History | User Knowledge | –ò—Ç–æ–≥–æ |
|--------|-----------|-------------|----------------|-------|
| 1 –º–µ—Å—è—Ü | ~500 | ~2.3 MB | ~70 KB | ~2.4 MB |
| 1 –≥–æ–¥ | ~6,000 | ~27 MB | ~200 KB | ~27 MB |
| 5 –ª–µ—Ç | ~30,000 | ~135 MB | ~1 MB | ~136 MB |

### –°–∫–æ–ª—å–∫–æ —é–∑–µ—Ä–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

**–î–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞—Å—á—ë—Ç–∞:** –¥–∏—Å–∫–æ–≤–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ (backup/replica) –∏ RAM (bare metal primary).

**–ü–æ –¥–∏—Å–∫–æ–≤–æ–º—É —Ö—Ä–∞–Ω–µ–Ω–∏—é (Hetzner replicas, Object Storage backups):**

| –°–µ—Ä–≤–µ—Ä | –î–∏—Å–∫ | –ü–æ–¥ –¥–∞–Ω–Ω—ã–µ (~70%) | –Æ–∑–µ—Ä–æ–≤ –Ω–∞ 5 –ª–µ—Ç | –Æ–∑–µ—Ä–æ–≤ –Ω–∞ 1 –≥–æ–¥ |
|--------|------|-------------------|-----------------|-----------------|
| CPX21 (80 GB) | 55 GB | ~400 | ~2,000 |
| CPX31 (160 GB) | 110 GB | ~800 | ~4,000 |
| AX102 (128 GB RAM, 2√ó2TB NVMe) | 1.4 TB | ~10,000 | ~50,000 |

**–ü–æ RAM (bare metal Dubai, tmpfs ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π bottleneck):**

| –°–µ—Ä–≤–µ—Ä | RAM | –ü–æ–¥ pgdata (~60%) | HNSW index limit | –Æ–∑–µ—Ä–æ–≤ (–≥–æ–¥ 1) | –Æ–∑–µ—Ä–æ–≤ (–≥–æ–¥ 2) |
|--------|-----|-------------------|------------------|-----------------|-----------------|
| 256 GB (Dell R6525) | 150 GB usable | ~80 GB HNSW | ~5,000 | ~3,000 |
| 512 GB | 300 GB usable | ~160 GB HNSW | ~10,000 | ~6,000 |

*RAM ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π bottleneck. –ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á—ë—Ç ‚Äî —Å–º. UNDE_Infrastructure_BD, —Ä–∞–∑–¥–µ–ª 1.*

### –í—ã–≤–æ–¥

–î–ª—è MVP (–ø–∏–ª–æ—Ç –î—É–±–∞–π, –¥–æ 1000 —é–∑–µ—Ä–æ–≤ –≤ –ø–µ—Ä–≤—ã–π –≥–æ–¥) ‚Äî **–æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (256 GB RAM, tmpfs) —Ö–≤–∞—Ç–∏—Ç —Å –∑–∞–ø–∞—Å–æ–º –Ω–∞ 2+ –≥–æ–¥–∞.** –°—Ç–∞—Ä—Ç –Ω–∞ dedicated server (–∞—Ä–µ–Ω–¥–∞, $0 CAPEX), –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ colocation –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏. –ü—Ä–∏ —Ä–æ—Å—Ç–µ –∑–∞ 5000 —é–∑–µ—Ä–æ–≤ ‚Äî –≤—Ç–æ—Ä–æ–π —à–∞—Ä–¥. Hetzner replicas (AX102, 128 GB RAM) —Å–ª—É–∂–∞—Ç –∫–∞–∫ hot standby + failover, –Ω–µ –∫–∞–∫ primary.

---

## 8. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–Ω—Ü–∏–ø: –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —é–∑–µ—Ä–∞ ‚Äî –Ω–∞ –æ–¥–Ω–æ–º —à–∞—Ä–¥–µ

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ROUTING TABLE (Production DB –∏–ª–∏ Redis)                ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  user_id ‚Üí shard_id ‚Üí connection_string                 ‚îÇ
‚îÇ  –∞–ª–∏—è_001 ‚Üí shard-dubai-1 ‚Üí postgresql://10.1.1.10      ‚îÇ
‚îÇ  –¥–∏–º–∞_002 ‚Üí shard-dubai-1 ‚Üí postgresql://10.1.1.10      ‚îÇ
‚îÇ  —Ñ–∞—Ç–∏–º–∞_003 ‚Üí shard-dubai-2 ‚Üí postgresql://10.2.1.10   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–®–∞—Ä–¥ "dubai-1" (Bare metal Dubai: dedicated server ‚Üí colocation, 256 GB RAM, tmpfs)
‚îú‚îÄ‚îÄ PostgreSQL 17 + pgvector
‚îÇ   ‚îú‚îÄ‚îÄ pgdata –Ω–∞ tmpfs (RAM) ‚Äî sub-microsecond reads
‚îÇ   ‚îú‚îÄ‚îÄ WAL –Ω–∞ NVMe (synchronous_commit=local)
‚îÇ   ‚îú‚îÄ‚îÄ messages (64 –ø–∞—Ä—Ç–∏—Ü–∏–∏, plaintext + embeddings + tsvector + snippets)
‚îÇ   ‚îú‚îÄ‚îÄ conversations (users 1-5000)
‚îÇ   ‚îú‚îÄ‚îÄ user_keys (AES-256 –∫–ª—é—á–∏)
‚îÇ   ‚îú‚îÄ‚îÄ user_knowledge (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ AES-256)
‚îÇ   ‚îú‚îÄ‚îÄ HNSW –∏–Ω–¥–µ–∫—Å—ã (–≤ –∫–∞–∂–¥–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏)
‚îÇ   ‚îî‚îÄ‚îÄ GIN –∏–Ω–¥–µ–∫—Å—ã (FTS, –≤ –∫–∞–∂–¥–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏)
‚îú‚îÄ‚îÄ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: private network + LUKS (NVMe) + strict PG roles
‚îú‚îÄ‚îÄ –õ–æ–∫–∞–ª—å–Ω—ã–π snapshot: pg_basebackup –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞ –Ω–∞ NVMe
‚îî‚îÄ‚îÄ Streaming replication ‚Üí Hetzner replica

–®–∞—Ä–¥ "dubai-1" replica (Hetzner AX102, 128 GB RAM, NVMe)
‚îú‚îÄ‚îÄ Hot standby (read-only)
‚îú‚îÄ‚îÄ Patroni + etcd ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π failover
‚îú‚îÄ‚îÄ pg_basebackup ‚Üí Object Storage (continuous WAL archive)
‚îî‚îÄ‚îÄ Failover primary –ø—Ä–∏ —Å–±–æ–µ Dubai (latency 120ms –≤–º–µ—Å—Ç–æ <1ms)

–®–∞—Ä–¥ "dubai-2" (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ HNSW index > 80 GB)
‚îú‚îÄ‚îÄ –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: bare metal Dubai + Hetzner replica
‚îÇ   ‚îú‚îÄ‚îÄ messages (64 –ø–∞—Ä—Ç–∏—Ü–∏–∏)
‚îÇ   ‚îú‚îÄ‚îÄ conversations (users 5001-10000)
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ –û—Ç–¥–µ–ª—å–Ω—ã–π Patroni cluster

Production DB (10.1.0.1)
‚îú‚îÄ‚îÄ routing table (user_id ‚Üí shard_id)
‚îú‚îÄ‚îÄ deleted_messages_registry             ‚Üê tombstone primary
‚îÇ   ‚îî‚îÄ‚îÄ (conversation_id, message_id, deleted_at)
‚îî‚îÄ‚îÄ (–Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —à–∞—Ä–¥–æ–≤)

Object Storage (Hetzner hel1)
‚îú‚îÄ‚îÄ backups/shard-dubai-1/
‚îÇ   ‚îú‚îÄ‚îÄ 2026-02-14_06.sql.gz
‚îÇ   ‚îú‚îÄ‚îÄ 2026-02-14_12.sql.gz
‚îÇ   ‚îú‚îÄ‚îÄ 2026-02-14_18.sql.gz
‚îÇ   ‚îî‚îÄ‚îÄ 2026-02-14_00.sql.gz
‚îú‚îÄ‚îÄ backups/shard-dubai-2/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ deleted_messages_registry/
‚îÇ   ‚îî‚îÄ‚îÄ hard_deleted_ids.jsonl            ‚Üê tombstone copy
‚îî‚îÄ‚îÄ (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: restore —à–∞—Ä–¥ ‚Üí apply_deletions –∏–∑ Production DB)
```

### Chat History + User Knowledge = –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä

–ù–∞ MVP –∏ –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ ‚Äî –æ–±–µ –±–∞–∑—ã –∂–∏–≤—É—Ç –Ω–∞ –æ–¥–Ω–æ–º —à–∞—Ä–¥–µ:
- –û–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä –Ω–∞ —é–∑–µ—Ä–∞ ‚Äî –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è ContextPack
- User Knowledge ‚Üí AES-256 app-level encryption (—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- Chat History ‚Üí plaintext + private network + LUKS at-rest
- GDPR hard delete: –∫–∞—Å–∫–∞–¥ –Ω–∞ —à–∞—Ä–¥–µ + tombstone –≤ Production DB
- "–ó–∞–±—É–¥—å —ç—Ç–æ": soft/hard delete –∫–∞—Å–∫–∞–¥–Ω–æ –Ω–∞ —Ç–æ–º –∂–µ —à–∞—Ä–¥–µ

---

## 9. Pipeline: –æ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ retrieval

### –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (ingestion)

```
–Æ–∑–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ
    ‚îÇ
    ‚ñº
LLM Orchestrator –æ–±—Ä–∞–±–æ—Ç–∞–ª, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –æ—Ç–≤–µ—Ç
    ‚îÇ
    ‚ñº
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Chat History DB:
    ‚îÇ
    ‚îú‚îÄ‚îÄ 1. SYNC: salience_check(text, role)
    ‚îÇ      ‚Üí is_embeddable = True/False
    ‚îÇ
    ‚îú‚îÄ‚îÄ 2. SYNC: classify_memory(text, role)
    ‚îÇ      ‚Üí memory_type = emotion|preference|fact|event|general
    ‚îÇ      ‚Üí memory_confidence = 0.3|0.5|0.9
    ‚îÇ
    ‚îú‚îÄ‚îÄ 2a. SYNC (–¥–ª—è assistant —Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–º):
    ‚îÇ      build_response_description(consultant_type, structured_data)
    ‚îÇ      ‚Üí response_description = "burgundy midi cotton skirt..."
    ‚îÇ      (template-based, ~0.1ms ‚Äî sync —á—Ç–æ–±—ã GENERATED tsvector –±—ã–ª –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω)
    ‚îÇ
    ‚îú‚îÄ‚îÄ 2b. SYNC (–¥–ª—è user-—Å–æ–æ–±—â–µ–Ω–∏–π):
    ‚îÇ      resolve_reply_to(conversation_id, explicit_reply_to, created_at)
    ‚îÇ      ‚Üí reply_to_id = msg-asst-789 (—ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –∑–∞ 10 –º–∏–Ω)
    ‚îÇ
    ‚îú‚îÄ‚îÄ 3. INSERT message (text, role, mood_frame,
    ‚îÇ      is_embeddable, memory_type, memory_confidence,
    ‚îÇ      response_description, reply_to_id, etc.)
    ‚îÇ
    ‚îú‚îÄ‚îÄ 4. IF is_embeddable ‚Äî ASYNC pipeline:
    ‚îÇ       ‚îÇ
    ‚îÇ       ‚îú‚îÄ‚îÄ a) Embedding API (Cohere)
    ‚îÇ       ‚îÇ      text ‚Üí vector [0.12, -0.34, ...]
    ‚îÇ       ‚îÇ      ‚Üí UPDATE embedding
    ‚îÇ       ‚îÇ
    ‚îÇ       ‚îî‚îÄ‚îÄ b) Snippet generation
    ‚îÇ              MVP: memory_snippet = NULL (–ø—É—Å—Ç–æ–π)
    ‚îÇ              LLM —Ä–∞–±–æ—Ç–∞–µ—Ç —Å raw_excerpt (head+tail)
    ‚îÇ              
    ‚îÇ              –§–∞–∑–∞ 2: async LLM ‚Üí lazy snippet gen
    ‚îÇ              (–º–∞–∫—Å 120 —Å–∏–º–≤–æ–ª–æ–≤, –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
    ‚îÇ
    ‚îî‚îÄ‚îÄ (—é–∑–µ—Ä –Ω–µ –∂–¥—ë—Ç –Ω–∏—á–µ–≥–æ –∏–∑ —à–∞–≥–∞ 4)
        (FTS tsvector –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ PostgreSQL)
```

### Salience Check

```python
def salience_check(text: str, role: str) -> bool:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —Å—Ç–æ–∏—Ç –ª–∏ embed'–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    if role != 'user':
        return False
    if len(text) < 15:
        return False
    if is_only_emoji(text):
        return False
    return True
```

### –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —é–∑–µ—Ä–∞ (retrieval)

```
–Æ–∑–µ—Ä: "—Ö–æ—á—É –ø–æ–π—Ç–∏ –≤ –∫–∏–Ω–æ —Å–µ–≥–æ–¥–Ω—è"
    ‚îÇ
    ‚ñº
LLM Orchestrator:
    ‚îÇ
    ‚îú‚îÄ‚îÄ 1. Embed –∑–∞–ø—Ä–æ—Å ‚Üí vector (sync, ~50ms)
    ‚îÇ
    ‚îú‚îÄ‚îÄ 2. –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û:
    ‚îÇ       ‚îÇ
    ‚îÇ       ‚îú‚îÄ‚îÄ a) Hybrid Search                  (~10ms)
    ‚îÇ       ‚îÇ      vector TOP-20 + FTS TOP-10
    ‚îÇ       ‚îÇ      ‚Üí merge ‚Üí normalize scores
    ‚îÇ       ‚îÇ      ‚Üí —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π decay + confidence
    ‚îÇ       ‚îÇ      ‚Üí diversity filter
    ‚îÇ       ‚îÇ      ‚Üí threshold (vec > 0.5 OR fts > 0)
    ‚îÇ       ‚îÇ      ‚Üí TOP-15 —Å raw_excerpt (+snippet)
    ‚îÇ       ‚îÇ
    ‚îÇ       ‚îú‚îÄ‚îÄ b) SELECT User Knowledge           (~1ms)
    ‚îÇ       ‚îú‚îÄ‚îÄ c) SELECT –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π   (~1ms)
    ‚îÇ       ‚îú‚îÄ‚îÄ d) mood_frame (—É–∂–µ –ø–æ–ª—É—á–µ–Ω)        (0ms)
    ‚îÇ       ‚îú‚îÄ‚îÄ e) context_frame (—É–∂–µ –ø–æ–ª—É—á–µ–Ω)     (0ms)
    ‚îÇ       ‚îú‚îÄ‚îÄ e2) persona_directive (—É–∂–µ –ø–æ–ª—É—á–µ–Ω  (0ms)
    ‚îÇ       ‚îÇ       –æ—Ç Persona Agent, –§–∞–∑–∞ 2)
    ‚îÇ       ‚îî‚îÄ‚îÄ f) IF reply_to_id IS NOT NULL:     (~0.1ms)
    ‚îÇ              Artifact lookup –ø–æ PK
    ‚îÇ              ‚Üí Referenced Artifact description
    ‚îÇ
    ‚îú‚îÄ‚îÄ 3. NEEDS_SPAN enrichment                   (~2ms)
    ‚îÇ      (–∫–æ—Ä–æ—Ç–∫–∏–µ —ç–ø–∏–∑–æ–¥—ã <50 chars ‚Üí ¬±1 —Å–æ—Å–µ–¥)
    ‚îÇ
    ‚îú‚îÄ‚îÄ 4. Emotional filter                        (~1ms)
    ‚îÇ      (mood_frame ‚Üí exclude –±–æ–ª–µ–∑–Ω–µ–Ω–Ω—ã–µ)
    ‚îÇ
    ‚îú‚îÄ‚îÄ 5. Memory Density Cap                      (~1ms)
    ‚îÇ      (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π: new ‚â§3, active ‚â§5, mature ‚â§7)
    ‚îÇ
    ‚îú‚îÄ‚îÄ 6. –°–±–æ—Ä–∫–∞ ContextPack                      (~1ms)
    ‚îÇ      A. User Knowledge (—Ñ–∞–∫—Ç—ã)
    ‚îÇ      B. Episode Cards (snippet + raw_excerpt)
    ‚îÇ      C. –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ—Ç–æ–∫)
    ‚îÇ      D. mood_frame (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ)
    ‚îÇ      E. context_frame (–º–∏—Ä –≤–æ–∫—Ä—É–≥)
    ‚îÇ      F. Referenced Artifact (–µ—Å–ª–∏ reply_to_id)
    ‚îÇ      G. persona_directive (—Ö–∞—Ä–∞–∫—Ç–µ—Ä, —Ç–æ–Ω, —Å—Ç–∏–ª—å, hard bans)
    ‚îÇ
    ‚îú‚îÄ‚îÄ 7. ‚Üí LLM API —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
    ‚îú‚îÄ‚îÄ 8. voice_params (–æ—Ç Persona Agent) ‚Üí Voice Server
    ‚îú‚îÄ‚îÄ 9. avatar_state + render_hints ‚Üí App
    ‚îÇ
    ‚îî‚îÄ‚îÄ ASYNC –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞:
       10. detect_behavioral_signals()
       11. POST /persona/feedback (signals + exchange_id)
       12. POST /persona/flush (exchange_id)

–û–±—â–∞—è –¥–æ–±–∞–≤–ª–µ–Ω–Ω–∞—è latency: ~67ms
(persona 15ms ‚Äñ embedding 50ms + NEEDS_SPAN 2ms, artifact lookup: +0.1ms)
```

### –ü—Ä–∏ replay –ø–æ—Å–ª–µ failover (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –ø–∞—Ä)

–ü—Ä–∏ —Å–±–æ–µ primary (tmpfs) –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1‚Äì5 —Å–µ–∫—É–Ω–¥ —Å–æ–æ–±—â–µ–Ω–∏–π –º–æ–≥—É—Ç –Ω–µ —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ Hetzner. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –±—É—Ñ–µ—Ä –Ω–µ–¥–∞–≤–Ω–∏—Ö –ø–∞—Ä ¬´–∑–∞–ø—Ä–æ—Å —é–∑–µ—Ä–∞ + –æ—Ç–≤–µ—Ç UNDE¬ª –∏ –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –ø–æ—Å–ª–µ reconnect.

**–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ –ø–∞—Ä—ã, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è —é–∑–µ—Ä–∞:**
- –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ user message ‚Üí LLM —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç **–¥—Ä—É–≥–æ–π** –æ—Ç–≤–µ—Ç (–¥—Ä—É–≥–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏, —Ç–æ–Ω)
- –Æ–∑–µ—Ä –≤–∏–¥–µ–ª –æ–¥–Ω–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –æ–∫–∞–∂—É—Ç—Å—è –¥—Ä—É–≥–∏–µ
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏ —Å–ª–æ–º–∞—é—Ç—Å—è: ¬´–ø–æ–∫–∞–∂–∏ –≤—Ç–æ—Ä–æ–π –≤–∞—Ä–∏–∞–Ω—Ç¬ª ‚Üí –≤—Ç–æ—Ä–æ–π –≤–∞—Ä–∏–∞–Ω—Ç —É–∂–µ –¥—Ä—É–≥–æ–π
- –î–æ–≤–µ—Ä–∏–µ –∫ ¬´–ø–∞–º—è—Ç–∏ –¥—Ä—É–≥–∞¬ª —Ä–∞–∑—Ä—É—à–∞–µ—Ç—Å—è

**–§–æ—Ä–º–∞—Ç –±—É—Ñ–µ—Ä–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:**

```json
{
  "conversation_id": "conv-xyz",
  "pending_pairs": [
    {
      "request_id": "req-123",
      "messages": [
        {
          "id": "msg-user-456",
          "role": "user",
          "content": "—Ö–æ—á—É –∫—Ä–æ—Å—Å–æ–≤–∫–∏ –¥–æ 500 –¥–∏—Ä—Ö–∞–º",
          "created_at": "2026-02-15T19:30:00+04:00"
        },
        {
          "id": "msg-asst-789",
          "role": "assistant",
          "content": "–í–æ—Ç —á—Ç–æ –Ω–∞—à–ª–∞ –≤ Dubai Hills Mall...",
          "response_description": "white air max 90 nike 420 aed, casual sporty",
          "cards": [{"sku": "NK-AIR-1", "store": "Nike", "price": 420}],
          "audio_url": "https://.../response-789.mp3",
          "mood_frame": {"valence": 0.7, "energy": 0.6},
          "created_at": "2026-02-15T19:30:02+04:00"
        }
      ],
      "status": "unconfirmed"
    }
  ]
}
```

**–ü—Ä–æ—Ç–æ–∫–æ–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (ack):**

| –°–æ–±—ã—Ç–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ |
|---------|----------------------|
| –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —é–∑–µ—Ä–∞ | –î–æ–±–∞–≤–∏—Ç—å user message –≤ –±—É—Ñ–µ—Ä, status ‚Üí `pending` |
| –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ | –î–æ–±–∞–≤–∏—Ç—å assistant message –≤ —Ç—É –∂–µ –ø–∞—Ä—É, status ‚Üí `unconfirmed` |
| –ü–æ–ª—É—á–µ–Ω–∏–µ `ack` –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ | status ‚Üí `confirmed`. Ack –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ SYNC INSERT –æ–±–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (user + assistant) —Å `synchronous_commit=local` (WAL –Ω–∞ NVMe –∑–∞—Ñ–ª–∞—à–µ–Ω) |
| –ù–µ—Ç ack > 5 —Å–µ–∫ | –ü–æ–º–µ—Ç–∏—Ç—å –¥–ª—è retry |
| Reconnect –ø–æ—Å–ª–µ failover | `POST /verify-and-replay`: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ unconfirmed –ø–∞—Ä—ã **+ ID –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 confirmed –ø–∞—Ä** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (safety net) |

**–ú–æ–º–µ–Ω—Ç ack:** –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ INSERT –æ–±–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–∞—Ä—ã (Tier A/B) —Å `synchronous_commit=local`. Async enrichment (embedding, snippet ‚Äî Tier C) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å `SET LOCAL synchronous_commit=off` –∏ **–Ω–µ** –±–ª–æ–∫–∏—Ä—É–µ—Ç ack. Enrichment –¥–æ–≥–æ–Ω–∏—Ç –ø–æ–∑–∂–µ.

**–ó–∞—á–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å confirmed –ø–∞—Ä—ã (safety net):**
–î–∞–∂–µ —Å `synchronous_commit=local` (WAL –Ω–∞ NVMe), –ø—Ä–∏ hard crash (reboot/–ø–∏—Ç–∞–Ω–∏–µ) WAL –º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ Hetzner —á–µ—Ä–µ–∑ async streaming. –°—Ü–µ–Ω–∞—Ä–∏–π: ack –¥–æ—à—ë–ª ‚Üí app –ø–æ–º–µ—Ç–∏–ª "confirmed" ‚Üí primary —É–ø–∞–ª ‚Üí WAL –Ω–µ –¥–æ–ª–µ—Ç–µ–ª –¥–æ Hetzner. –ë–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äî –ø–∞—Ä–∞ –ø–æ—Ç–µ—Ä—è–Ω–∞ –Ω–∞–≤—Å–µ–≥–¥–∞. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 2‚Äì3 confirmed –ø–∞—Ä —Å—Ç–æ–∏—Ç –æ–¥–∏–Ω SELECT –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –¥—ã—Ä—É. Confirmed –ø–∞—Ä—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±—É—Ñ–µ—Ä–µ –µ—â—ë 60 —Å–µ–∫ –ø–æ—Å–ª–µ ack.

**Endpoint `/verify-and-replay`:**

```
POST /verify-and-replay
{
  "conversation_id": "conv-xyz",
  "unconfirmed": [
    { "id": "msg-user-456", "role": "user", "content": "...", "created_at": "..." },
    { "id": "msg-asst-789", "role": "assistant", "content": "...", "cards": [...], "created_at": "..." }
  ],
  "recent_confirmed_ids": ["msg-user-123", "msg-asst-124", "msg-user-345", "msg-asst-346"]
}
```

```sql
-- –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å confirmed –ø–∞—Ä—ã (safety net)
SELECT id FROM messages
WHERE conversation_id = $1 AND id IN ($confirmed_ids);
-- –ï—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ ID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª–Ω—É—é –ø–∞—Ä—É –æ—Ç app –¥–ª—è replay

-- –®–∞–≥ 2: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
-- –ï—Å–ª–∏ role=assistant –∏ message —Å–æ–¥–µ—Ä–∂–∏—Ç consultant artifact (cards/structured payload)
-- ‚Üí –ø–æ—Å—Ç—Ä–æ–∏—Ç—å response_description (template-based, —Ç–æ—Ç –∂–µ build_response_description)
-- ‚Üí –≤–∫–ª—é—á–∏—Ç—å –≤ INSERT (sync, —á—Ç–æ–±—ã tsvector –±—ã–ª –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω)
INSERT INTO messages (id, conversation_id, role, content, response_description, created_at, ...)
VALUES ($1, $2, $3, $4, $5, $6, ...)
ON CONFLICT (conversation_id, id) DO NOTHING
RETURNING id;

-- –®–∞–≥ 3: Enrichment backfill
-- –ï—Å–ª–∏ INSERT —É—Å–ø–µ—à–µ–Ω (–Ω–µ conflict) ‚Üí –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π async pipeline
-- –ï—Å–ª–∏ conflict (—É–∂–µ –µ—Å—Ç—å) ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ enrichment:
SELECT embedding IS NOT NULL AS has_embedding,
       memory_snippet IS NOT NULL AS has_snippet
FROM messages
WHERE conversation_id = $1 AND id = $2;

-- –ï—Å–ª–∏ embedding NULL (—á–∞—Å—Ç–∏—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —É–ø–∞–≤—à–µ–º primary) ‚Üí –¥–æ–∑–∞–ø—É—Å—Ç–∏—Ç—å
```

**Edge-case: —Å–±–æ–π –î–û –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞.**
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–Ω–∞–µ—Ç: –µ—Å—Ç—å user message –±–µ–∑ –ø–∞—Ä–Ω–æ–≥–æ assistant message. –ü–æ—Å–ª–µ reconnect ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å user message –∫–∞–∫ **–æ–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å** (–Ω–µ replay). LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç. –Æ–∑–µ—Ä –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–∏–¥–µ–ª –æ—Ç–≤–µ—Ç–∞ ‚Üí —Ä–∞–∑–Ω–∏—Ü—ã –Ω–µ—Ç, –ø–∞—É–∑–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞.

**Edge-case: —é–∑–µ—Ä –∑–∞–∫—Ä—ã–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ ack.**
–ë—É—Ñ–µ—Ä —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ persistent storage –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (SQLite –Ω–∞ iOS/Android, IndexedDB –Ω–∞ web). –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å unconfirmed –ø–∞—Ä—ã –∏ replay. –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ—Ç–µ—Ä–∏: <0.1% —Å–µ—Å—Å–∏–π.

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ë—É—Ñ–µ—Ä: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø–∞—Ä + confirmed –ø–∞—Ä—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –µ—â—ë 60 —Å–µ–∫ (–¥–ª—è safety net)
- Rate-limit retry: 1 –ø–∞—Ä–∞/—Å–µ–∫/—é–∑–µ—Ä, max 3 –ø–æ–ø—ã—Ç–∫–∏ ‚Üí –ø–æ—Ç–æ–º voice-friendly: ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞¬ª
- Ordered replay: —Å—Ç—Ä–æ–≥–æ –ø–æ timestamp, –∏–Ω–∞—á–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏ —Å–ª–æ–º–∞—é—Ç—Å—è
- –ú–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç –≤ –æ—Ç–≤–µ—Ç–∞—Ö (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, audio) ‚Üí —Ö—Ä–∞–Ω–∏—Ç—å URL –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã, –Ω–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏

---

## 10. Embedding Service: –≥–¥–µ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å

### MVP: –í —Å–æ—Å—Ç–∞–≤–µ LLM Orchestrator

```
LLM Orchestrator (10.1.0.17)
‚îú‚îÄ‚îÄ –°—É—â–µ—Å—Ç–≤—É—é—â–µ–µ:
‚îÇ   ‚îú‚îÄ‚îÄ DeepSeek/Gemini/Claude/Qwen clients
‚îÇ   ‚îú‚îÄ‚îÄ Intelistyle client
‚îÇ   ‚îú‚îÄ‚îÄ Mood Agent client
‚îÇ   ‚îú‚îÄ‚îÄ Context Agent client
‚îÇ   ‚îî‚îÄ‚îÄ Voice Server client
‚îÇ
‚îî‚îÄ‚îÄ NEW:
    ‚îî‚îÄ‚îÄ Embedding client (Cohere / –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ eval)
        ‚îú‚îÄ‚îÄ embed_query(text) ‚Üí vector    (sync, –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ)
        ‚îî‚îÄ‚îÄ embed_message(text) ‚Üí vector  (async, –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏)
```

### –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏: –æ—Ç–¥–µ–ª—å–Ω—ã–π Embedding Service

```
Embedding Service (10.1.0.20, CPX11)
‚îú‚îÄ‚îÄ –õ–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å (multilingual-e5-small, ~500MB)
‚îú‚îÄ‚îÄ HTTP API: POST /embed ‚Üí vector
‚îú‚îÄ‚îÄ Batch API: POST /embed-batch ‚Üí vectors[]
‚îî‚îÄ‚îÄ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: LLM Orchestrator, Knowledge Pipeline
```

---

## 11. Query Expansion (–ø–æ—Å–ª–µ MVP)

### –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä—è–º–æ–π embedding "—Ö–æ—á—É –≤ –∫–∏–Ω–æ" –Ω–∞–π–¥—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ –∫–∏–Ω–æ, –Ω–æ –Ω–µ –Ω–∞–π–¥—ë—Ç "–î–∏–º–∞ –ø—Ä–µ–¥–ª–æ–∂–∏–ª —Å—Ö–æ–¥–∏—Ç—å –∫—É–¥–∞-–Ω–∏–±—É–¥—å". Hybrid search (FTS) —Ç–æ–∂–µ –Ω–µ –ø–æ–º–æ–∂–µ—Ç ‚Äî –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ –Ω–µ—Ç.

### –†–µ—à–µ–Ω–∏–µ (–ø–æ—Å–ª–µ MVP)

–ë—ã—Å—Ç—Ä–∞—è LLM —Ä–∞—Å—à–∏—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å –¥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö —Ç–µ–º:

```
Input: "—Ö–æ—á—É –ø–æ–π—Ç–∏ –≤ –∫–∏–Ω–æ —Å–µ–≥–æ–¥–Ω—è"

LLM Expansion:
‚Üí "–∫–∏–Ω–æ, —Ñ–∏–ª—å–º, —Å–≤–∏–¥–∞–Ω–∏–µ, –≤–µ—á–µ—Ä, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ, 
   —á—Ç–æ –Ω–∞–¥–µ—Ç—å, –æ–±—Ä–∞–∑, —É–∂–∏–Ω –ø–æ—Å–ª–µ, –±—é–¥–∂–µ—Ç"

Embedding —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ ‚Üí vector search
‚Üí –ù–∞—Ö–æ–¥–∏—Ç –±–æ–ª—å—à–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
```

**Trade-off:** +200-500ms. –î–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (—á–µ—Ä–µ–∑ intent classifier).

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–∞ MVP. Embedding + FTS –ø–æ–∫—Ä—ã–≤–∞–µ—Ç 80%+ —Å–ª—É—á–∞–µ–≤.

---

## 12. Privacy –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ

### –ú–æ–¥–µ–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (MVP)

```
Chat History (messages):
  content, memory_snippet,       ‚Üí plaintext –≤ PostgreSQL
  response_description           ‚Üí plaintext (backend-only –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤)
  embedding, tsv                 ‚Üí –æ—Ç–∫—Ä—ã—Ç–æ (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è search)
  –ó–∞—â–∏—Ç–∞: private network + LUKS at-rest + strict PG roles + audit log

User Knowledge:
  –í—Å–µ –ø–æ–ª—è ‚Üí AES-256 app-level encryption
  –ö–ª—é—á–∏ ‚Üí user_keys —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞ —Ç–æ–º –∂–µ —à–∞—Ä–¥–µ
  –ó–∞—â–∏—Ç–∞: AES-256 + private network + LUKS at-rest

Tombstone Registry:
  Production DB (primary) + Object Storage (copy)
  –ó–∞—â–∏—Ç–∞: Production DB –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ –æ—Ç —à–∞—Ä–¥–æ–≤
```

**–ü–æ—á–µ–º—É content –Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω app-level:**
- FTS (tsvector) —Ç—Ä–µ–±—É–µ—Ç plaintext –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- raw_excerpt (head+tail) –∏ snippet fallback —Ç—Ä–µ–±—É—é—Ç plaintext
- App-level AES —Å–¥–µ–ª–∞–ª –±—ã FTS –∏ tsvector –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã–º–∏

**–ö–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–∏–µ –º–µ—Ä—ã:**
- Private network: Chat History DB –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑–≤–Ω–µ
- LUKS: –¥–∞–Ω–Ω—ã–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–∏—Å–∫–∞
- PG roles: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
- Audit log: –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ messages –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

**Forget –º–µ—Ö–∞–Ω–∏–∫–∞:**
- Soft forget: `is_forgotten = TRUE`, nullify embedding + snippet, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ retrieval. `response_description` –æ–±–Ω—É–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º "–∑–∞–±—É–¥—å —ç—Ç–æ—Ç –æ–±—Ä–∞–∑".
- Hard delete: content ‚Üí '[deleted]', nullify embedding/snippet/response_description/reply_to_id + tombstone –≤ Production DB. tsv –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
- Post-restore: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π `apply_deletions.sql` –∏–∑ Production DB registry

### –î–ª—è –ø—Ä–æ–¥–∞ (–ø–æ—Å–ª–µ MVP)

- –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π audit log —Å –∞–ª–µ—Ä—Ç–∞–º–∏
- Key rotation –¥–ª—è AES-256 (User Knowledge)
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å: FTS –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ–º—É –ø–æ–ª—é `search_terms` (entities/keywords) –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ ‚Äî —É–±–∏—Ä–∞–µ—Ç plaintext content –∏–∑ –ë–î –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ FTS-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

---

## 13. –†–µ–∑—é–º–µ

| –ê—Å–ø–µ–∫—Ç | –†–µ—à–µ–Ω–∏–µ |
|--------|---------|
| **–¢—Ä–∏ —Å–ª–æ—è –∑–Ω–∞–Ω–∏—è** | User Knowledge (—Ñ–∞–∫—Ç—ã) + Semantic Retrieval (—ç–ø–∏–∑–æ–¥—ã) + Context Agent (–º–∏—Ä –≤–æ–∫—Ä—É–≥) |
| **Retrieval** | Hybrid: vector (role='user', is_embeddable) + FTS (–≤—Å–µ —Ä–æ–ª–∏, –≤–∫–ª—é—á–∞—è assistant-–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —á–µ—Ä–µ–∑ response_description). –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —à–∫–∞–ª—ã, —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π temporal decay √ó confidence (recency boost, –Ω–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ), diversity filter (3 per calendar day), emotional filter, memory density cap |
| **Memory classification** | memory_type (emotion/event/general/preference/fact) + memory_confidence (intensifiers ‚Üí 0.9, softeners ‚Üí 0.3) ‚Üí effective_Œª |
| **–ü–∞–º—è—Ç—å –≤ –ø—Ä–æ–º–ø—Ç–µ** | snippet (–Ω–µ–∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–µ–Ω) + raw_excerpt (–∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–µ–Ω, head+tail). 8 –ø—Ä–∞–≤–∏–ª –∞—Ä–±–∏—Ç—Ä–∞–∂–∞ + naturalness directive ([KSP](UNDE_Knowledge_Staging_Pipeline.md) –§–∏–∫—Å—ã 10, 13). –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π cap: new ‚â§3, active ‚â§5, mature ‚â§7 episodes |
| **Knowledge Extraction** | [KSP](UNDE_Knowledge_Staging_Pipeline.md): instant patterns (regex, <1ms, MVP, ru/en/ar/Arabizi) + batch extraction (LLM, –§–∞–∑–∞ 2) + Validator Gate + Memory Correction Loop. Supersede –ø–æ (type, key). evidence_message_ids + is_disputed |
| **Consultant outputs** | `response_description TEXT` (sync template-based, ~0.1ms) ‚Äî backend-only –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –¥–ª—è FTS/–ø–∞–º—è—Ç–∏. `reply_to_id UUID` (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –¥–ª—è voice-first: –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –∑–∞ 10 –º–∏–Ω). –î–≤–∞ –ø—É—Ç–∏ –¥–æ—Å—Ç—É–ø–∞: PK lookup –ø—Ä–∏ —Ä–µ–∞–∫—Ü–∏–∏ + FTS –¥–ª—è –±—É–¥—É—â–µ–≥–æ retrieval. –£—Ä–æ–≤–µ–Ω—å 2 ‚Üí –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ consultant_artifacts —Å –¥–æ–º–µ–Ω–Ω—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ |
| **Context Agent** | CPX11 —Å–µ—Ä–≤–µ—Ä: –ø–æ–≥–æ–¥–∞, –≤—Ä–µ–º—è, –∫—É–ª—å—Ç—É—Ä–∞ (—Å sensitivity levels), —Å–æ–±—ã—Ç–∏—è, opportunities |
| **–•—Ä–∞–Ω–µ–Ω–∏–µ** | pgvector + tsvector ('simple'), 64 hash-–ø–∞—Ä—Ç–∏—Ü–∏–∏, bare metal Dubai (256 GB RAM, tmpfs, dedicated ‚Üí colocation) + Hetzner replica (AX102), —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ HNSW > 80 GB |
| **Embedding** | Dim —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ eval –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (migration plan: re-embed + ALTER TYPE), < $25/–≥–æ–¥ –Ω–∞ 1000 —é–∑–µ—Ä–æ–≤ |
| **Privacy** | Chat History ‚Üí plaintext (content, memory_snippet, response_description) + private network + LUKS. User Knowledge ‚Üí AES-256 app-level. Soft forget: nullify embedding+snippet (undo = re-embed); response_description –æ–±–Ω—É–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º "–∑–∞–±—É–¥—å —ç—Ç–æ—Ç –æ–±—Ä–∞–∑". Hard forget: GDPR erase + tombstone –≤ Production DB. Message ref = (conversation_id, id) –≤—Å—é–¥—É |
| **UX** | –ü–∞–º—è—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ (–±–µ–∑ –¥–∞—Ç/–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤), –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π cap (new ‚â§30%, active ‚â§35%, mature ‚â§40%), past_relationship = suppress by default, –∫–Ω–æ–ø–∫–∞ "–∑–∞–±—É–¥—å" (soft/hard), cultural sensitivity |
| **Persona Agent** | POST /persona (~15ms, –§–∞–∑–∞ 2 ‚Äñ embedding). persona_directive ‚Üí system prompt (–ø–æ—Ä—è–¥–æ–∫: identity ‚Üí tone ‚Üí relationship ‚Üí KSP rules ‚Üí situational ‚Üí hard_bans), voice_params ‚Üí Voice Server, avatar_state + render_hints ‚Üí App. Async feedback loop: signals ‚Üí buffer per exchange_id ‚Üí conflict graph ‚Üí conservative wins ‚Üí momentum caps. –ü–æ–¥—Ä–æ–±–Ω–æ: UNDE_Persona_Voice_Layer v0.7.0 |
| **Latency** | +67ms –∫ –∑–∞–ø—Ä–æ—Å—É (embedding 50ms ‚Äñ persona 15ms + hybrid search 10ms + NEEDS_SPAN 2ms + filters 5ms) |
| **Failover resilience** | Client-side –±—É—Ñ–µ—Ä –ø–∞—Ä (user + assistant) –≤ persistent storage (SQLite/IndexedDB). Verify-and-replay –ø—Ä–∏ reconnect: –ø—Ä–æ–≤–µ—Ä–∫–∞ confirmed –ø–∞—Ä (safety net) + idempotent INSERT + enrichment backfill. Ack –ø–æ—Å–ª–µ SYNC INSERT —Å synchronous_commit=local (WAL –Ω–∞ NVMe), async enrichment —Å sync_commit=off. Rate-limit: 1 –ø–∞—Ä–∞/—Å–µ–∫, max 3 –ø–æ–ø—ã—Ç–∫–∏. Confirmed –ø–∞—Ä—ã –≤ –±—É—Ñ–µ—Ä–µ –µ—â—ë 60 —Å–µ–∫. **RPO: 0 –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–∞—Ä user+assistant** (–≤ —Ä–∞–º–∫–∞—Ö –±—É—Ñ–µ—Ä–∞ –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏). Side-effects (embedding, snippet) –º–æ–≥—É—Ç –æ—Ç—Å—Ç–∞–≤–∞—Ç—å ‚Äî backfill –¥–æ–≥–æ–Ω—è–µ—Ç. –ú–µ–¥–∏–∞-URL ‚Üí —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã. Failover auto (Patroni), failback manual. etcd 3 —É–∑–ª–∞ (1 Dubai + 2 Hetzner) –¥–ª—è –∫–≤–æ—Ä—É–º–∞. |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** | User-based sharding, partition pruning, Object Storage backups, routing table |
