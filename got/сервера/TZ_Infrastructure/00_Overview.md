# UNDE Infrastructure â€” Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğµ Ğ¢Ğ— v7.2

## ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹

- **1 ÑĞµÑ€Ğ²ĞµÑ€ = 1 Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°** â€” Ğ¸Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ Ğ¸ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
- **Staging â†’ Production** â€” ÑÑ‹Ñ€Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğµ Ğ¿Ğ¾Ğ¿Ğ°Ğ´Ğ°ÑÑ‚ Ğ² prod Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
- **Ğ¤Ğ¾Ñ‚Ğ¾ Ñƒ Ğ½Ğ°Ñ** â€” Ğ½Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼ Ğ¾Ñ‚ CDN Ğ±Ñ€ĞµĞ½Ğ´Ğ¾Ğ², Zara Ğ½Ğ°Ñ Ğ½Ğµ Ğ²Ğ¸Ğ´Ğ¸Ñ‚
- **Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ñ‹ Ğ´Ğ»Ñ hot path** â€” Ğ²ÑÑ‘, Ñ‡Ñ‚Ğ¾ Ğ½Ğ° critical path Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° (ÑĞ·ĞµÑ€ Ğ¶Ğ´Ñ‘Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°), Ğ¶Ğ¸Ğ²Ñ‘Ñ‚ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ Ñ€ÑĞ´Ğ¾Ğ¼ Ñ ÑĞ·ĞµÑ€Ğ°Ğ¼Ğ¸. Helsinki â€” batch/core
- **ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²:** Ğ¼Ğ°ĞºÑ. 16 vCPU / 32 GB RAM Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
- **NVMe SSD + OS page cache** â€” Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğ° NVMe, hot working set Ğ² page cache (effective_cache_size 24 GB). ĞšĞ¾Ğ¼Ğ¿ĞµĞ½ÑĞ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Ñ€Ğ°Ğ½Ğ½ĞµĞµ ÑˆĞ°Ñ€Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (500â€“800 ÑĞ·ĞµÑ€Ğ¾Ğ²/ÑˆĞ°Ñ€Ğ´)
- **Chat History + User Knowledge = Ğ¾Ğ´Ğ¸Ğ½ ÑˆĞ°Ñ€Ğ´** â€” Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ·ĞµÑ€Ğ° Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ¼ ÑĞµÑ€Ğ²ĞµÑ€Ğµ, Ğ¾Ğ´Ğ¸Ğ½ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ ContextPack
- **Ğ¢Ñ€Ğ¸ ÑĞ»Ğ¾Ñ Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ + Epistemic Contract** â€” User Knowledge (Ñ„Ğ°ĞºÑ‚Ñ‹, ĞºĞµÑˆ Ñ evidence pointers) + Semantic Retrieval (ÑĞ¿Ğ¸Ğ·Ğ¾Ğ´Ñ‹ Ğ¸Ğ· Ñ‡Ğ°Ñ‚Ğ°, pgvector, raw_excerpt head+tail) + Context Agent (Ğ¼Ğ¸Ñ€ Ğ²Ğ¾ĞºÑ€ÑƒĞ³ ÑĞ·ĞµÑ€Ğ°). [Epistemic Contract](../UNDE_Knowledge_Staging_Pipeline.md): RAW â€” ĞµĞ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹; User Knowledge â€” ĞºĞµÑˆ, Ğ½Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ; Ğ»ÑĞ±Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ ÑĞ¾Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ¶Ğ´Ğ°ĞµÑ‚ÑÑ raw excerpt + message_ids. [Knowledge Staging Pipeline](../UNDE_Knowledge_Staging_Pipeline.md) â€” Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ pipeline Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹
- **Application-level sharding** â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ hash(user_id) % N Ğ² Redis. ĞĞ¸ĞºĞ°ĞºĞ¾Ğ¹ Ğ¼Ğ°Ğ³Ğ¸Ğ¸ distributed SQL
- **Ğ¨Ğ°Ñ€Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ** â€” 32 GB RAM/ÑˆĞ°Ñ€Ğ´ â†’ Ñ€Ğ°Ğ½Ğ½ĞµĞµ Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
- **Client-side verify-and-replay** â€” Ğ½ÑƒĞ»ĞµĞ²Ğ°Ñ Ğ¿Ğ¾Ñ‚ĞµÑ€Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸ failover. ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ Ğ±ÑƒÑ„ĞµÑ€ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… Ğ¿Ğ°Ñ€ Ğ¸ Ğ¿ĞµÑ€ĞµĞ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¸ reconnect
- **Failover auto, failback manual** â€” Patroni Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ğ½Ğ° Hetzner Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ½Ğ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ñ‹ â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ
- **Ğ“Ğ¾Ğ»Ğ¾Ñ Ğ½Ğ° API (ElevenLabs)** â€” Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ½Ğ° ÑĞ²Ğ¾Ğ¹ TTS Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾ÑĞ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ°
- **Ğ¢Ñ€Ğ¸ Ğ°Ğ³ĞµĞ½Ñ‚Ğ° â€” ÑĞµĞ½ÑĞ¾Ñ€Ñ‹ Ğ¸ Ğ°ĞºÑ‚ÑƒĞ°Ñ‚Ğ¾Ñ€** â€” Mood Agent (ĞºĞ°Ğº ÑĞ·ĞµÑ€ ÑĞµĞ±Ñ Ñ‡ÑƒĞ²ÑÑ‚Ğ²ÑƒĞµÑ‚) + Context Agent (Ñ‡Ñ‚Ğ¾ Ğ²Ğ¾ĞºÑ€ÑƒĞ³) = ÑĞµĞ½ÑĞ¾Ñ€Ñ‹ â†’ Persona Agent (ĞºĞ°Ğº Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€ Ğ²ĞµĞ´Ñ‘Ñ‚ ÑĞµĞ±Ñ) = Ğ°ĞºÑ‚ÑƒĞ°Ñ‚Ğ¾Ñ€. persona_directive â†’ LLM, voice_params â†’ ElevenLabs, avatar_state â†’ Rive, render_hints â†’ App

---

## ĞĞ±Ğ·Ğ¾Ñ€ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹

```
                                        INTERNET
                                            â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                   â”‚                   â”‚
                        â–¼                   â–¼                   â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  Apify.com   â”‚    â”‚ Zara Mobile  â”‚    â”‚   fal.ai     â”‚
                â”‚  (scrapers)  â”‚    â”‚     API      â”‚    â”‚  (try-on)    â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                   â”‚                   â–²
                       â”‚ Ğ ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚Ğ½Ñ‹Ğµ       â”‚ 4 req/Ñ‡Ğ°Ñ         â”‚
                       â”‚ Ğ¿Ñ€Ğ¾ĞºÑĞ¸            â”‚ (Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ)         â”‚
                       â–¼                   â–¼                   â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
              â”‚ APIFY SERVER    â”‚ â”‚ SCRAPER SERVER  â”‚          â”‚
              â”‚ (10.1.0.9)      â”‚ â”‚ (10.1.0.3)      â”‚          â”‚
              â”‚ Hetzner Helsinkiâ”‚ â”‚ Hetzner Helsinkiâ”‚          â”‚
              â”‚                 â”‚ â”‚                 â”‚          â”‚
              â”‚ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸:         â”‚ â”‚ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸:         â”‚          â”‚
              â”‚ â€¢ ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ    â”‚ â”‚ â€¢ Mobile API    â”‚          â”‚
              â”‚   ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ°      â”‚ â”‚   (Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ)     â”‚          â”‚
              â”‚                 â”‚ â”‚ â€¢ Sync job      â”‚          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                       â”‚                   â”‚                   â”‚
                       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                       â”‚    â”‚                                  â”‚
                       â–¼    â–¼                                  â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
              â”‚  STAGING DB (10.1.0.8)               â”‚         â”‚
              â”‚  Hetzner Helsinki                    â”‚         â”‚
              â”‚  PostgreSQL 17                       â”‚         â”‚
              â”‚  â”œâ”€â”€ raw_products (Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)       â”‚         â”‚
              â”‚  â”œâ”€â”€ raw_availability (Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ)      â”‚         â”‚
              â”‚  â””â”€â”€ scraper_logs                    â”‚         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                                â”‚                              â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
     â”‚              â”‚           â”‚                    â”‚         â”‚
     â–¼              â–¼           â”‚                    â–¼         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PHOTO       â”‚ â”‚XIMILAR     â”‚  â”‚         â”‚  COLLAGE SERVER (10.1.0.16) â”‚
â”‚DOWNLOADER  â”‚ â”‚SYNC        â”‚  â”‚         â”‚  Hetzner Helsinki           â”‚
â”‚(10.1.0.10) â”‚ â”‚(10.1.0.11) â”‚  â”‚         â”‚                             â”‚
â”‚ â€¢ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ  â”‚ â”‚ â€¢ SKU â†’    â”‚  â”‚         â”‚  Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸:                    â”‚
â”‚   Ñ„Ğ¾Ñ‚Ğ¾     â”‚ â”‚   Ximilar  â”‚  â”‚         â”‚  â€¢ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸Ğ· /originals/   â”‚
â”‚ â€¢ Upload   â”‚ â”‚   Collectionâ”‚  â”‚         â”‚  â€¢ Ğ¡ĞºĞ»ĞµĞ¸Ñ‚ÑŒ Ğ² ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶         â”‚
â”‚   Ğ² OS     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â€¢ Upload Ğ² /collages/      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚
       â–¼                       â”‚ SYNC JOB (hourly)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â–¼
â”‚  OBJECT STORAGE     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  (Hetzner Helsinki) â”‚ â”‚  PRODUCTION DB (10.1.1.2)            â”‚
â”‚                     â”‚ â”‚  Hetzner Helsinki                    â”‚
â”‚  Bucket: unde-imagesâ”‚ â”‚  PostgreSQL 17 + PgBouncer           â”‚
â”‚  â”œâ”€â”€ /originals/    â”‚ â”‚  â””â”€â”€ products                        â”‚
â”‚  â””â”€â”€ /collages/     â”‚ â”‚      â”œâ”€â”€ sku, name, price, brand     â”‚
â”‚                     â”‚ â”‚      â”œâ”€â”€ image_url (â†’ /originals/)   â”‚
â”‚  Bucket: user-media â”‚ â”‚      â”œâ”€â”€ collage_url (â†’ /collages/)  â”‚
â”‚  â””â”€â”€ /{user_id}/    â”‚ â”‚      â””â”€â”€ availability (JSONB)        â”‚
â”‚                     â”‚ â”‚  â””â”€â”€ routing_table (user â†’ shard)    â”‚
â”‚  Bucket:            â”‚
â”‚  unde-shard-backups â”‚ â”‚  â””â”€â”€ deleted_messages_registry       â”‚
â”‚  â””â”€â”€ /shard-N/      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                     â”‚                      â”‚
                     â–¼                     â–¼                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ APP SERVER   â”‚  â”‚ TRY-ON SERVICEâ”‚  â”‚ RECOGNITION       â”‚
              â”‚ (10.1.0.2)   â”‚  â”‚ (10.1.0.6)    â”‚  â”‚ ORCHESTRATOR      â”‚
              â”‚ Hetzner      â”‚  â”‚ â€¢ collageâ†’fal â”‚  â”‚ (10.1.0.14)       â”‚
              â”‚ â””â”€â”€ API      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚          â”‚
                     â”‚                                 â–¼          â–¼
                     â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                     â”‚XIMILAR GW  â”‚ â”‚LLM RERANKERâ”‚
                     â”‚                     â”‚(10.1.0.12) â”‚ â”‚(10.1.0.13) â”‚
                     â”‚                     â”‚â€¢ detect    â”‚ â”‚â€¢ Gemini tagâ”‚
                     â”‚                     â”‚â€¢ tag       â”‚ â”‚â€¢ Gemini    â”‚
                     â”‚                     â”‚â€¢ search    â”‚ â”‚  rerank    â”‚
                     â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€ WireGuard (ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€ â€” Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚ÑƒĞ½Ğ½ĞµĞ»ÑŒ) â”€â”€â”€â”€â”€â”
              â”‚              ~120ms RTT, Ñ‡ĞµÑ€ĞµĞ· helsinki-gw (10.1.0.40)          â”‚
              â”‚                                                                â”‚
              â”‚  â”Œâ”€â”€ Ğ›ĞĞšĞĞ›Ğ¬ĞĞ«Ğ• Ğ¡Ğ•Ğ Ğ’Ğ•Ğ Ğ« (hot path, <5ms Ğ¾Ñ‚ ÑĞ·ĞµÑ€Ğ¾Ğ²) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
              â”‚  â”‚                                                          â”‚  â”‚
              â”‚  â”‚  LLM ORCHESTRATOR (10.2.0.17)                            â”‚  â”‚
              â”‚  â”‚  â€¢ ContextPack (3 ÑĞ»Ğ¾Ñ Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ)                           â”‚  â”‚
              â”‚  â”‚  â€¢ â†’ DeepSeek/Gemini/Claude/Qwen + Voice Server          â”‚  â”‚
              â”‚  â”‚                                                          â”‚  â”‚
              â”‚  â”‚  MOOD (10.2.0.11) | PERSONA (10.2.0.21) | VOICE (10.2.0.12) â”‚
              â”‚  â”‚  CONTEXT (10.2.0.19) | REDIS (10.2.0.4)                 â”‚  â”‚
              â”‚  â”‚                                                          â”‚  â”‚
              â”‚  â”‚  USER DATA SHARDS (local-shard-0..N, 32 GB, NVMe)       â”‚  â”‚
              â”‚  â”‚  â”œâ”€â”€ PostgreSQL 17 + pgvector, Chat History + UK         â”‚  â”‚
              â”‚  â”‚  â”œâ”€â”€ Patroni primary â†’ async WAL â†’ Helsinki replica      â”‚  â”‚
              â”‚  â”‚  â””â”€â”€ 500â€“800 ÑĞ·ĞµÑ€Ğ¾Ğ²/ÑˆĞ°Ñ€Ğ´                                â”‚  â”‚
              â”‚  â”‚                                                          â”‚  â”‚
              â”‚  â”‚  etcd-1 (10.2.0.50) â€” Patroni quorum                    â”‚  â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ğŸ“± ĞŸĞ Ğ˜Ğ›ĞĞ–Ğ•ĞĞ˜Ğ•â”‚
              â”‚ ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³      â”‚
              â”‚ Try-on       â”‚
              â”‚ Recognition  â”‚
              â”‚ Voice + Mood â”‚
              â”‚ Context      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ĞšĞ°Ñ€Ñ‚Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²

> **Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ², ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ, WireGuard, failover â€” ÑĞ¼. [07_Server_Layout_v7.md](07_Server_Layout_v7.md)**

### Ğ›ĞĞšĞĞ›Ğ¬ĞĞ«Ğ• ÑĞµÑ€Ğ²ĞµÑ€Ñ‹ (hot path â€” dialogue critical path)

> ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ: Ğ¼Ğ°ĞºÑ. 16 vCPU / 32 GB RAM Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€. ĞŸÑ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ Ğ¿Ğ¾ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸ ÑĞ·ĞµÑ€Ğ¾Ğ².

| # | Ğ¡ĞµÑ€Ğ²ĞµÑ€ | ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ | Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ |
|---|--------|--------|--------|--------|
| L1 | **local-app** | 4 vCPU / 8 GB | API gateway (Nginx + FastAPI). Ğ•Ğ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ´Ğ»Ñ ÑĞ·ĞµÑ€Ğ¾Ğ² | ğŸ†• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ |
| L2 | **local-orchestrator** | 8 vCPU / 16 GB | LLM Orchestrator: ContextPack, embedding, Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ | ğŸ†• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ |
| L3 | **local-redis** | 2 vCPU / 4 GB | Redis: hot cache, rate limit, debounce, shard routing | ğŸ†• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ |
| L4 | **local-mood** | 2 vCPU / 4 GB | Mood Agent: signal + context mood | ğŸ†• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ |
| L5 | **local-persona** | 2 vCPU / 4 GB | Persona Agent: relationship, tone, voice, avatar | ğŸ†• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ |
| L6 | **local-context** | 2 vCPU / 4 GB | Context Agent: Ğ³ĞµĞ¾, Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ°, ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ, ĞºÑƒĞ»ÑŒÑ‚ÑƒÑ€Ğ° | ğŸ†• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ |
| L7 | **local-voice** | 2 vCPU / 4 GB | Voice Server: ElevenLabs proxy, WebSocket streaming | ğŸ†• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ |
| L8 | **local-shard-0** | **16 vCPU / 32 GB** | User Data Shard 0: PostgreSQL 17 + pgvector | ğŸ†• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ |
| L9 | **local-etcd-1** | 1 vCPU / 2 GB | etcd node Ğ´Ğ»Ñ Patroni (Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ³Ğ¾Ğ»Ğ¾Ñ primary) | ğŸ†• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ |

### Hetzner Helsinki â€” ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ñ‹

| # | Ğ¡ĞµÑ€Ğ²ĞµÑ€ | IP (private) | IP (public) | Ğ¢Ğ¸Ğ¿ | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ |
|---|--------|-------------|-------------|-----|--------|
| H1 | unde-app | 10.1.0.2 | â€” | CX43 | ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½, Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿ĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°Ğ½ |
| H2 | scraper | 10.1.0.3 | 46.62.255.184 | CPX22 | âœ… Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ |
| H3 | push | 10.1.0.4 | 77.42.30.44 | CPX32 | âœ… Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ |
| H4 | model-generator | 10.1.0.5 | 89.167.20.60 | CPX22 | âœ… Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ |
| H5 | tryon-service | 10.1.0.6 | 89.167.31.65 | CPX22 | âœ… Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ |
| H6 | Production DB | 10.1.1.2 | â€” | AX41 (dedicated) | âœ… Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ |
| â€” | GitLab | â€” | gitlab-real.unde.life | â€” | âœ… Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ |

**Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ€Ğ¾Ğ»ĞµĞ¹ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²:**

| Ğ¡ĞµÑ€Ğ²ĞµÑ€ | Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ Ñ€Ğ¾Ğ»ÑŒ | ĞĞ¾Ğ²Ğ°Ñ Ñ€Ğ¾Ğ»ÑŒ |
|--------|-------------|-----------|
| **unde-app (H1)** | API gateway (ĞµĞ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°) | ğŸ—‘ **Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½.** Ğ‘ÑƒĞ´ĞµÑ‚ Ğ¿ĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°Ğ½ ĞºĞ°Ğº Helsinki API â€” batch endpoints, webhooks, admin. Ğ®Ğ·ĞµÑ€ÑĞºĞ¸Ğ¹ Ñ‚Ñ€Ğ°Ñ„Ğ¸Ğº â†’ local-app |
| **push (H3)** | Redis + Celery broker | **Batch Redis + Celery broker** â€” Ğ´Ğ»Ñ recognition queue, catalog pipeline, enrichment TTL recovery. Hot path Redis â†’ local-redis |

### Hetzner Helsinki â€” Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ñ‹

| # | Ğ¡ĞµÑ€Ğ²ĞµÑ€ | IP (private) | Ğ¢Ğ¸Ğ¿ | â‚¬/Ğ¼ĞµÑ | Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ |
|---|--------|-------------|-----|-------|--------|--------|
| H7 | **apify** | 10.1.0.9 | CX23 | â‚¬12 | Ğ¡Ğ±Ğ¾Ñ€ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° (Apify.com) | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |
| H8 | **collage** | 10.1.0.16 | CX33 | â‚¬25 | Ğ¡ĞºĞ»ĞµĞ¹ĞºĞ° Ñ„Ğ¾Ñ‚Ğ¾ | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |
| H9 | **recognition** | 10.1.0.14 | CX23 | â‚¬6 | Recognition Orchestrator | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |
| H10 | **photo-downloader** | 10.1.0.10 | CX23 | â‚¬12 | Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ±Ñ€ĞµĞ½Ğ´Ğ¾Ğ² â†’ Object Storage | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |
| H11 | **ximilar-sync** | 10.1.0.11 | CX23 | â‚¬6 | Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° â†’ Ximilar Collection | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |
| H12 | **ximilar-gw** | 10.1.0.12 | CX23 | â‚¬12 | Ximilar Gateway (/detect, /tag, /search) | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |
| H13 | **llm-reranker** | 10.1.0.13 | CX23 | â‚¬6 | LLM Reranker (Gemini visual comparison) | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |
| H14 | **staging-db** | 10.1.0.8 | CPX22 | â‚¬12 | PostgreSQL staging | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |
| H15 | **shard-replica-0** | 10.1.1.10 | Dedicated (Xeon, 64 GB, NVMe) | ~â‚¬39 | Hot standby replica ÑˆĞ°Ñ€Ğ´Ğ° 0 (Patroni) | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |
| H16 | **etcd-2** | Ğ½Ğ° shard-replica-0 | ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ | â‚¬0 | etcd quorum node 2 | ğŸ†• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ |
| H17 | **etcd-3** | 10.1.0.15 | CX23 | â‚¬4 | etcd quorum node 3 (tiebreaker) | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |
| H18 | **posthog** | 10.1.1.30 | Dedicated (Xeon, 64 GB, SATA) | ~â‚¬39 | PostHog self-hosted: product analytics | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |
| H19 | **monitoring** | 10.1.0.7 | CX33 | â‚¬25 | Prometheus + Grafana + Alertmanager | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |
| H20 | **helsinki-gw** | 10.1.0.40 | CPX22 (2 vCPU / 4 GB) | â‚¬12 | Firewall/Router: Debian 12 + MikroTik CHR. WireGuard endpoint | ğŸ†• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ |
| â€” | **Object Storage** | hel1.your-objectstorage.com | S3-compatible | ~â‚¬10 | unde-images âœ…, unde-user-media âœ…, unde-shard-backups âœ… | âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ |

---

## ĞĞ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ğ¼

| Ğ¤Ğ°Ğ¹Ğ» | Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ |
|------|-----------|
| **â†’ Ğ’Ñ‹ Ğ·Ğ´ĞµÑÑŒ** | ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹, Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°, ĞºĞ°Ñ€Ñ‚Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² |
| [01_Catalog_Pipeline.md](01_Catalog_Pipeline.md) | Scraper, Apify, Photo Downloader, Ximilar Sync, Collage, Staging DB, Object Storage |
| [02_Recognition_Pipeline.md](02_Recognition_Pipeline.md) | Recognition Orchestrator, Ximilar Gateway, LLM Reranker |
| [03_Dialogue_Pipeline.md](03_Dialogue_Pipeline.md) | Mood Agent, Voice Server, LLM Orchestrator, Context Agent, Persona Agent |
| [04_Local_User_Data_Shards.md](04_Local_User_Data_Shards.md) | Local Shards: ÑÑ…ĞµĞ¼Ğ° Ğ‘Ğ”, Ñ€ĞµĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ, ÑˆĞ°Ñ€Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ±ÑĞºĞ°Ğ¿Ñ‹ |
| [05_Data_Flow.md](05_Data_Flow.md) | Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ² Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (7 ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸ĞµĞ²) |
| [06_Operations.md](06_Operations.md) | Ğ Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ, Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³, Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹, Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ |
| [07_Server_Layout_v7.md](07_Server_Layout_v7.md) | ĞšĞ°Ñ€Ñ‚Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² v7.2, ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ, WireGuard, failover, PostHog, Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ |
| [UNDE_Knowledge_Staging_Pipeline.md](../UNDE_Knowledge_Staging_Pipeline.md) | Epistemic Contract, pipeline Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, instant/batch extraction, supersede, correction loop, privacy guard, enrichment TTL |
