# UNDE Infrastructure â€” Data Flow

*Ğ§Ğ°ÑÑ‚ÑŒ [TZ Infrastructure v7.2](../TZ_Infrastructure_Final.md). Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ² Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….*

---

## 17. DATA FLOW

### 17.1 Ğ¡Ğ±Ğ¾Ñ€ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° (ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾, 3 ÑĞµÑ€Ğ²ĞµÑ€Ğ°)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Apify.com      â”‚
â”‚  Ğ ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚Ğ½Ñ‹Ğµ    â”‚
â”‚  Ğ¿Ñ€Ğ¾ĞºÑĞ¸         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ ~15K Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²/Ğ±Ñ€ĞµĞ½Ğ´ (JSON Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APIFY SERVER (10.1.0.9)                           â”‚
â”‚                                                    â”‚
â”‚  1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ JSON Ğ¾Ñ‚ Apify                         â”‚
â”‚  2. INSERT Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Staging DB                 â”‚
â”‚     (image_status='pending')                       â”‚
â”‚  ĞĞ• ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ñ„Ğ¾Ñ‚Ğ¾, ĞĞ• ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ximilar     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Staging DB  â”‚  image_status = 'pending'
         â”‚  raw_productsâ”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                       â–¼ (Ğ¿Ğ¾ÑĞ»Ğµ uploaded/collage_ready)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHOTO DOWNLOADER  â”‚  â”‚  XIMILAR SYNC      â”‚
â”‚  (10.1.0.10)       â”‚  â”‚  (10.1.0.11)       â”‚
â”‚                    â”‚  â”‚                    â”‚
â”‚  1. SELECT pending â”‚  â”‚  1. SELECT pending â”‚
â”‚  2. Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾   â”‚  â”‚  2. POST â†’ Ximilar â”‚
â”‚  3. Upload Ğ² OS    â”‚  â”‚     Collection     â”‚
â”‚  4. UPDATE â†’       â”‚  â”‚  3. UPDATE â†’       â”‚
â”‚     'uploaded'     â”‚  â”‚     'synced'       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Object       â”‚
â”‚ Storage      â”‚
â”‚ /originals/  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 17.2 ĞĞ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°Ñ… (ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ, Scraper Server)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mobile API     â”‚
â”‚  Zara, etc.     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 4 Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ° Ã— ~15K Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SCRAPER SERVER (10.1.0.3)                         â”‚
â”‚                                                    â”‚
â”‚  1. GET /itxrest/.../physicalstore/{id}/product     â”‚
â”‚  2. INSERT INTO raw_availability                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Staging DB  â”‚
         â”‚  raw_availab.â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 17.3 Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶ĞµĞ¹ (ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 15 Ğ¼Ğ¸Ğ½, Collage Server)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Staging DB  â”‚  SELECT WHERE image_status = 'uploaded'
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COLLAGE SERVER (10.1.0.16)                        â”‚
â”‚                                                    â”‚
â”‚  1. Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»Ñ‹ Ğ¸Ğ· /originals/               â”‚
â”‚  2. Ğ¡ĞºĞ»ĞµĞ¸Ñ‚ÑŒ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ñ„Ğ°Ğ¹Ğ» (Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾)            â”‚
â”‚  3. Upload Ğ² /collages/                            â”‚
â”‚  4. UPDATE image_status = 'collage_ready'          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Staging DB  â”‚      â”‚  Object Storage  â”‚
â”‚  collage_url â”‚      â”‚  /collages/      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 17.4 Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² Production (ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ, Scraper Server)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Staging DB  â”‚     â”‚  Staging DB  â”‚
â”‚  raw_productsâ”‚     â”‚  raw_availab.â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SCRAPER SERVER (10.1.0.3) â€” Sync Job              â”‚
â”‚                                                    â”‚
â”‚  SELECT p.*, a.sizes_in_stock                      â”‚
â”‚  FROM raw_products p                               â”‚
â”‚  JOIN raw_availability a                           â”‚
â”‚    ON p.external_id = a.product_id                 â”‚
â”‚  WHERE p.image_status = 'collage_ready'            â”‚
â”‚    AND p.sync_status = 'pending'                   â”‚
â”‚    AND a.fetched_at > NOW() - INTERVAL '2 hours'   â”‚
â”‚                                                    â”‚
â”‚  â†’ Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ñ ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶Ğ¾Ğ¼ Ğ˜ Ğ² Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸ Ğ² KZ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Production DB    â”‚
         â”‚  (10.1.1.2)       â”‚
         â”‚  UPSERT products  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 17.5 ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ + try-on

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“± ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ GET /api/products
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     JSON: image_url, collage_url
â”‚  App Server  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  (10.1.0.2)  â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
       â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“± ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³   â”‚â†’ Object Storage      â”‚ Try-on Service   â”‚
â”‚ ğŸ“± Try-on    â”‚â†’ fal.ai â†’ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚  â”‚ (10.1.0.6)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 17.6 ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: Fashion Recognition

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“± ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµâ”‚  Ğ¤Ğ¾Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ€ÑƒĞµÑ‚ outfit Ğ½Ğ° ÑƒĞ»Ğ¸Ñ†Ğµ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /api/v1/recognize (Ñ„Ğ¾Ñ‚Ğ¾)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  App Server  â”‚  Celery task â†’ Redis
â”‚  (10.1.0.2)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RECOGNITION ORCHESTRATOR (10.1.0.14)              â”‚
â”‚                                                    â”‚
â”‚  Step 1: â†’ Ximilar GW /detect â†’ crops + ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ â”‚
â”‚     (200-500ms) â†’ ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ chips Ğ½Ğ° Ñ„Ğ¾Ñ‚Ğ¾     â”‚
â”‚      â–¼                                             â”‚
â”‚  Step 2: â†’ Ximilar GW /tag + LLM Reranker /tag    â”‚
â”‚           (Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾, ~1s)     â†’ Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ñ‹        â”‚
â”‚      â–¼                                             â”‚
â”‚  Step 3: â†’ Ximilar GW /search â†’ TOP-10 ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ğ² â”‚
â”‚     (200-500ms)                                    â”‚
â”‚      â–¼                                             â”‚
â”‚  Step 4: â†’ LLM Reranker /rerank                    â”‚
â”‚     (1-2s, batch Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾)                      â”‚
â”‚     > 0.85  â†’ "ĞĞ°ÑˆĞ»Ğ¸! Ğ­Ñ‚Ğ¾ [SKU] Ğ² [Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½]"      â”‚
â”‚     0.5-0.85 â†’ "ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğ¸Ğµ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹" TOP-3-5         â”‚
â”‚     < 0.5   â†’ Attribute fallback (SQL Ğ¿Ğ¾ Ñ‚ĞµĞ³Ğ°Ğ¼)    â”‚
â”‚                                                    â”‚
â”‚  Ğ¡ÑƒĞ¼Ğ¼Ğ°Ñ€Ğ½Ğ¾: 2-4 ÑĞµĞº                                 â”‚
â”‚  Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ â†’ Redis â†’ App Server â†’ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ       â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
   â”‚                    â”‚                       â”‚
   â–¼                    â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ XIMILAR GW   â”‚ â”‚ LLM RERANKER â”‚ â”‚  Production DB    â”‚
â”‚ (10.1.0.12)  â”‚ â”‚ (10.1.0.13)  â”‚ â”‚  (10.1.1.2)       â”‚
â”‚ â†’ Ximilar APIâ”‚ â”‚ â†’ Gemini 2.5 â”‚ â”‚ recognition_      â”‚
â”‚              â”‚ â”‚   Flash      â”‚ â”‚ requests (Ğ»Ğ¾Ğ³)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 17.7 ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ñ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ¾Ğ¼ (Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ â€” 3 ÑĞ»Ğ¾Ñ Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ + Persona Agent)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“± ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµâ”‚  Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¸ÑˆĞµÑ‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /api/v1/chat (Ñ‚ĞµĞºÑÑ‚/ASR + GPS + reply_to?)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  App Server  â”‚  Ğ¢Ñ€Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°:
â”‚  (10.2.0.2)  â”‚  1. mood_analyze â†’ Mood Agent
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  2. context_request â†’ Context Agent
       â”‚          3. generate_response â†’ LLM Orchestrator
       â”‚
  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                       â”‚                     â”‚
  â–¼                       â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MOOD AGENT    â”‚ â”‚ CONTEXT AGENT  â”‚ â”‚ LLM ORCHESTRATOR (10.2.0.17)         â”‚
â”‚ (10.2.0.11)   â”‚ â”‚ (10.2.0.19)    â”‚ â”‚                                      â”‚
â”‚               â”‚ â”‚                â”‚ â”‚ ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚ mood_frame + context_frame,  â”‚
â”‚ â†’ mood_frame  â”‚ â”‚ â†’ context_frameâ”‚ â”‚ Ğ·Ğ°Ñ‚ĞµĞ¼:                               â”‚
â”‚ (~100ms)      â”‚ â”‚ (~100ms)       â”‚ â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ Ğ¤Ğ°Ğ·Ğ° 2 (ĞŸĞĞ ĞĞ›Ğ›Ğ•Ğ›Ğ¬ĞĞ):               â”‚
       â”‚                 â”‚           â”‚ 1a. Embed Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ â†’ vector    (~50ms) â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”˜           â”‚ 1b. POST /persona            (~15ms)â”‚
                â”‚  â”‚                 â”‚     (10.2.0.21)                      â”‚
                â–¼  â–¼                 â”‚     â†’ persona_directive              â”‚
         mood_frame +                â”‚     â†’ voice_params                   â”‚
         context_frame â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚     â†’ avatar_state + render_hints   â”‚
                                     â”‚                                      â”‚
                                     â”‚ Ğ¤Ğ°Ğ·Ğ° 3 (Ğ¿Ğ¾ÑĞ»Ğµ embed):              â”‚
                                     â”‚ 2. ĞŸĞĞ ĞĞ›Ğ›Ğ•Ğ›Ğ¬ĞĞ:                      â”‚
                                     â”‚    a) Hybrid Search (vector+FTS)     â”‚
                                     â”‚       + temporal decay + confidence  â”‚
                                     â”‚       â†’ TOP-15 (snippet + raw_excerptâ”‚
                                     â”‚         + message_id)               â”‚
                                     â”‚    b) User Knowledge (AES-256)      â”‚
                                     â”‚    c) ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 10 ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹        â”‚
                                     â”‚    d) Artifact lookup (reply_to_id) â”‚
                                     â”‚                                      â”‚
                                     â”‚ 3. Span enrichment (KSP Ğ¤Ğ¸ĞºÑ 5)     â”‚
                                     â”‚    NEEDS_SPAN (<50 chars / ÑƒĞºĞ°Ğ·Ğ°Ñ‚.) â”‚
                                     â”‚    â†’ Ğ¿Ğ¾Ğ´Ñ‚ÑĞ½ÑƒÑ‚ÑŒ Â±1 ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ         â”‚
                                     â”‚ 4. Privacy Guard (KSP Ğ¤Ğ¸ĞºÑ 12)      â”‚
                                     â”‚    cosine filter Ğ½Ğ° span-ÑĞ¾ÑĞµĞ´ĞµĞ¹    â”‚
                                     â”‚    (threshold: 0.3 ru/en, 0.25 ar) â”‚
                                     â”‚ 5. Emotional filter (mood_frame)     â”‚
                                     â”‚    Ğ¼ÑĞ³ĞºĞ¸Ğ¹: score Ã—0.8, Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ â”‚
                                     â”‚ 6. Memory Density Cap (Ğ°Ğ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹)  â”‚
                                     â”‚ 7. Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° ContextPack (6 ÑĞ»Ğ¾Ñ‘Ğ²)     â”‚
                                     â”‚    (+ persona_directive)             â”‚
                                     â”‚ 8. â†’ LLM API                        â”‚
                                     â”‚ SYNC Ğ¿Ñ€Ğ¸ INSERT:                     â”‚
                                     â”‚ 9. Instant Pattern Extract (Ğ¤Ğ¸ĞºÑ 1A)â”‚
                                     â”‚ 10. Correction Detect (Ğ¤Ğ¸ĞºÑ 11)     â”‚
                                     â”‚ 11. response_description             â”‚
                                     â”‚ 12. voice_params â†’ Voice Server      â”‚
                                     â”‚ 13. avatar+hints â†’ App               â”‚
                                     â”‚ ASYNC: signals â†’ /persona/feedback  â”‚
                                     â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                        â”‚        â”‚          â”‚        â”‚
                                        â–¼        â–¼          â–¼        â–¼
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚Local Shard â”‚ â”‚ Voice  â”‚ â”‚ğŸ“± Appâ”‚ â”‚Persona â”‚
                             â”‚(NVMe SSD)  â”‚ â”‚ Server â”‚ â”‚Ñ‚ĞµĞºÑÑ‚+â”‚ â”‚Agent   â”‚
                             â”‚Chat Historyâ”‚ â”‚10.2.0.12â”‚ â”‚Ğ°ÑƒĞ´Ğ¸Ğ¾+â”‚ â”‚feedbackâ”‚
                             â”‚+ UK + Stageâ”‚ â”‚voiceâ†’ğŸ“±â”‚ â”‚avatarâ”‚ â”‚+ flush â”‚
                             â”‚enrichment  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ĞĞ±Ñ‰Ğ°Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ°Ñ latency Ğ¾Ñ‚ Semantic Retrieval + Persona: ~65ms
(embedding 50ms â€– persona 15ms + hybrid search 10ms + filters 5ms)
(mood_frame Ğ¸ context_frame ~100ms, Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ñ embedding+persona)
```

### 17.8 Enrichment TTL Recovery (cron, ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 6 Ñ‡Ğ°ÑĞ¾Ğ²)

> Ğ˜Ğ· UNDE_Knowledge_Staging_Pipeline.md, Ğ¤Ğ¸ĞºÑ 14.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CRON JOB: Enrichment TTL Recovery                   â”‚
â”‚  (LLM Orchestrator Ğ¸Ğ»Ğ¸ dedicated worker)             â”‚
â”‚  Ğ§Ğ°ÑÑ‚Ğ¾Ñ‚Ğ°: ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 6 Ñ‡Ğ°ÑĞ¾Ğ²                             â”‚
â”‚                                                      â”‚
â”‚  1. SELECT messages WHERE embedding IS NULL           â”‚
â”‚     AND is_embeddable = TRUE AND is_forgotten = FALSEâ”‚
â”‚     AND created_at < NOW() - INTERVAL '1 hour'       â”‚
â”‚     AND created_at > NOW() - INTERVAL '7 days'       â”‚
â”‚     AND enrichment_retry_count < 3                   â”‚
â”‚     ORDER BY created_at DESC LIMIT 500               â”‚
â”‚                                                      â”‚
â”‚  2. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² enrichment queue                     â”‚
â”‚     priority = 'recovery'                            â”‚
â”‚                                                      â”‚
â”‚  3. enrichment_retry_count += 1                      â”‚
â”‚     ĞŸÑ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞµ: last_retry_at = NOW()        â”‚
â”‚                                                      â”‚
â”‚  4. ĞŸĞ¾ÑĞ»Ğµ 3 Ğ½ĞµÑƒĞ´Ğ°Ñ‡ â†’ orphan alert                    â”‚
â”‚     (unde_orphan_messages_total)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Local Shard   â”‚  UPDATE embedding = ...
         â”‚ (NVMe SSD)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 17.9 Memory Correction Loop (sync Ğ¿Ñ€Ğ¸ INSERT user-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ)

> Ğ˜Ğ· UNDE_Knowledge_Staging_Pipeline.md, Ğ¤Ğ¸ĞºÑ 11.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“± Ğ®Ğ·ĞµÑ€:     â”‚  "ĞĞµÑ‚, Ğ¼Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ½Ğµ M, Ğ° S"
â”‚ "Ñ Ñ‡ĞµĞ³Ğ¾ Ñ‚Ñ‹   â”‚  Ğ¸Ğ»Ğ¸ "Ñ‚Ñ‹ Ğ¿ÑƒÑ‚Ğ°ĞµÑˆÑŒ"
â”‚  Ğ²Ğ·ÑĞ»?"      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM ORCHESTRATOR (10.2.0.17) â€” Ğ¿Ñ€Ğ¸ INSERT          â”‚
â”‚                                                      â”‚
â”‚  1. CORRECTION_PATTERNS regex (ru/en/ar/Arabizi)     â”‚
â”‚     Ğ¡Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ?                                    â”‚
â”‚     â”‚                                                â”‚
â”‚     â”œâ”€â”€ Denial Ğ¯Ğ’ĞĞ«Ğ™ ("Ğ¼Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ½Ğµ M"):            â”‚
â”‚     â”‚   â†’ user_knowledge: is_active = FALSE          â”‚
â”‚     â”‚                                                â”‚
â”‚     â”œâ”€â”€ Denial ĞĞ•ĞĞ”ĞĞĞ—ĞĞĞ§ĞĞ«Ğ™ ("Ñ Ñ‡ĞµĞ³Ğ¾ Ñ‚Ñ‹ Ğ²Ğ·ÑĞ»?"):    â”‚
â”‚     â”‚   â†’ user_knowledge: is_disputed = TRUE         â”‚
â”‚     â”‚   â†’ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚: "Ğ¼ÑĞ³ĞºĞ¾ ÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¸, Ğ½Ğµ ÑƒÑ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°Ğ¹"       â”‚
â”‚     â”‚                                                â”‚
â”‚     â””â”€â”€ 2. INSERT memory_correction_log              â”‚
â”‚            trigger_message_id, corrected_message_id   â”‚
â”‚            correction_type                            â”‚
â”‚                                                      â”‚
â”‚  3. LLM: Ğ¸Ğ·Ğ²Ğ¸Ğ½Ğ¸Ñ‚ÑŒÑÑ Ğ¸ ÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ´Ñƒ               â”‚
â”‚                                                      â”‚
â”‚  4. [Ğ¤Ğ°Ğ·Ğ° 2] correction events â†’ golden tests        â”‚
â”‚     â†’ batch extraction prompt tuning                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 17.10 Batch Knowledge Extraction (async, Ğ¤Ğ°Ğ·Ğ° 2)

> Ğ˜Ğ· UNDE_Knowledge_Staging_Pipeline.md, Ğ¤Ğ¸ĞºÑ 1B. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ° Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CELERY WORKER: Batch Knowledge Extraction            â”‚
â”‚  Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹:                                           â”‚
â”‚  â€¢ Ğ¡ĞµÑÑĞ¸Ñ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° (gap > 30 Ğ¼Ğ¸Ğ½)                     â”‚
â”‚  â€¢ pending_extraction_count â‰¥ 15                     â”‚
â”‚  â€¢ Cron: Ñ€Ğ°Ğ· Ğ² 2 Ñ‡Ğ°ÑĞ° ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ pending              â”‚
â”‚  ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ: Ğ½Ğµ Ñ‡Ğ°Ñ‰Ğµ 1 Ñ€Ğ°Ğ·/ÑĞ·ĞµÑ€/Ñ‡Ğ°Ñ                â”‚
â”‚  Concurrency: pg_advisory_xact_lock(user_id_hash)   â”‚
â”‚                                                      â”‚
â”‚  1. Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ current_knowledge + new_messages         â”‚
â”‚     (user + assistant Ñ last_extraction_at)          â”‚
â”‚                                                      â”‚
â”‚  2. â†’ DeepSeek: "Ğ²ĞµÑ€Ğ½Ğ¸ Ğ´ĞµĞ»ÑŒÑ‚Ñƒ (ADD/UPDATE/REMOVE)"   â”‚
â”‚     Ğ–ĞĞ¡Ğ¢ĞšĞ˜Ğ• ĞĞ“Ğ ĞĞĞ˜Ğ§Ğ•ĞĞ˜Ğ¯:                            â”‚
â”‚     â€¢ Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ„Ğ°ĞºÑ‚Ñ‹ Ğ¾ ÑĞ°Ğ¼Ğ¾Ğ¼ ÑĞ·ĞµÑ€Ğµ (subject = user)    â”‚
â”‚     â€¢ ĞĞ• Ğ¾Ğ±Ğ¾Ğ±Ñ‰Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ                       â”‚
â”‚     â€¢ Ğ¡Ğ°Ñ€ĞºĞ°Ğ·Ğ¼ = ĞĞ• Ñ„Ğ°ĞºÑ‚                             â”‚
â”‚     â€¢ Gulf slang â‰  Ñ„Ğ°ĞºÑ‚                              â”‚
â”‚                                                      â”‚
â”‚  3. Validator Gate (Ğ´ĞµÑ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹):               â”‚
â”‚     confidence â‰¥ 0.8 + ÑĞºĞ¾Ñ€Ğ½Ğ°Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ             â”‚
â”‚     â†’ APPLY Ğ¸Ğ»Ğ¸ REJECT                               â”‚
â”‚                                                      â”‚
â”‚  4. UPDATE user_knowledge + extraction_log           â”‚
â”‚  5. pending_extraction_count = 0                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---
